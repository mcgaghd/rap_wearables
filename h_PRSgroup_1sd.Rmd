---
title: "Modeling_1sd"
author: "Dylan McGagh"
date: "`r format(Sys.time(), '%a %b %d, %Y %X')`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 5
    theme: lumen
---
```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction

This script runs models for 1 SD increase in exposure.

# Set up workspace
```{r}
dir.create("PRSbyGroup")
```

## Set-up useful functions and packages
```{r}
############################################
#Load packages
pkgs <- c("data.table", "rmarkdown", "plyr", "lubridate", "magrittr", "ggplot2", "data.table", "dplyr", "stringr", "splitstackshape", "scales", "haven", "Epi", "emmeans", "rtables", "table1",  "tableone", "boot", "knitr", "pspline", "survival", "xtable", "splines2", "htmltools", "here") # packages we need

pkgs_inst <- pkgs[!{pkgs %in% rownames(installed.packages())}] # check which are not present 
install.packages(pkgs_inst, repos = "https://www.stats.bris.ac.uk/R/") # install
lapply(pkgs, library, character.only = TRUE) #load all packages

## Set-up useful functions and packages
source("rounding_functions.R")
source("cut_by_quantile.R") 
```
## Load data

# Overall - SD models
Following [example code for cox model loops](https://github.com/shaankhurshid/ecg_ai/blob/main/cox_ipcw.R)

```{r}
dat <- fread("Data/prepped_steps.csv", data.table = FALSE) # this file location assumes running in same session as previous script
```

Sensitivity analysis group
```{r}
dat <- fread("Data/prepped_steps_RA2years.csv", data.table = FALSE)
```

## Additional data preprocessing

Done in this script not the previous to ensure reference values behave (easy to fix by relevelling otherwise).

```{r}
dat$step_quarters <- qtile_cut(dat$med_steps, probs = seq(0, 1, by = 0.25))
dat$acc_quarters <- qtile_cut(dat$overall_activity, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat$tdi_quarters <- qtile_cut(dat$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat$age_gp_crude <- cut(dat$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat$BMI_cats <-
  cut(dat$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<18.5-24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```

Get population level sd of steps and then subset data down to PRS risk groups 

```{r}

################Cox models
# Calc sd steps
sd(dat$med_steps) #3822.266
# Generate a standardization variable
dat$med_steps_std = (dat$med_steps - mean(dat$med_steps))/sd(dat$med_steps)
# Check distribution of variable
hist(dat$med_steps_std)

```

Subgroup analysis using Harry's method 

```{r}

library("multcomp", "foreign", "biostat3")
cox_BMI <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std*BMI_cats+ strata(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(processed_meat)+as.factor(fresh_fruit)+as.factor(oily_fish),
                         data=dat)


reduced_model <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                       med_steps_std + as.factor(BMI_cats) + strata(sex) +
                       as.factor(ethnicity) + as.factor(tdi_quarters) +
                     as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(processed_meat)+as.factor(fresh_fruit)+as.factor(oily_fish)
                    , data = dat)

lrt <- anova(cox_BMI,reduced_model, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[12] 
p_value <- lrt$"Pr(>|Chi|)"[12] 
df <- lrt$"Df"[12]


cox_summary <- summary(cox_BMI)

# Standard error for the med_steps_std main effect
std_error_Normal <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Overweight <- cox_summary$coefficients["med_steps_std:BMI_cats25.0-29.9", "se(coef)"]
std_error_Obese <- cox_summary$coefficients["med_steps_std:BMI_cats30.0+", "se(coef)"]

sub_BMI <- lincom(cox_BMI, c("med_steps_std",
                          "med_steps_std+med_steps_std:BMI_cats25.0-29.9",
                          "med_steps_std+med_steps_std:BMI_cats30.0+"),
       eform=TRUE)
res <- as.data.frame(sub_BMI)

sub_BMI_df <- bind_rows(res)

sub_BMI_df <- sub_BMI_df %>%
  mutate(model = c("BMI: <25", "BMI: 25 - 30", "BMI: >30")) %>%
  relocate(model, .before = 1)

sub_BMI_df <- sub_BMI_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_BMI_df <- sub_BMI_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2", "3")

# Assign the new row names to the dataframe
rownames(sub_BMI_df) <- new_row_names

sub_BMI_df$x_chi <- x_chi
sub_BMI_df$p_value <- p_value

 



```

```{r}
#Now get case counts and denominator for each 
counts <- dat %>%
  group_by(BMI_cats) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

#Rename to match 
new_row_names <- c("BMI: <25", "BMI: 25 - 30", "BMI: >30")

# Assign the new row names to the dataframe
rownames(counts) <- new_row_names

counts <- counts %>%
  rename(model = BMI_cats)

counts <- counts %>%
  mutate(
    model = case_when(
      model == "<18.5-24.9" ~ "BMI: <25",
      model == "25.0-29.9" ~ "BMI: 25 - 30",
      model == "30.0+" ~ "BMI: >30")
  )

sub_BMI_df <- left_join(sub_BMI_df, counts, by = "model")

sub_BMI_df <- sub_BMI_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

sub_BMI_df <- sub_BMI_df %>%
  mutate(across(where(is.numeric), round, 3))

##Add std_error values
sub_BMI_df <- sub_BMI_df %>%
  mutate(std_error = case_when(
    model == "BMI: 25 - 30" ~ std_error_Overweight,
    model == "BMI: <25" ~ std_error_Normal,
    model == "BMI: >30" ~ std_error_Obese,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

sub_BMI_df$group <- "BMI"


    
```

Sex
```{r}
cox_sex <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                   med_steps_std*strata(sex)+as.factor(ethnicity) +
                   as.factor(tdi_quarters) +as.factor(qualif)+as.factor(season_wear) + 
                   as.factor(smoking)+as.factor(alcohol)+as.factor(processed_meat)+
                   as.factor(fresh_fruit)+as.factor(oily_fish),
                         data=dat)

reduced_model_sex <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                       med_steps_std + strata(sex) +
                       as.factor(ethnicity) + as.factor(tdi_quarters) +
                       as.factor(qualif) + as.factor(season_wear) + 
                       as.factor(smoking) + as.factor(alcohol) + 
                       as.factor(processed_meat) + as.factor(fresh_fruit) + 
                       as.factor(oily_fish), data = dat)

lrt <- anova(cox_sex, reduced_model_sex, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[12] 
p_value <- lrt$"Pr(>|Chi|)"[12] 
df <- lrt$"Df"[12]

summary(cox_sex)

cox_summary <- summary(cox_sex)

# Standard error for the med_steps_std main effect
std_error_Female <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Male <- cox_summary$coefficients["med_steps_std:strata(sex)Male", "se(coef)"]

subgroup_sex <- lincom(cox_sex, c("med_steps_std",
                                  "med_steps_std+med_steps_std:strata(sex)Male"),
                       eform=TRUE)
res <- as.data.frame(subgroup_sex)

sub_sex_df <- bind_rows(res)

sub_sex_df <- sub_sex_df %>%
  mutate(model = c("Female", "Male")) %>%
  relocate(model, .before = 1)

sub_sex_df <- sub_sex_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_sex_df <- sub_sex_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2")

# Assign the new row names to the dataframe
rownames(sub_sex_df) <- new_row_names

sub_sex_df$x_chi <- x_chi
sub_sex_df$p_value <- p_value

sub_sex_df <- sub_sex_df %>%
  mutate(std_error = case_when(
    model == "Female" ~ std_error_Female,
    model == "Male" ~ std_error_Male,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

```

```{r}
#Now get case counts and denominator for each 
counts <- dat %>%
  group_by(sex) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

counts <- counts %>% 
  rename(model = sex)

sub_sex_df <- left_join(sub_sex_df, counts, by = "model")

sub_sex_df <- sub_sex_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

#convert numbers to decimal places 
sub_sex_df <- sub_sex_df %>%
  mutate(across(2:7, ~ if_else(. < 0.0001, "<0.0001",
                                             if_else(. < 0.001, "<0.001", sprintf("%.3f", .)))))


sub_sex_df$group <- "Sex"
```


Age subgroup 
```{r}

cox_age <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std*age_gp_crude + strata(sex)+ as.factor(ethnicity) +
                   as.factor(tdi_quarters) +as.factor(qualif)+ 
                   as.factor(smoking)+as.factor(alcohol)+as.factor(processed_meat)+
                   as.factor(fresh_fruit)+as.factor(oily_fish),
                         data=dat)

cox_age_reduced <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std + as.factor(age_gp_crude) + strata(sex)+  as.factor(ethnicity) +
                   as.factor(tdi_quarters) +as.factor(qualif)+ 
                   as.factor(smoking)+as.factor(alcohol)+as.factor(processed_meat)+
                   as.factor(fresh_fruit)+as.factor(oily_fish),
                         data=dat)

lrt <- anova(cox_age, cox_age_reduced, test = "Chisq")
lrt

lrt
x_chi <- lrt$"Chisq"[2] 
p_value <- 0.5269 
df <- lrt$"Df"[1]

cox_summary <- summary(cox_age)
cox_summary

# Standard error for the med_steps_std main effect
std_error_40_49 <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_50_59 <- cox_summary$coefficients["med_steps_std:age_gp_crude50-59", "se(coef)"]
std_error_60_69 <- cox_summary$coefficients["med_steps_std:age_gp_crude60-69", "se(coef)"]
std_error_70_79 <- cox_summary$coefficients["med_steps_std:age_gp_crude70-79", "se(coef)"]



subgroup_age <- lincom(cox_age, c("med_steps_std",
                                  "med_steps_std+med_steps_std:age_gp_crude50-59",
                                  "med_steps_std+med_steps_std:age_gp_crude60-69",
                                  "med_steps_std+med_steps_std:age_gp_crude70-79"),
                                    eform=TRUE)
subgroup_age

res <- as.data.frame(subgroup_age)

sub_age_df <- bind_rows(res)

sub_age_df <- sub_age_df %>%
  mutate(model = c("40-49", "50-59", "60-69", "70-79")) %>%
  relocate(model, .before = 1)

sub_age_df <- sub_age_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_age_df <- sub_age_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2", "3", "4")

# Assign the new row names to the dataframe
rownames(sub_age_df) <- new_row_names

sub_age_df$x_chi <- x_chi
sub_age_df$p_value <- p_value

#Add std_error column 

sub_age_df <- sub_age_df %>%
  mutate(std_error = case_when(
    model == "40-49" ~ std_error_40_49,
    model == "50-59" ~ std_error_50_59,
    model == "60-69" ~ std_error_60_69,
    model == "70-79" ~ std_error_70_79,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

```

```{r}
counts <- dat %>%
  group_by(age_gp_crude) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

counts <- counts %>% 
  rename(model = age_gp_crude)

sub_age_df <- left_join(sub_age_df, counts, by = "model")

sub_age_df <- sub_age_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

#convert numbers to decimal places 
sub_age_df <- sub_age_df %>%
  mutate(across(2:7, ~ if_else(. < 0.0001, "<0.0001",
                                             if_else(. < 0.001, "<0.001", sprintf("%.3f", .)))))


sub_age_df$group <- "Age"

```

Total dataframe 
```{r}

sub_BMI_df$Estimate <- as.character(sub_BMI_df$Estimate)

sub_BMI_df <- sub_BMI_df %>%
  mutate(across(everything(), as.character))
sub_age_df <- sub_age_df %>%
  mutate(across(everything(), as.character))
sub_sex_df <- sub_sex_df %>%
  mutate(across(everything(), as.character))

# Do the same for sub_sex_df and sub_age_df if they have the same issue
sub_BMI_df <- sub_BMI_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_age_df <- sub_age_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_sex_df <- sub_sex_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

# Assuming 'model' is the common column in all three dataframes and you want to join by this column
final_df <- bind_rows(sub_BMI_df, sub_sex_df, sub_age_df)

# View the final combined dataframe
print(final_df)

as.factor(final_df$model)

ordered_levels <- c("BMI: <25", "BMI: 25 - 30", "BMI: >30",
                    "Female", "Male",
                    "40-49", "50-59", "60-69", "70-79")

# Now, set the factor levels for 'model' using this ordering
final_df$model <- factor(final_df$model, levels = ordered_levels)

final_df <- final_df %>%
  mutate(group = factor(group, levels = c("BMI", "Sex", "Age")))

final_df <- final_df %>%
  mutate(
    `Lower CI` = as.numeric(`Lower CI`),
    Estimate = as.numeric(Estimate),
    `Upper CI` = as.numeric(`Upper CI`)
  )



```

```{r}

xbreaks <- c(0.5,0.75, 1,1.5 , 2)  # Include 2 in the breaks
  xlim_scale <- 1

  xlims <- c(xbreaks[1] / xlim_scale, xbreaks[length(xbreaks)] * xlim_scale)
  
  #to force a line at 1 for x intercept across all facets
  line_data <- data.frame(
  xintercept = 1,
  group = unique(final_df$group)  # Make sure this is the name of your faceting variable
)

forest_plot <- ggplot(final_df, aes(x = Estimate, y = model, xmin = `Lower CI`, xmax = `Upper CI`)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(height = 0.2)) +
  geom_vline(xintercept = 1, linetype = "solid", color = "black") +
  facet_grid(group ~ ., scales = "free", space = "free") + # Create separate panels for each group
  labs(x = "Hazard Ratio (95% CI)", y = "") +
  scale_x_continuous(
     trans = "log",
      breaks = xbreaks * xlim_scale,
  limits = xlims)+
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    panel.spacing = unit(2, "lines") # Adjust spacing between panels
  )

# Print the plot
forest_plot

```

```{r}



forest_plot <- ggplot(final_df, aes(x = Estimate, y = model, xmin = `Lower CI`, xmax = `Upper CI`)) +
  geom_point() +  # Points for the estimates
  geom_errorbarh(height = 0.2) +  # Error bars for the CIs
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +  # Line for null effect
  geom_text(aes(label = paste(RA_Incidents, "/", Total_Length)), position = position_nudge(x = 0.05), hjust = 0) +
  labs(x = "Hazard Ratio (95% CI)", y = "") +
  theme_minimal() +
  scale_x_continuous(
     trans = "log",
      breaks = xbreaks * xlim_scale,
  limits = xlims)+
  theme(
    axis.text.y = element_text(size = 12),
    plot.margin = margin(t = 10, r = 30, b = 10, l = 10, unit = "pt")
  )

# Add the heading for the 'Events / Total Population' column
heading_position <- max(final_df$`Upper CI`, na.rm = TRUE) * 1.1  # Adjust based on your data
forest_plot <- forest_plot +
  annotate("text", x = heading_position, y = length(levels(final_df$model)) + 1, 
           label = "Events / Total Population", size = 5, hjust = 0.5)



# Print the plot
forest_plot

```

```{r}
forest_plot <- ggplot(sub_BMI_df, aes(x = Estimate, y = model, xmin = `Lower CI`, xmax = `Upper CI`)) +
  geom_point() +
  geom_errorbarh(height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(x = "Hazard Ratio (95% CI)", y = "") +
  theme(axis.text.y = element_text(size = 12))

# Print the plot
forest_plot



# Adjust `to_the_right_of_CI` to be a position to the right of the confidence intervals, 
# which may be dependent on your data range. Replace it with a numeric value or a column name that specifies the position.

# Print the updated plot
forest_plot

heading_position <- max(sub_BMI_df$`Upper CI`) + 2 # some_offset to be determined based on your plot

# Adding the heading
forest_plot <- forest_plot +
  annotate("text", x = heading_position, y = length(sub_BMI_df$model) + 1, 
           label = "Events / Total Population", size = 5, hjust = 1)

forest_plot <- forest_plot +
  geom_text(aes(x = heading_position, label = paste(RA_Incidents,Total_Length, sep = " / ")), hjust = 0, nudge_x = 0.1)
forest_plot


```

```{r}

library("multcomp", "foreign", "biostat3")
cox_BMI_cad <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           cad30_std*BMI_cats+ strata(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                           as.factor(season_wear) + as.factor(smoking) + as.factor(alcohol)+as.factor(processed_meat)+as.factor(fresh_fruit)+as.factor(oily_fish),
                         data=dat)

summary(cox_BMI_cad)


subgroup_BMI_cad <- lincom(cox_BMI_cad, c("cad30_std",
                          "cad30_std+cad30_std:BMI_cats25.0-29.9",
                          "cad30_std+cad30_std:BMI_cats30.0+"),
       eform=TRUE)
subgroup_BMI_cad


```





Subset based on PRS risk 
```{r}
datLow <- dat %>%
  filter(PRS_RA_RiskGroup == "Low")
datInter <- dat %>%
  filter(PRS_RA_RiskGroup == "Intermediate")
datHigh <- dat %>%
  filter(PRS_RA_RiskGroup == "High")

```

Low risk group first 
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std,
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit)+ factor(BMI_cats),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfLow <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfLow, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsLow.csv")), row.names=FALSE)
```


Intermediate risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std,
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit)+ factor(BMI_cats),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfInter <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfInter, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsInter.csv")), row.names=FALSE)
```

High risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std,
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit)+ factor(BMI_cats),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfHigh <- merged_steps_df  

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfHigh, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsHigh.csv")), row.names=FALSE)
```


Sensitivity analysis of those 2 years post 

Done in this script not the previous to ensure reference values behave (easy to fix by relevelling otherwise).

```{r}
dat2yr$step_fifths <- qtile_cut(dat2yr$med_steps, probs = seq(0, 1, by = 0.2))
dat2yr$acc_fifths <- qtile_cut(dat2yr$overall_activity, probs = seq(0, 1, by = 0.2), dp_label = 1)
dat2yr$tdi_quarters <- qtile_cut(dat2yr$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat2yr$age_gp_crude <- cut(dat2yr$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat2yr$BMI_cats <-
  cut(dat2yr$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<18.5-24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```

Get population level sd of steps and then subset data down to PRS risk groups 

```{r}

################Cox models
# Calc sd steps
sd(dat2yr$med_steps) #3815.4
# Generate a standardization variable
dat2yr$med_steps_standardization = (dat2yr$med_steps - mean(dat2yr$med_steps))/sd(dat2yr$med_steps)
# Check distribution of variable
hist(dat2yr$med_steps_standardization)

```


Subset based on PRS risk 
```{r}
datLow <- dat2yr %>%
  filter(PRS_RA_RiskGroup == "Low")
datInter <- dat2yr %>%
  filter(PRS_RA_RiskGroup == "Intermediate")
datHigh <- dat2yr %>%
  filter(PRS_RA_RiskGroup == "High")

```

Low risk group first 
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization,
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(BMI_cats),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfLow <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfLow, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsLow2yr.csv")), row.names=FALSE)
```


Intermediate risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization,
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(BMI_cats),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfInter <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfInter, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsInter2yr.csv")), row.names=FALSE)
```

High risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization,
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(BMI_cats),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfHigh <- merged_steps_df  

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfHigh, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsHigh2yr.csv")), row.names=FALSE)
```



