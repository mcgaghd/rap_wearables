---
title: "Modeling_1sd"
author: "Dylan McGagh"
date: "`r format(Sys.time(), '%a %b %d, %Y %X')`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 5
    theme: lumen
---
```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction

This script runs models for 1 SD increase in exposure.

# Set up workspace
```{r}
dir.create("PRSbyGroup")
```

## Set-up useful functions and packages
```{r}
############################################
#Load packages
pkgs <- c("data.table", "rmarkdown", "plyr", "lubridate", "magrittr", "ggplot2", "data.table", "dplyr", "stringr", "splitstackshape", "scales", "haven", "Epi", "emmeans", "rtables", "table1",  "tableone", "boot", "knitr", "pspline", "survival", "xtable", "splines2", "htmltools", "here") # packages we need

pkgs_inst <- pkgs[!{pkgs %in% rownames(installed.packages())}] # check which are not present 
install.packages(pkgs_inst, repos = "https://www.stats.bris.ac.uk/R/") # install
lapply(pkgs, library, character.only = TRUE) #load all packages

## Set-up useful functions and packages
source("rounding_functions.R")
source("cut_by_quantile.R") 
source("cox_functions.R")
```
## Load data

# Overall - SD models
Following [example code for cox model loops](https://github.com/shaankhurshid/ecg_ai/blob/main/cox_ipcw.R)

```{r}
dat <- fread("Data/prepped_steps.csv", data.table = FALSE) # this file location assumes running in same session as previous script
```

Sensitivity analysis group
```{r}
dat <- fread("prepped_steps.csv", data.table = FALSE)
```

```{r}
TwoYear_cases <- (dat$RA_incident & dat$fu_time <= 730)

dat <- dat[!(TwoYear_cases), ]
```
## Additional data preprocessing

Done in this script not the previous to ensure reference values behave (easy to fix by relevelling otherwise).

```{r}
dat$step_quarters <- qtile_cut(dat$med_steps, probs = seq(0, 1, by = 0.25))
dat$acc_quarters <- qtile_cut(dat$overall_activity, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat$tdi_quarters <- qtile_cut(dat$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat$age_gp_crude <- cut(dat$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat$BMI_cats <-
  cut(dat$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<18.5-24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```

```{r}
dat2yr$step_quarters <- qtile_cut(dat2yr$med_steps, probs = seq(0, 1, by = 0.25))
dat2yr$acc_quarters <- qtile_cut(dat2yr$overall_activity, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat2yr$tdi_quarters <- qtile_cut(dat2yr$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat2yr$age_gp_crude <- cut(dat2yr$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat2yr$BMI_cats <-
  cut(dat2yr$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<18.5-24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```

Get population level sd of steps and then subset data down to PRS risk groups 

```{r}

################Cox models
# Calc sd steps
sd(dat$med_steps) #3811
# Generate a standardization variable
dat$med_steps_std = (dat$med_steps - mean(dat$med_steps))/sd(dat$med_steps)
# Check distribution of variable
hist(dat$med_steps_std)

```



```{r}

primary <- "med_steps"
dat$med_steps_std <- standardise_column(dat[[primary]], 1000, TRUE)
hist(dat$med_steps_std)
```
```{r}
dat <- dat %>%
  mutate(PRS_group_numeric = case_when(
    PRS_RA_RiskGroup == "Low"          ~ 1,
    PRS_RA_RiskGroup == "Intermediate" ~ 2,
    PRS_RA_RiskGroup == "High"         ~ 3
  ))
```

```{r}
cox_models <- list()

# Loop through each numeric PRS group
for(i in 1:3) {
  # Subset data for the current PRS group
  data_subset <- subset(dat, PRS_group_numeric == i)
  
  # Fit Cox model for the subset
  cox_models[[i]] <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                           med_steps_std + strata(sex) +
                           as.factor(tdi_quarters) + as.factor(qualif) +
                           as.factor(smoking) + as.factor(alcohol) + as.factor(red_processed_total) + as.factor(fruit_veg_total),
                           data = data_subset)
}

# Access the model for each group
cox_model_group1 <- cox_models[[1]]
cox_model_group2 <- cox_models[[2]]
cox_model_group3 <- cox_models[[3]]

summary(cox_model_group1)
summary(cox_model_group2)
summary(cox_model_group3)
```

BMI groups 
```{r}
dat <- dat %>%
  mutate(BMI_group_numeric = case_when(
    BMI_cats == "<18.5-24.9"          ~ 1,
    BMI_cats == "25.0-29.9" ~ 2,
    BMI_cats == "30.0+"         ~ 3
  ))
```

```{r}
cox_models <- list()

# Loop through each numeric PRS group
for(i in 1:3) {
  # Subset data for the current PRS group
  data_subset <- subset(dat, BMI_group_numeric == i)
  
  # Fit Cox model for the subset
  cox_models[[i]] <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                           med_steps_std + strata(sex) +
                           as.factor(tdi_quarters) + as.factor(qualif) +
                           as.factor(smoking) + as.factor(alcohol) + as.factor(red_processed_total) + as.factor(fruit_veg_total),
                           data = data_subset)
}

# Access the model for each group
cox_model_group1 <- cox_models[[1]]
cox_model_group2 <- cox_models[[2]]
cox_model_group3 <- cox_models[[3]]

summary(cox_model_group1)
summary(cox_model_group2)
summary(cox_model_group3)
```

```{r}
dat <- dat %>%
  mutate(age_group_numeric = case_when(
    age_gp_crude == "40-49"          ~ 1,
    age_gp_crude == "50-59" ~ 2,
    age_gp_crude == "60-69"         ~ 3,
    age_gp_crude == "70-79" ~ 4
  ))
```

```{r}
cox_models <- list()

# Loop through each numeric PRS group
for(i in 1:4) {
  # Subset data for the current PRS group
  data_subset <- subset(dat, age_group_numeric == i)
  
  # Fit Cox model for the subset
  cox_models[[i]] <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                           med_steps_std + strata(sex) +
                           as.factor(tdi_quarters) + as.factor(qualif) +
                           as.factor(smoking) + as.factor(red_processed_total) + as.factor(fruit_veg_total),
                           data = data_subset)
}

# Access the model for each group
cox_model_group1 <- cox_models[[1]]
cox_model_group2 <- cox_models[[2]]
cox_model_group3 <- cox_models[[3]]
cox_model_group4 <- cox_models[[4]]

summary(cox_model_group1)
summary(cox_model_group2)
summary(cox_model_group3)
summary(cox_model_group4)
```

```{r}

################Cox models
# Calc sd steps
sd(dat2yr$med_steps) #3822.266
# Generate a standardization variable
dat2yr$med_steps_std = (dat2yr$med_steps - mean(dat2yr$med_steps))/sd(dat2yr$med_steps)
# Check distribution of variable
hist(dat2yr$med_steps_std)

```

```{r}
dat <- dat %>%
  filter(!is.na(RF_binary))
```

```{r}

#library(multcomp, foreign, biostat3)
cox_RF <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std*RF_binary+ strata(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total),
                         data=dat)


reduced_model <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                       med_steps_std + as.factor(RF_binary) + strata(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total)
                    , data = dat)

lrt <- anova(cox_RF,reduced_model, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[11] 
p_value <- lrt$"Pr(>|Chi|)"[11] 
df <- lrt$"Df"[11]


cox_summary <- summary(cox_RF)

cox_summary

# Standard error for the med_steps_std main effect
std_error_High <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Intermediate <- cox_summary$coefficients["med_steps_std:PRS_RA_RiskGroupIntermediate", "se(coef)"]
std_error_Low <- cox_summary$coefficients["med_steps_std:PRS_RA_RiskGroupLow", "se(coef)"]

sub_RF <- lincom(cox_RF, c("med_steps_std",
                          "med_steps_std:RF_binaryPositive"),
       eform=TRUE)
res <- as.data.frame(sub_PRS)

```

Subgroup by PRS

```{r}

#library(multcomp, foreign, biostat3)
cox_PRS <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std*PRS_RA_RiskGroup+ strata(sex)+
                           as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total),
                         data=dat)


reduced_model <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                       med_steps_std + as.factor(PRS_RA_RiskGroup) + strata(sex)+
                            as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total)
                    , data = dat)

lrt <- anova(cox_PRS,reduced_model, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[11] 
p_value <- lrt$"Pr(>|Chi|)"[11] 
df <- lrt$"Df"[11]


cox_summary <- summary(cox_PRS)

cox_summary

# Standard error for the med_steps_std main effect
std_error_High <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Intermediate <- cox_summary$coefficients["med_steps_std:PRS_RA_RiskGroupIntermediate", "se(coef)"]
std_error_Low <- cox_summary$coefficients["med_steps_std:PRS_RA_RiskGroupLow", "se(coef)"]

sub_PRS <- lincom(cox_PRS, c("med_steps_std",
                          "med_steps_std:PRS_RA_RiskGroupIntermediate",
                          "med_steps_std:PRS_RA_RiskGroupLow"),
       eform=TRUE)
res <- as.data.frame(sub_PRS)

sub_PRS_df <- bind_rows(res)

sub_PRS_df <- sub_PRS_df %>%
  mutate(model = c("High", "Intermediate", "Low")) %>%
  relocate(model, .before = 1)

sub_PRS_df <- sub_PRS_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_PRS_df <- sub_PRS_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2", "3")

# Assign the new row names to the dataframe
rownames(sub_PRS_df) <- new_row_names

sub_PRS_df$x_chi <- x_chi
sub_PRS_df$p_value <- p_value

```

```{r}
#Now get case counts and denominator for each 
counts <- dat %>%
  group_by(PRS_RA_RiskGroup) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

#Rename to match 
new_row_names <- c("BMI: <25", "BMI: 25 - 30", "BMI: >30")

# Assign the new row names to the dataframe
rownames(counts) <- new_row_names

counts <- counts %>%
  rename(model = PRS_RA_RiskGroup)


sub_PRS_df <- left_join(sub_PRS_df, counts, by = "model")

sub_PRS_df <- sub_PRS_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

sub_PRS_df <- sub_PRS_df %>%
  mutate(across(where(is.numeric), round, 3))

##Add std_error values
sub_PRS_df <- sub_PRS_df %>%
  mutate(std_error = case_when(
    model == "High" ~ std_error_High,
    model == "Intermediate" ~ std_error_Intermediate,
    model == "Low" ~ std_error_Low,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

sub_PRS_df$group <- "Full"
```


```{r}

#library(multcomp, foreign, biostat3)
cox_PRS_2yr <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std*PRS_RA_RiskGroup+ as.factor(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total),
                         data=dat2yr)


reduced_model <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                       med_steps_std + as.factor(PRS_RA_RiskGroup) + as.factor(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total)
                    , data = dat2yr)

lrt <- anova(cox_PRS_2yr,reduced_model, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[11] 
p_value <- lrt$"Pr(>|Chi|)"[11] 
df <- lrt$"Df"[11]


cox_summary <- summary(cox_PRS_2yr)

cox_summary

# Standard error for the med_steps_std main effect
std_error_High_2yr <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Intermediate_2yr <- cox_summary$coefficients["med_steps_std:PRS_RA_RiskGroupIntermediate", "se(coef)"]
std_error_Low_2yr <- cox_summary$coefficients["med_steps_std:PRS_RA_RiskGroupLow", "se(coef)"]

sub_PRS_2yr <- lincom(cox_PRS_2yr, c("med_steps_std",
                          "med_steps_std:PRS_RA_RiskGroupIntermediate",
                          "med_steps_std:PRS_RA_RiskGroupLow"),
       eform=TRUE)
res <- as.data.frame(sub_PRS_df_2yr)

sub_PRS_df <- bind_rows(res)

sub_PRS_df <- sub_PRS_df %>%
  mutate(model = c("High", "Intermediate", "Low")) %>%
  relocate(model, .before = 1)

sub_PRS_df <- sub_PRS_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_PRS_df <- sub_PRS_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2", "3")

# Assign the new row names to the dataframe
rownames(sub_PRS_df) <- new_row_names

sub_PRS_df$x_chi <- x_chi
sub_PRS_df$p_value <- p_value

```

```{r}
#Now get case counts and denominator for each 
counts <- dat %>%
  group_by(PRS_RA_RiskGroup) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

#Rename to match 
new_row_names <- c("BMI: <25", "BMI: 25 - 30", "BMI: >30")

# Assign the new row names to the dataframe
rownames(counts) <- new_row_names

counts <- counts %>%
  rename(model = PRS_RA_RiskGroup)


sub_PRS_df <- left_join(sub_PRS_df, counts, by = "model")

sub_PRS_df <- sub_PRS_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

sub_PRS_df <- sub_PRS_df %>%
  mutate(across(where(is.numeric), round, 3))

##Add std_error values
sub_PRS_df <- sub_PRS_df %>%
  mutate(std_error = case_when(
    model == "High" ~ std_error_High,
    model == "Intermediate" ~ std_error_Intermediate,
    model == "Low" ~ std_error_Low,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

sub_PRS_df$group <- "Full"
```



Subgroup analysis using Harry's method 

```{r}

#library(multcomp, foreign, biostat3)
cox_BMI <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std*BMI_cats+ strata(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total),
                         data=dat)


reduced_model <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                       med_steps_std + as.factor(BMI_cats) + strata(sex) +
                       as.factor(ethnicity) + as.factor(tdi_quarters) +
                     as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total)
                    , data = dat)

lrt <- anova(cox_BMI,reduced_model, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[11] 
p_value <- lrt$"Pr(>|Chi|)"[11] 
df <- lrt$"Df"[11]


cox_summary <- summary(cox_BMI)
cox_summary

# Standard error for the med_steps_std main effect
std_error_Normal <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Overweight <- cox_summary$coefficients["med_steps_std:BMI_cats25.0-29.9", "se(coef)"]
std_error_Obese <- cox_summary$coefficients["med_steps_std:BMI_cats30.0+", "se(coef)"]

sub_BMI <- lincom(cox_BMI, c("med_steps_std",
                          "med_steps_std+med_steps_std:BMI_cats25.0-29.9",
                          "med_steps_std+med_steps_std:BMI_cats30.0+"),
       eform=TRUE)
res <- as.data.frame(sub_BMI)

sub_BMI_df <- bind_rows(res)

sub_BMI_df <- sub_BMI_df %>%
  mutate(model = c("BMI: <25", "BMI: 25 - 30", "BMI: >30")) %>%
  relocate(model, .before = 1)

sub_BMI_df <- sub_BMI_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_BMI_df <- sub_BMI_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2", "3")

# Assign the new row names to the dataframe
rownames(sub_BMI_df) <- new_row_names

sub_BMI_df$x_chi <- x_chi
sub_BMI_df$p_value <- p_value

```

```{r}
#Now get case counts and denominator for each 
counts <- dat %>%
  group_by(BMI_cats) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

#Rename to match 
new_row_names <- c("BMI: <25", "BMI: 25 - 30", "BMI: >30")

# Assign the new row names to the dataframe
rownames(counts) <- new_row_names

counts <- counts %>%
  rename(model = BMI_cats)

counts <- counts %>%
  mutate(
    model = case_when(
      model == "<18.5-24.9" ~ "BMI: <25",
      model == "25.0-29.9" ~ "BMI: 25 - 30",
      model == "30.0+" ~ "BMI: >30")
  )

sub_BMI_df <- left_join(sub_BMI_df, counts, by = "model")

sub_BMI_df <- sub_BMI_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

sub_BMI_df <- sub_BMI_df %>%
  mutate(across(where(is.numeric), round, 3))

##Add std_error values
sub_BMI_df <- sub_BMI_df %>%
  mutate(std_error = case_when(
    model == "BMI: 25 - 30" ~ std_error_Overweight,
    model == "BMI: <25" ~ std_error_Normal,
    model == "BMI: >30" ~ std_error_Obese,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

sub_BMI_df$group <- "BMI"


    
```

Sex
```{r}
cox_sex <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                   med_steps_std*sex+as.factor(ethnicity) + as.factor(tdi_quarters)
                 +as.factor(qualif) + as.factor(smoking) +
                   as.factor(alcohol)+as.factor(red_processed_total) + as.factor(fruit_veg_total),
                         data=dat)

reduced_model_sex <- coxph(Surv(age_entry_days, age_exit_days, RA_incident) ~ 
                       med_steps_std + as.factor(sex) +as.factor(ethnicity) +
                         as.factor(tdi_quarters)
                 +as.factor(qualif) + as.factor(smoking) +
                   as.factor(alcohol)+as.factor(red_processed_total) + as.factor(fruit_veg_total), data = dat)

lrt <- anova(cox_sex, reduced_model_sex, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[11] 
p_value <- lrt$"Pr(>|Chi|)"[11] 
df <- lrt$"Df"[11]

summary(cox_sex)

cox_summary <- summary(cox_sex)

# Standard error for the med_steps_std main effect
std_error_Female <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Male <- cox_summary$coefficients["med_steps_std:sexMale", "se(coef)"]

subgroup_sex <- lincom(cox_sex, c("med_steps_std",
                                  "med_steps_std+med_steps_std:sexMale"),
                       eform=TRUE)
res <- as.data.frame(subgroup_sex)

sub_sex_df <- bind_rows(res)

sub_sex_df <- sub_sex_df %>%
  mutate(model = c("Female", "Male")) %>%
  relocate(model, .before = 1)

sub_sex_df <- sub_sex_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_sex_df <- sub_sex_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2")

# Assign the new row names to the dataframe
rownames(sub_sex_df) <- new_row_names

sub_sex_df$x_chi <- x_chi
sub_sex_df$p_value <- p_value

sub_sex_df <- sub_sex_df %>%
  mutate(std_error = case_when(
    model == "Female" ~ std_error_Female,
    model == "Male" ~ std_error_Male,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

```

```{r}
#Now get case counts and denominator for each 
counts <- dat %>%
  group_by(sex) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

counts <- counts %>% 
  rename(model = sex)

sub_sex_df <- left_join(sub_sex_df, counts, by = "model")

sub_sex_df <- sub_sex_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

#convert numbers to decimal places 
sub_sex_df <- sub_sex_df %>%
  mutate(across(2:7, ~ if_else(. < 0.0001, "<0.0001",
                                             if_else(. < 0.001, "<0.001", sprintf("%.3f", .)))))


sub_sex_df$group <- "Sex"
```


Age subgroup 
```{r}

cox_age <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std*age_gp_crude + strata(sex)+ as.factor(ethnicity) +
                   as.factor(tdi_quarters) +as.factor(qualif)+ 
                   as.factor(smoking)+as.factor(alcohol)+as.factor(red_processed_total)+
                   as.factor(fruit_veg_total),
                         data=dat)

cox_age_reduced <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           med_steps_std + as.factor(age_gp_crude) + strata(sex)+  as.factor(ethnicity) +
                   as.factor(tdi_quarters) +as.factor(qualif)+ 
                   as.factor(smoking)+as.factor(alcohol)+as.factor(red_processed_total)+
                   as.factor(fruit_veg_total),
                         data=dat)

lrt <- anova(cox_age, cox_age_reduced, test = "Chisq")
lrt

lrt
x_chi <- lrt$"Chisq"[2] 
p_value <- 0.5248 
df <- 3

cox_summary <- summary(cox_age)
cox_summary

# Standard error for the med_steps_std main effect
std_error_40_49 <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_50_59 <- cox_summary$coefficients["med_steps_std:age_gp_crude50-59", "se(coef)"]
std_error_60_69 <- cox_summary$coefficients["med_steps_std:age_gp_crude60-69", "se(coef)"]
std_error_70_79 <- cox_summary$coefficients["med_steps_std:age_gp_crude70-79", "se(coef)"]



subgroup_age <- lincom(cox_age, c("med_steps_std",
                                  "med_steps_std+med_steps_std:age_gp_crude50-59",
                                  "med_steps_std+med_steps_std:age_gp_crude60-69",
                                  "med_steps_std+med_steps_std:age_gp_crude70-79"),
                                    eform=TRUE)
subgroup_age

res <- as.data.frame(subgroup_age)

sub_age_df <- bind_rows(res)

sub_age_df <- sub_age_df %>%
  mutate(model = c("40-49", "50-59", "60-69", "70-79")) %>%
  relocate(model, .before = 1)

sub_age_df <- sub_age_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_age_df <- sub_age_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2", "3", "4")

# Assign the new row names to the dataframe
rownames(sub_age_df) <- new_row_names

sub_age_df$x_chi <- x_chi
sub_age_df$p_value <- p_value

#Add std_error column 

sub_age_df <- sub_age_df %>%
  mutate(std_error = case_when(
    model == "40-49" ~ std_error_40_49,
    model == "50-59" ~ std_error_50_59,
    model == "60-69" ~ std_error_60_69,
    model == "70-79" ~ std_error_70_79,
    TRUE ~ NA_real_  # For all other rows, set to NA or keep existing std_error if already defined
  ))

```

```{r}
counts <- dat %>%
  group_by(age_gp_crude) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

counts <- counts %>% 
  rename(model = age_gp_crude)

sub_age_df <- left_join(sub_age_df, counts, by = "model")

sub_age_df <- sub_age_df %>%
  mutate(
    across(2:5, ~ as.numeric(as.character(.)))
  )

#convert numbers to decimal places 
sub_age_df <- sub_age_df %>%
  mutate(across(2:7, ~ if_else(. < 0.0001, "<0.0001",
                                             if_else(. < 0.001, "<0.001", sprintf("%.3f", .)))))


sub_age_df$group <- "Age"

```

```{r}
cox_full <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                   med_steps_std + strata(sex)+as.factor(ethnicity) +
                    as.factor(tdi_quarters)+as.factor(qualif) + as.factor(smoking) +
                   as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total)+
                   as.factor(BMI_cats)
                   ,
                         data=dat)
summary(cox_full)

summary(cox_full)

cox_summary <- summary(cox_full)

# Standard error for the med_steps_std main effect
std_error_Overall <- cox_summary$coefficients["med_steps_std", "se(coef)"]

###Create a dataframe of this

total <- dat %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

datTotal <- total %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

Overall <- tibble(
  model = "Overall",
  group = "Overall",
  `Lower CI` = 0.7576, 
  `Upper CI` = 0.9053, 
  Estimate = 0.8282, 
  std_error = 0.0454, 
  RA_Incidents = 631, 
  Total_Length = 91069
)

other_columns <- setdiff(names(final_df), names(Overall))
Overall[other_columns] <- NA




```

1000 steps

```{r}
cox_full <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                   med_steps_std + strata(sex)+as.factor(ethnicity) +
                    as.factor(tdi_quarters)+as.factor(qualif) + as.factor(smoking) +
                   as.factor(alcohol)+as.factor(red_processed_total)+as.factor(fruit_veg_total)+
                   as.factor(BMI_cats)
                   ,
                         data=dat)
summary(cox_full)

summary(cox_full)

cox_summary <- summary(cox_full)

# Standard error for the med_steps_std main effect
std_error_Overall <- cox_summary$coefficients["med_steps_std", "se(coef)"]

###Create a dataframe of this

total <- dat %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    RA_Incidents = sum(RA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )

datTotal <- total %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

Overall <- tibble(
  model = "Overall",
  group = "Overall",
  `Lower CI` = 0.9298, 
  `Upper CI` = 0.9742, 
  Estimate = 0.9517, 
  std_error = 0.0119, 
  RA_Incidents = 631, 
  Total_Length = 91069
)

other_columns <- setdiff(names(final_df), names(Overall))
Overall[other_columns] <- NA




```



Total dataframe 
```{r}

sub_BMI_df$Estimate <- as.character(sub_BMI_df$Estimate)

sub_BMI_df <- sub_BMI_df %>%
  mutate(across(everything(), as.character))
sub_age_df <- sub_age_df %>%
  mutate(across(everything(), as.character))
sub_sex_df <- sub_sex_df %>%
  mutate(across(everything(), as.character))

# Do the same for sub_sex_df and sub_age_df if they have the same issue
sub_BMI_df <- sub_BMI_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_age_df <- sub_age_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_sex_df <- sub_sex_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

# Assuming 'model' is the common column in all three dataframes and you want to join by this column
final_df <- bind_rows(sub_BMI_df, sub_sex_df, sub_age_df)

# View the final combined dataframe
print(final_df)

as.factor(final_df$model)

final_df <- final_df %>%
  mutate(group = factor(group, levels = c("BMI", "Sex", "Age")))

final_df <- final_df %>%
  mutate(
    `Lower CI` = as.numeric(`Lower CI`),
    Estimate = as.numeric(Estimate),
    `Upper CI` = as.numeric(`Upper CI`),
    `x_chi` = as.numeric(`x_chi`),
    `p_value` = as.numeric(`p_value`)
  )

final_df <- final_df %>%
  mutate(std_error = as.numeric(as.character(std_error)))

age_levels_ordered <- c("70-79","60-69", "50-59", "40-49")
bmi_levels_ordered <- c("BMI: >30","BMI: 25 - 30", "BMI: <25" )

# Apply the ordering to the 'model' column
final_df$model <- factor(final_df$model, levels = c(bmi_levels_ordered, "Female", "Male", age_levels_ordered))

#Relabel
levels(final_df$model)[levels(final_df$model) == "BMI: <25"] <- "<25"
levels(final_df$model)[levels(final_df$model) == "BMI: 25 - 30"] <- "25-29.9"
levels(final_df$model)[levels(final_df$model) == "BMI: >30"] <- "30+"


final_df <- final_df %>%
  distinct(model, .keep_all = TRUE) %>%
  mutate(y_position = 1:n())  # Create a y-position for each group label

#degrees of freedom for plots
final_df <- final_df %>%
  mutate(df = case_when(
    group == "BMI" ~ 3,
    group == "Sex" ~ 2,
    group == "Age" ~ 4,
    TRUE ~ NA_integer_  # For any group not covered above, NA is assigned (or you can assign another default value)
  ))

final_df <- final_df %>%
  mutate(group = case_when(
    group == "BMI" ~ "BMI (categories)",
    group == "Age" ~ "Age (categories)",
    TRUE ~ group  # Keeps all other values as they are
  ))

final_df$group <- factor(final_df$group, levels = c("Sex", "Age (categories)", "BMI (categories)", "Overall"))



# Print out the updated dataframe
print(final_df)

````




Total dataframe 
```{r}

sub_BMI_df$Estimate <- as.character(sub_BMI_df$Estimate)

sub_BMI_df <- sub_BMI_df %>%
  mutate(across(everything(), as.character))
sub_age_df <- sub_age_df %>%
  mutate(across(everything(), as.character))
sub_sex_df <- sub_sex_df %>%
  mutate(across(everything(), as.character))

# Do the same for sub_sex_df and sub_age_df if they have the same issue
sub_BMI_df <- sub_BMI_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_age_df <- sub_age_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_sex_df <- sub_sex_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

# Assuming 'model' is the common column in all three dataframes and you want to join by this column
final_df <- bind_rows(sub_BMI_df, sub_sex_df, sub_age_df)

# View the final combined dataframe
print(final_df)

as.factor(final_df$model)

final_df <- final_df %>%
  mutate(group = factor(group, levels = c("BMI", "Sex", "Age")))

final_df <- final_df %>%
  mutate(
    `Lower CI` = as.numeric(`Lower CI`),
    Estimate = as.numeric(Estimate),
    `Upper CI` = as.numeric(`Upper CI`),
    `x_chi` = as.numeric(`x_chi`),
    `p_value` = as.numeric(`p_value`)
  )

final_df <- final_df %>%
  mutate(std_error = as.numeric(as.character(std_error)))

age_levels_ordered <- c("70-79","60-69", "50-59", "40-49")
bmi_levels_ordered <- c("BMI: >30","BMI: 25 - 30", "BMI: <25" )

# Apply the ordering to the 'model' column
final_df$model <- factor(final_df$model, levels = c(bmi_levels_ordered, "Female", "Male", age_levels_ordered))

#Relabel
levels(final_df$model)[levels(final_df$model) == "BMI: <25"] <- "<25"
levels(final_df$model)[levels(final_df$model) == "BMI: 25 - 30"] <- "25-29.9"
levels(final_df$model)[levels(final_df$model) == "BMI: >30"] <- "30+"


final_df <- final_df %>%
  distinct(model, .keep_all = TRUE) %>%
  mutate(y_position = 1:n())  # Create a y-position for each group label

#degrees of freedom for plots
final_df <- final_df %>%
  mutate(df = case_when(
    group == "BMI" ~ 3,
    group == "Sex" ~ 2,
    group == "Age" ~ 4,
    TRUE ~ NA_integer_  # For any group not covered above, NA is assigned (or you can assign another default value)
  ))

final_df <- final_df %>%
  mutate(group = case_when(
    group == "BMI" ~ "BMI (categories)",
    group == "Age" ~ "Age (categories)",
    TRUE ~ group  # Keeps all other values as they are
  ))

final_df$group <- factor(final_df$group, levels = c("Sex", "Age (categories)", "BMI (categories)"))





# Print out the updated dataframe
print(final_df)


#final_df <- bind_rows(final_df, Overall)

```

Final use
```{r}


final_df <- final_df %>%
  mutate(HR = 'HR (95% CI)')

final_df <- final_df %>%
  mutate(Count = 'Total / Events')


final_df <- final_df %>%
  mutate(HR_Text = sprintf("%.2f (%.2f, %.2f)", `Estimate`, `Lower CI`, `Upper CI`))
final_df$HR_Text <- as.character(final_df$HR_Text)

final_df$events <- paste(final_df$Total_Length, "/", final_df$RA_Incidents)
final_df$events <- as.character(final_df$events)

final_df <- final_df %>%
  mutate(
    heterogeneity = sprintf("Heterogeneity: italic(X^2)[%d] == %.2f (italic(p) == %.2f)", 
                            as.numeric(df), as.numeric(x_chi), as.numeric(p_value))
  )
  

# Reconstructing the original plot with adjusted geom_text and coord_cartesian
xbreaks <- c(0.3,0.5, 0.75, 1, 1.5,2,6)  # Include 2 in the breaks
xlim_scale <- 1
visible_xlims <- c(min(xbreaks), max(xbreaks))  # Visible x-axis limits
full_xlims <- c(min(xbreaks)*3, max(xbreaks)*1.2)  # Full x-axis limits including space for text
xlims <- c(min(xbreaks), max(xbreaks) * 1.2)


lim_rad_scale <- 1/min(final_df$std_error) + 1

# Define plot with adjusted x-axis limits and margins
forest_plot <- ggplot(final_df, aes(x = Estimate, y = model, xmin = `Lower CI`, xmax = `Upper CI`)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(height = 0)) +
  geom_point(aes(size = 1/std_error), shape = 15, colour = "black", fill = "black", stroke = 0.5) +
  facet_grid(group ~ ., scales = "free", space = "free") +
  scale_radius(guide = "none", limits = c(0, lim_rad_scale), range = c(2, 6)) +
  labs(x = "Hazard Ratio (95% CI)", y = "") +
  scale_x_continuous(trans = "log", breaks = xbreaks * xlim_scale, limits = visible_xlims) +
  theme_classic() +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    panel.spacing = unit(5, "lines"),
    panel.spacing.y = unit(2, "lines"),
    plot.margin = margin(20, 10,10, 10, "points")) +
  ylab(NULL) +
  coord_cartesian(clip = "off") 
  #coord_cartesian(xlim = c(min(xbreaks), max(xbreaks)), clip = 'off')# Adjust right margin to create space for text

# Add HR_text using geom_text
forest_plot <- forest_plot + 
  ##HR column - contents
  geom_text(aes(y = model, x = 3.2, label = paste0(HR_Text)), 
            hjust = -0.2, vjust = 0, size = 3.7, color = "black") +
  ##HR column - label bolded at top 
  geom_text(aes(y = model, x = 3.6, 
                label = ifelse(model == "Male", HR, NA)),
            hjust = 0, vjust = -1.8, size = 3.7, color = "black",fontface="bold", 
            parse = FALSE, check_overlap = TRUE)+
  
  ##events  - content 
  geom_text(aes(y = model, x = 2.2, label = paste0(events)),
            hjust = 0, vjust = 0, size = 3.7, color = "black")+
  #events - title bolded 
    geom_text(aes(y = model, x = 2.2, 
                label = ifelse(model == "Male", Count, NA)),
            hjust = 0.05, vjust = -1.8, size = 3.7, color = "black",fontface="bold", 
            parse = FALSE, check_overlap = TRUE)+
  
  ##Model names
  geom_text(aes(y = model, x = 0.4, label = paste0(model)),
            hjust = 0, vjust = 0, size = 3.7, color = "black")+
  #Model titles in bold
  geom_text(aes(y = model, x = 0.33, 
                label = ifelse(model %in% c("Male", "40-49","<25" ), as.character(group), NA)),
            hjust = 0, vjust = -1.8, size = 3.7, color = "black", fontface="bold",
            parse = FALSE)+
  
  
  ##heterogeneity label 
  geom_text(aes(y = model, x = 3.2, 
                label = ifelse(model %in% c("30+", "70-79", "Female"), heterogeneity, NA)),
            hjust = 0, vjust = 1.2, size = 3.7, color = "black",
            parse = TRUE, check_overlap = TRUE) 

  
  



 

print(forest_plot)
# Display the plot





```

Total dataframe 
```{r}

sub_BMI_df$Estimate <- as.character(sub_BMI_df$Estimate)

sub_BMI_df <- sub_BMI_df %>%
  mutate(across(everything(), as.character))
sub_age_df <- sub_age_df %>%
  mutate(across(everything(), as.character))
sub_sex_df <- sub_sex_df %>%
  mutate(across(everything(), as.character))

# Do the same for sub_sex_df and sub_age_df if they have the same issue
sub_BMI_df <- sub_BMI_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_age_df <- sub_age_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

sub_sex_df <- sub_sex_df %>%
  mutate(
    Total_Length = as.integer(Total_Length),
    RA_Incidents = as.integer(RA_Incidents)
  )

# Assuming 'model' is the common column in all three dataframes and you want to join by this column
final_df <- bind_rows(sub_BMI_df, sub_sex_df, sub_age_df)

# View the final combined dataframe
print(final_df)

as.factor(final_df$model)


final_df <- final_df %>%
  mutate(
    `Lower CI` = as.numeric(`Lower CI`),
    Estimate = as.numeric(Estimate),
    `Upper CI` = as.numeric(`Upper CI`),
    `x_chi` = as.numeric(`x_chi`),
    `p_value` = as.numeric(`p_value`)
  )

final_df <- final_df %>%
  mutate(std_error = as.numeric(as.character(std_error)))

age_levels_ordered <- c("40-49","50-59","60-69","70-79" )
bmi_levels_ordered <- c("BMI: <25","BMI: 25 - 30","BMI: >30")

# Apply the ordering to the 'model' column
final_df$model <- factor(final_df$model, levels = c(bmi_levels_ordered, "Female", "Male", age_levels_ordered))

#Relabel
levels(final_df$model)[levels(final_df$model) == "BMI: <25"] <- "<25"
levels(final_df$model)[levels(final_df$model) == "BMI: 25 - 30"] <- "25-29.9"
levels(final_df$model)[levels(final_df$model) == "BMI: >30"] <- "30+"

final_df <- final_df %>%
  distinct(model, .keep_all = TRUE) %>%
  mutate(y_position = 1:n())  # Create a y-position for each group label

#degrees of freedom for plots
final_df <- final_df %>%
  mutate(df = case_when(
    group == "BMI" ~ 3,
    group == "Sex" ~ 2,
    group == "Age" ~ 4,
    TRUE ~ NA_integer_  # For any group not covered above, NA is assigned (or you can assign another default value)
  ))

final_df <- final_df %>%
  mutate(group = case_when(
    group == "BMI" ~ "BMI (categories)",
    group == "Age" ~ "Age (categories)",
    TRUE ~ group  # Keeps all other values as they are
  ))

final_df <- bind_rows(Overall, final_df)


final_df$model <- factor(final_df$model, levels = c("Female","Male","70-79","60-69","50-59", "40-49","30+", "25-29.9", "<25",  "Overall"))
final_df$group <- factor(final_df$group, levels = c("Sex","Age (categories)","BMI (categories)",  "Overall"))



# Print out the updated dataframe
print(final_df)

```




Per 1SD 
```{r}


final_df <- final_df %>%
  mutate(HR = 'HR (95% CI)')

final_df <- final_df %>%
  mutate(Count = 'Total / Events')


final_df <- final_df %>%
  mutate(HR_Text = sprintf("%.2f (%.2f, %.2f)", `Estimate`, `Lower CI`, `Upper CI`))
final_df$HR_Text <- as.character(final_df$HR_Text)

final_df$events <- paste(final_df$Total_Length, "/", final_df$RA_Incidents)
final_df$events <- as.character(final_df$events)


final_df <- final_df %>%
  mutate(
    heterogeneity = sprintf("Heterogeneity: italic(X^2)[%d] == %.2f (italic(p) == %.2f)", 
                            as.numeric(df), as.numeric(x_chi), as.numeric(p_value))
  )
  

# Reconstructing the original plot with adjusted geom_text and coord_cartesian
xbreaks <- c(0.3,0.5, 0.75, 1, 1.5,2,6)  # Include 2 in the breaks
xlim_scale <- 1
visible_xlims <- c(min(xbreaks), max(xbreaks))  # Visible x-axis limits
full_xlims <- c(min(xbreaks)*3, max(xbreaks)*1.2)  # Full x-axis limits including space for text
xlims <- c(min(xbreaks), max(xbreaks) * 1.2)


lim_rad_scale <- 1/min(final_df$std_error) + 1

# Define plot with adjusted x-axis limits and margins
forest_plot <- ggplot(final_df, aes(x = Estimate, y = model, xmin = `Lower CI`, xmax = `Upper CI`)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(height = 0)) +
  geom_point(aes(size = 1/std_error), shape = 15, colour = "black", fill = "black", stroke = 0.5) +
  facet_grid(group ~ ., scales = "free", space = "free") +
  scale_radius(guide = "none", limits = c(0, lim_rad_scale), range = c(2, 6)) +
  labs(x = "Hazard Ratio (95% CI) per 1 SD \nincrease in steps (3811 steps)", y = "") +
  scale_x_continuous(trans = "log", breaks = xbreaks * xlim_scale, limits = visible_xlims) +
  theme_classic() +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    panel.spacing = unit(2, "lines"),
    panel.spacing.y = unit(2, "lines"),
    plot.margin = margin(20, 10,10, 10, "points")) +
  ylab(NULL) +
  coord_cartesian(clip = "off") 
  #coord_cartesian(xlim = c(min(xbreaks), max(xbreaks)), clip = 'off')# Adjust right margin to create space for text


# Add HR_text using geom_text
forest_plot <- forest_plot + 
  ##HR column - contents
  geom_text(aes(y = model, x = 3.2, label = paste0(HR_Text)), 
            hjust = -0.2, vjust = 0, size = 3.7, color = "black") +
  ##HR column - label bolded at top 
  geom_text(aes(y = model, x = 3.6, 
                label = ifelse(model == "Male", HR, NA)),
            hjust = 0, vjust = -1.8, size = 3.7, color = "black",fontface="bold", 
            parse = FALSE, check_overlap = TRUE)+
  
  ##events  - content 
  geom_text(aes(y = model, x = 2.2, label = paste0(events)),
            hjust = 0, vjust = 0, size = 3.7, color = "black")+
  #events - title bolded 
    geom_text(aes(y = model, x = 2.2, 
                label = ifelse(model == "Male", Count, NA)),
            hjust = 0.05, vjust = -1.8, size = 3.7, color = "black",fontface="bold", 
            parse = FALSE, check_overlap = TRUE)+
  
  ##Model names
  geom_text(aes(y = model, x = 0.4, label = paste0(model)),
            hjust = 0, vjust = 0, size = 3.7, color = "black")+
  #Model titles in bold
  geom_text(aes(y = model, x = 0.33, 
                label = ifelse(model %in% c("Male", "40-49","<25" ), as.character(group), NA)),
            hjust = 0, vjust = -1.8, size = 3.7, color = "black", fontface="bold",
            parse = FALSE)+
  
  
  ##heterogeneity label 
  geom_text(aes(y = model, x = 3.2, 
                label = ifelse(model %in% c("30+", "70-79", "Female"), heterogeneity, NA)),
            hjust = 0, vjust = 1.2, size = 3.7, color = "black",
            parse = TRUE, check_overlap = TRUE) 


print(forest_plot)
# Display the plot

```

Per 1000 step increase 
```{r}


final_df <- final_df %>%
  mutate(HR = 'HR (95% CI)')

final_df <- final_df %>%
  mutate(Count = 'Total / Events')


final_df <- final_df %>%
  mutate(HR_Text = sprintf("%.2f (%.2f, %.2f)", `Estimate`, `Lower CI`, `Upper CI`))
final_df$HR_Text <- as.character(final_df$HR_Text)

final_df$events <- paste(final_df$Total_Length, "/", final_df$RA_Incidents)
final_df$events <- as.character(final_df$events)


final_df <- final_df %>%
  mutate(
    heterogeneity = sprintf("Heterogeneity: italic(X^2)[%d] == %.2f (italic(p) == %.2f)", 
                            as.numeric(df), as.numeric(x_chi), as.numeric(p_value))
  )
  

# Reconstructing the original plot with adjusted geom_text and coord_cartesian
xbreaks <- c(0.3,0.5, 0.75, 1, 1.5,2,3)  # Include 2 in the breaks
xlim_scale <- 1
visible_xlims <- c(min(xbreaks), max(xbreaks))  # Visible x-axis limits
full_xlims <- c(min(xbreaks)*3, max(xbreaks)*1.2)  # Full x-axis limits including space for text
xlims <- c(min(xbreaks), max(xbreaks) * 1.2)


lim_rad_scale <- 1/min(final_df$std_error) + 1

# Define plot with adjusted x-axis limits and margins
forest_plot <- ggplot(final_df, aes(x = Estimate, y = model, xmin = `Lower CI`, xmax = `Upper CI`)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(height = 0)) +
  geom_point(aes(size = 0.7/std_error), shape = 15, colour = "black", fill = "black", stroke = 0.5) +
  facet_grid(group ~ ., scales = "free", space = "free") +
  scale_radius(guide = "none", limits = c(0, lim_rad_scale), range = c(2, 6)) +
  labs(x = "Hazard Ratio (95% CI) per \n1000 steps increase", y = "") +
  scale_x_continuous(trans = "log", breaks = xbreaks * xlim_scale, limits = visible_xlims) +
  theme_classic() +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.title.x = element_text(size = 10, face="bold"),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    panel.spacing = unit(2, "lines"),
    panel.spacing.y = unit(2, "lines"),
    plot.margin = margin(7, 3,3, 3, "points")) +
  ylab(NULL) +
  coord_cartesian(clip = "off") 
  #coord_cartesian(xlim = c(min(xbreaks), max(xbreaks)), clip = 'off')# Adjust right margin to create space for text


# Add HR_text using geom_text
forest_plot <- forest_plot + 
  ##HR column - contents
  geom_text(aes(y = model, x = 1.35, label = paste0(HR_Text)), 
            hjust = -0.2, vjust = 0.55, size = 3, color = "black") +
  ##HR column - label bolded at top 
  geom_text(aes(y = model, x = 1.45, 
                label = ifelse(model == "Male", HR, NA)),
            hjust = 0, vjust = -1.2, size = 3, color = "black",fontface="bold", 
            parse = FALSE, check_overlap = TRUE)+
  
  ##events  - content 
  geom_text(aes(y = model, x = 0.5, label = paste0(events)),
            hjust = 0, vjust = 0.55, size = 3, color = "black")+
  #events - title bolded 
    geom_text(aes(y = model, x = 0.5, 
                label = ifelse(model == "Male", Count, NA)),
            hjust = 0.05, vjust = -1.2, size = 3, color = "black",fontface="bold", 
            parse = FALSE, check_overlap = TRUE)+
  
  ##Model names
  geom_text(aes(y = model, x = 0.35, label = paste0(model)),
            hjust = 0, vjust = 0.55, size = 3, color = "black")+
  #Model titles in bold
  geom_text(aes(y = model, x = 0.3, 
                label = ifelse(model %in% c("Male", "40-49","<25" ), as.character(group), NA)),
            hjust = 0, vjust = -1.2, size = 3, color = "black", fontface="bold",
            parse = FALSE)+
  
  
  ##heterogeneity label 
  geom_text(aes(y = model, x = 1.35, 
                label = ifelse(model %in% c("30+", "70-79", "Female"), heterogeneity, NA)),
            hjust = 0, vjust = 1.4, size = 3, color = "black",
            parse = TRUE, check_overlap = TRUE) 


print(forest_plot)
# Display the plot

```

```{r}

output_file <- file.path(output_dir, "forest.tiff")
ggsave(output_file, forest_plot, device = "tiff", width = 6, height = 4, dpi = 300)
```

```{r}
# Define plot with adjusted x-axis limits and margins
forest_plot <- ggplot(final_df, aes(x = Estimate, y = model, xmin = `Lower CI`, xmax = `Upper CI`)) +
  geom_point(size = 2) +
  geom_errorbarh(aes(height = 0)) +
  geom_point(aes(size = 1/std_error), shape = 15, colour = "black", fill = "black", stroke = 0.5) +
  facet_grid(group ~ ., scales = "free", space = "free") +
  scale_radius(guide = "none", limits = c(0, lim_rad_scale), range = c(2, 6)) +
  labs(x = "Hazard Ratio (95% CI)", y = "") +
  scale_x_continuous(trans = "log", breaks = xbreaks * xlim_scale, limits = full_xlims) +
  theme_classic() +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    panel.spacing.y = unit(2, "lines"),
    plot.margin = margin(10, 10, 0, 0, "points")) +
  ylab(NULL)

# Add HR_text and events using geom_text
forest_plot <- forest_plot + 
  geom_text(aes(y = model, x = 1.75, label = HR_Text), 
            hjust = -0.2, vjust = 0, size = 3, color = "black") +
  geom_text(aes(y = model, x = exp(log(0.5) - 0.2), label = events),  # Adjusting position for log scale
            hjust = 1, vjust = 0, size = 3, color = "black") 

# Display the plot
print(forest_plot)

```




```{r}
dir.create("plots")
output_dir <- "plots"
output_file <- file.path(output_dir, "subgroup.tiff")
ggsave(output_file, combined_plot, device = "tiff", width = 10, height = 7, dpi = 300)
```
```

```{r}
dir.create("plots")
output_dir <- "plots"
output_file <- file.path(output_dir, "ForestPlot.tiff")
ggsave(output_file, combined_plot_groups, device = "tiff", width = 10, height = 8, dpi = 300)
```





```{r}

library("multcomp", "foreign", "biostat3")
cox_BMI_cad <- coxph((Surv(age_entry_days, age_exit_days, RA_incident)) ~ 
                           cad30_std*BMI_cats+ strata(sex)+
                           as.factor(ethnicity) + as.factor(tdi_quarters) +as.factor(qualif)+
                           as.factor(season_wear) + as.factor(smoking) + as.factor(alcohol)+as.factor(processed_meat)+as.factor(fresh_fruit)+as.factor(oily_fish),
                         data=dat)

summary(cox_BMI_cad)


subgroup_BMI_cad <- lincom(cox_BMI_cad, c("cad30_std",
                          "cad30_std+cad30_std:BMI_cats25.0-29.9",
                          "cad30_std+cad30_std:BMI_cats30.0+"),
       eform=TRUE)
subgroup_BMI_cad


```


Subset based on PRS risk 
```{r}
datLow <- dat %>%
  filter(PRS_RA_RiskGroup == "Low")
datInter <- dat %>%
  filter(PRS_RA_RiskGroup == "Intermediate")
datHigh <- dat %>%
  filter(PRS_RA_RiskGroup == "High")

```

Low risk group first 
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std,
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(qualif) + factor(smoking) + factor(alcohol) +factor(red_processed_total)+factor(fruit_veg_total),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(qualif) + factor(smoking) + factor(alcohol) +factor(red_processed_total)+factor(fruit_veg_total)+ factor(BMI_cats),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfLow <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfLow, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsLow.csv")), row.names=FALSE)
```


Intermediate risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std,
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(red_processed_total)+factor(fruit_veg_total),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(qualif) + factor(smoking) + factor(alcohol) +  factor(red_processed_total)+factor(fruit_veg_total)+ factor(BMI_cats),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfInter <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfInter, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsInter.csv")), row.names=FALSE)
```

High risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std,
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_std + strata(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(oily_fish)+factor(processed_meat)+factor(fresh_fruit)+ factor(BMI_cats),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfHigh <- merged_steps_df  

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfHigh, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsHigh.csv")), row.names=FALSE)
```


Sensitivity analysis of those 2 years post 

Done in this script not the previous to ensure reference values behave (easy to fix by relevelling otherwise).

```{r}
dat2yr$step_fifths <- qtile_cut(dat2yr$med_steps, probs = seq(0, 1, by = 0.2))
dat2yr$acc_fifths <- qtile_cut(dat2yr$overall_activity, probs = seq(0, 1, by = 0.2), dp_label = 1)
dat2yr$tdi_quarters <- qtile_cut(dat2yr$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat2yr$age_gp_crude <- cut(dat2yr$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat2yr$BMI_cats <-
  cut(dat2yr$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<18.5-24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```

Get population level sd of steps and then subset data down to PRS risk groups 

```{r}

################Cox models
# Calc sd steps
sd(dat2yr$med_steps) #3815.4
# Generate a standardization variable
dat2yr$med_steps_standardization = (dat2yr$med_steps - mean(dat2yr$med_steps))/sd(dat2yr$med_steps)
# Check distribution of variable
hist(dat2yr$med_steps_standardization)

```


Subset based on PRS risk 
```{r}
datLow <- dat2yr %>%
  filter(PRS_RA_RiskGroup == "Low")
datInter <- dat2yr %>%
  filter(PRS_RA_RiskGroup == "Intermediate")
datHigh <- dat2yr %>%
  filter(PRS_RA_RiskGroup == "High")

```

Low risk group first 
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization,
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(BMI_cats),
    data = datLow
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfLow <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfLow, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsLow2yr.csv")), row.names=FALSE)
```


Intermediate risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization,
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(BMI_cats),
    data = datInter
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfInter <- merged_steps_df

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfInter, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsInter2yr.csv")), row.names=FALSE)
```

High risk group  
```{r}
#########Steps - SD
### Define outcomes for loop

# Create an empty data frame to store the results
merged_steps_df <- data.frame()

# Loop over the variables

  ############################################# Model 1: Unadjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization,
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Unadjusted model"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat)
  ############################################# Model 2: Fully-adjusted
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and model
  res_dat2 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully-adjusted"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )

  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat2)

 ############################################# Model 3: Fully adjusted + bmi
  # Cox regression model ==================
  model <- coxph(
    Surv(age_entry_days, age_exit_days, RA_incident) ~ med_steps_standardization + factor(sex) + factor(ethnicity) + factor(tdi_quarters) + factor(season_wear)+ factor(qualif) + factor(smoking) + factor(alcohol) + factor(BMI_cats),
    data = datHigh
  )
  res <- summary(model)
  
  # Extraction
  aic <- AIC(model)
  rr <- res$coefficients[1:1, 1]
  uci <- exp(rr + qnorm(0.975) * res$coefficients[1:1, 3])
  lci <- exp(rr - qnorm(0.975) * res$coefficients[1:1, 3])
  p <- res$coefficients[1:1, 5]

  # Create a data frame for the current variable and mode
  res_dat3 <- data.frame(
    Outcome= c("RA_incident"),
    Model = c("Fully adjusted + bmi"),
    `HR (95% CI)` = c("REF", paste0(round(exp(rr), 2), " (", round(lci, 2), " - ", round(uci, 2), ")")),
    `P trend` = c(round(p, 4)),
    AIC = c(round(aic, 2))
  )
  # Append the current data frame to the merged data frame
  merged_steps_df <- rbind(merged_steps_df, res_dat3)
  merged_steps_dfHigh <- merged_steps_df  

  
# Print the merged data frame
# View(merged_steps_df)

#Save step sd results
write.csv(merged_steps_dfHigh, file=here::here("PRSbyGroup", paste0("steps_sdmodelresultsHigh2yr.csv")), row.names=FALSE)
```



