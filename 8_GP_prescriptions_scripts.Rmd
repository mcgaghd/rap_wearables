---
title: "8_GP_prescriptions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "R Notebook"
output: rmarkdown::github_document
---

# Further data preparation in R 
testing

## Introduction

In this notebook, we will prepare data for analysis.

Extract GP data 


## How to run this notebook

This notebook should be run in a *RStudio* session. It does *not* require a Spark cluster. See how to set it up [here](https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/using-rstudio-on-the-research-analysis-platform).

## Set up the session

We load packages we'll use:

```{r, include=FALSE}
# First we need to install packages that aren't already present
pkgs <- c("data.table", "plyr", "dplyr","stringr") # packages we need
pkgs_inst <- pkgs[!{pkgs %in% rownames(installed.packages())}] # check which are not present 
install.packages(pkgs_inst, repos = "https://www.stats.bris.ac.uk/R/") # install

# Load packages
lapply(pkgs, library, character.only = TRUE) # using lapply just allows us to load several packages on one line - this could be replaced with several calls to library()
```

dx download - downloads stored permanent storage RAP data into my temporary session
Needs bash to run 
```{bash}
cd ~/rap_wearables

dx download /users/mcgaghd/Data/scripts_wacc_data.csv -r
```

```{r}
dat_scripts <- fread("~/rap_wearables/scripts_wacc_data.csv", data.table = FALSE)
```

##csDMARDs first 

###Methotrexate 
```{r}
methotrexate <- dat_scripts %>% 
  filter(grepl("methotrexate|metoject", drug_name, ignore.case = TRUE))
```

Metoject
```{r}
metoject <- dat_scripts %>% 
  filter(grepl("Metoject", drug_name, ignore.case = TRUE))
```


Summary total on methotrexate 
```{r}
eid_summary <- methotrexate %>%
  group_by(eid) %>%
  summarise(count = n())
```


###Sulfasalazine
```{r}
sulfasalazine <- dat_scripts %>% 
  filter(grepl("Sulfasalazine|sulphasalazine|salazopyrin", drug_name, ignore.case = TRUE))
```

```{r}
eid_summary <- sulfasalazine %>%
  group_by(eid) %>%
  summarise(count = n())
```

##Leflunomide
```{r}
leflunomide <- dat_scripts %>% 
  filter(grepl("leflunomide", drug_name, ignore.case = TRUE))
```

###Ciclosporin 
```{r}
ciclosporin <- dat_scripts %>% 
  filter(grepl("Ciclosporin|Capimune|deximune", drug_name, ignore.case = TRUE))
```

###Azathioprine 
```{r}
azathioprine <- dat_scripts %>% 
  filter(grepl("azathioprine|Imuran", drug_name, ignore.case = TRUE))
```

###hydroxychloroquine
```{r}
hydroxychloroquine <- dat_scripts %>% 
  filter(grepl("hydroxychloroquine|Plaquenil", drug_name, ignore.case = TRUE))
```

##biologic DMARDs

###anti-TNF agents 
```{r}
antiTNF <- dat_scripts %>% 
  filter(grepl("humira|adalimumab|etanercept|Enbrel|infliximab|golimumab|certolizumab|INFLECTRA|secukinumab|ustekinumab ", drug_name, ignore.case = TRUE))
```

##Corticosteroids

###oral steroids
```{r}
OralSteroids <- dat_scripts %>% 
  filter(
    grepl("Cortisone|hydrocortisone|prednisolone|Prednisone|Prednesol|Dexamethasone|Budesonide|Betamethasone|Millipred|Dexasone|Orapred|prelone|depopred", drug_name, ignore.case = TRUE) &
      !grepl("vial|inj|subcutan|intramusc", drug_name, ignore.case = TRUE) &  #Remove injection
    !grepl("oint|ointment|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray|Lidocaine|solution|drop|mousse|lot|scalp|inhaler|gel|inh|Turbohaler|canister|drp|plaster", drug_name, ignore.case = TRUE) #remove topical
  )
```

```{r}
InjectedSteroids <- dat_scripts %>% 
  filter(
    grepl("Cortisone|hydrocortisone|prednisolone|Prednisone|Prednesol|Dexamethasone|Millipred|Dexasone|prelone|depopred", drug_name, ignore.case = TRUE) &
      !grepl("tab|tablet|capsule|lozenge", drug_name, ignore.case = TRUE) &  #Remove oral
    !grepl("oint|ointment|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray|drop|scalp|mousse|lot|inhaler|gel|inh|Turbohaler|canister|drp|plaster", drug_name, ignore.case = TRUE) #remove topical
  ) 
```

```{r}
drug_summary <- InjectedSteroids %>%
  group_by(drug_name) %>%
  summarise(count = n())
```

```{r}
hydrocortisone <- dat_scripts %>% 
  filter(
    grepl("|Dexamethasone", drug_name, ignore.case = TRUE) &
    !grepl("oint|ointment|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray", drug_name, ignore.case = TRUE) 
  )
```

```{r}
drug_summary <- hydrocortisone %>%
  group_by(drug_name) %>%
  summarise(count = n())
```

```{r}
opiates <- dat_scripts %>% 
  filter(
    grepl("tramadol|codeine|co-codamol", drug_name, ignore.case = TRUE) &
    !grepl("oint|ointment|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray", drug_name, ignore.case = TRUE) 
  )
```

```{r}
drug_summary <- opiates %>%
  group_by(drug_name) %>%
  summarise(count = n())
```


