---
title: "8_GP_prescriptions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "R Notebook"
output: rmarkdown::github_document
---

# Further data preparation in R 
testing

## Introduction

In this notebook, we will prepare data for analysis.

Extract GP data 


## How to run this notebook

This notebook should be run in a *RStudio* session. It does *not* require a Spark cluster. See how to set it up [here](https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/using-rstudio-on-the-research-analysis-platform).

## Set up the session

We load packages we'll use:

```{r, include=FALSE}
# First we need to install packages that aren't already present
pkgs <- c("data.table", "plyr", "dplyr","stringr") # packages we need
pkgs_inst <- pkgs[!{pkgs %in% rownames(installed.packages())}] # check which are not present 
install.packages(pkgs_inst, repos = "https://www.stats.bris.ac.uk/R/") # install

# Load packages
lapply(pkgs, library, character.only = TRUE) # using lapply just allows us to load several packages on one line - this could be replaced with several calls to library()
```

dx download - downloads stored permanent storage RAP data into my temporary session
Needs bash to run 
```{bash}
cd ~/rap_wearables

dx download /users/mcgaghd/Data/scripts_wacc_data.csv -r
```

```{r}
dat_scripts <- fread("~/rap_wearables/scripts_wacc_data.csv", data.table = FALSE)
```

##csDMARDs first 

###Methotrexate 
```{r}
methotrexate <- dat_scripts %>% 
  filter(grepl("methotrexate|metoject", drug_name, ignore.case = TRUE))
```

Metoject
```{r}
metoject <- dat_scripts %>% 
  filter(grepl("Metoject", drug_name, ignore.case = TRUE))
```


Summary total on methotrexate 
```{r}
eid_summary <- methotrexate %>%
  group_by(eid) %>%
  summarise(count = n())
```


###Sulfasalazine
```{r}
sulfasalazine <- dat_scripts %>% 
  filter(grepl("Sulfasalazine|sulphasalazine|salazopyrin", drug_name, ignore.case = TRUE))
```

```{r}
eid_summary <- sulfasalazine %>%
  group_by(eid) %>%
  summarise(count = n())
```

##Leflunomide
```{r}
leflunomide <- dat_scripts %>% 
  filter(grepl("leflunomide", drug_name, ignore.case = TRUE))
```

###Ciclosporin 
```{r}
ciclosporin <- dat_scripts %>% 
  filter(grepl("Ciclosporin|Capimune|deximune", drug_name, ignore.case = TRUE))
```

###Azathioprine 
```{r}
azathioprine <- dat_scripts %>% 
  filter(grepl("azathioprine|Imuran", drug_name, ignore.case = TRUE))
```

###hydroxychloroquine
```{r}
hydroxychloroquine <- dat_scripts %>% 
  filter(grepl("hydroxychloroquine|Plaquenil", drug_name, ignore.case = TRUE))
```

##biologic DMARDs

###anti-TNF agents 
```{r}
antiTNF <- dat_scripts %>% 
  filter(grepl("humira|adalimumab|etanercept|Enbrel|infliximab|golimumab|certolizumab|INFLECTRA|secukinumab|ustekinumab ", drug_name, ignore.case = TRUE))
```

##Corticosteroids

###oral steroids

##https://datacompass.lshtm.ac.uk/id/eprint/2799/1/corticosteroids_aurum_feb21.txt Pulled from LSHTM
```{r}
OralSteroids <- dat_scripts %>% 
  filter(
    grepl("Cortisone|hydrocortisone|prednisolone|Prednisone|Prednesol|Dexamethasone|Budesonide|Betamethasone|Millipred|Dexasone|Orapred|prelone|depopred|decadron|cortisyl|deltastab|triamcinolone|cortelan|deltastab|efcortelan|cortistab|deflazacort|adcortyl|hydrocortone|kenalog|deltacortril|medrone|hydrocortistab|betnesol|lederspan|triamcinolone|lodotra|plenadren|pevanti|dilacort |glensoludex|neofordex|alkindi|hydventia", drug_name, ignore.case = TRUE) &
      !grepl("vial|inj|subcutan|intramusc", drug_name, ignore.case = TRUE) &  #Remove injection
    !grepl("oint|ointment|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray|Lidocaine|solution|drop|mousse|lot|paste|Calcipotriol|scalp|inhaler|Fludrocortisone|gel|inh|Turbohaler|canister|drp|plaster", drug_name, ignore.case = TRUE) #remove topical
  )
```

```{r}
InjectedSteroids <- dat_scripts %>% 
  filter(
    grepl("Cortisone|hydrocortisone|prednisolone|Prednisone|Prednesol|Dexamethasone|Millipred|Dexasone|prelone|depopred|decadron", drug_name, ignore.case = TRUE) &
      !grepl("tab|tablet|capsule|lozenge", drug_name, ignore.case = TRUE) &  #Remove oral
    !grepl("oint|ointment|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray|drop|scalp|mousse|lot|inhaler|gel|inh|Turbohaler|canister|drp|plaster", drug_name, ignore.case = TRUE) #remove topical
  ) 
```

```{r}
drug_summary <- OralSteroids %>%
  group_by(drug_name) %>%
  summarise(count = n())
```

```{r}
drug_summary <- hydrocortisone %>%
  group_by(drug_name) %>%
  summarise(count = n())
```

```{r}
MildOpiates <- dat_scripts %>% 
  filter(
    grepl("tramadol|codeine|co-codamol|Dextropropoxyphene|Pethidine|Df118|Zydol|Pentazocine|Tramacet|fortral", drug_name, ignore.case = TRUE) &
    !grepl("oint|ointment|injection|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray", drug_name, ignore.case = TRUE) 
  )
```

```{r}
ModerateOpiates <- dat_scripts %>% 
  filter(
    grepl("Morphine|MST contin|Oramorph|Sevredol|Oxycodone|OxyContin|Buprenorphine|BuTrans|Pethidine|Tapentadol|Meptazinol|Meptazinol|Meptid|Transtec|DHC Continus|oxynorm", drug_name, ignore.case = TRUE) &
    !grepl("oint|ointment|eye|foam|Enema|ear|supp|cream|crm|oin|cre|lotion|topical|spray", drug_name, ignore.case = TRUE) 
  )
```

```{r}
HighOpiates <- dat_scripts %>% 
  filter(
    grepl("Fentanyl|Durogesic|Hydromorphone|Palfium|Dextromoramide|Cyclimorph|Palladone|MXL Capsules|Papaveretum", drug_name, ignore.case = TRUE) &
    !grepl("oint|ointment|eye|foam|Enema|ear|supp|cream|crm|oin|cre|lotion|topical|spray", drug_name, ignore.case = TRUE) 
  )
```

##NSAIDs

```{r}
NSAIDs <- dat_scripts %>% 
  filter(
    grepl("Ibuprofen|Diclofenac Sodium|Naproxen|Piroxicam|Indometacin| Mefenamic Acid|Acemetacin|Ketoprofen|Celecoxib|Aceclofenac|Etoricoxib|Meloxicam|Flurbiprofen|Tiaprofenic Acid|Sulindac|Tenoxicam|Nabumetone|Etodolac|Dexketoprofen|Fenoprofen|Diclofenac Potassium|Dexibuprofen", drug_name, ignore.case = TRUE) &
    !grepl("oint|ointment|eye|foam|Enema|ear|supp|cream|crm|oin|cre|lotion|topical|gel|jel|spray", drug_name, ignore.case = TRUE) 
  )
```



```{r}
Demerol <- dat_scripts %>% 
  filter(
    grepl("Demerol", drug_name, ignore.case = TRUE) &
    !grepl("oint|injection|ointment|eye|foam|Enema|suppository|ear|supposi|supp|cream|crm|oin|cre|lotion|topical|spray", drug_name, ignore.case = TRUE) 
  )
```
 

```{r}
drug_summary <- NSAIDs %>%
  group_by(drug_name) %>%
  summarise(count = n())
```




