---
title: "d_analyse_data"
format: html
editor: visual
---

## Load data
```{r}
library(data.table)
library(plyr)
library(dplyr)
library(magrittr) 
library(lubridate)
library(readr) 
library(survival)
library(Epi)
#library(emmeans)
library(ggplot2)
#library(survminer)
#library(ckbplotr)
```

## Set-up useful functions

```{r}
source("rounding_functions.R")
source("cut_by_quantile.R")
source("cox_functions.R")
```


```{r}
dat_whole <- dat_whole %>%
  select(eid, MET_tertiles_local)
```

Data:

```{bash}
cd ~/rap_wearables


dx download /users/mcgaghd/PsAfinal/FinalCohorts/Accelerometer -r
```

```{r}
dat <- fread("Accelerometer_PsA_final_inPsO.csv", data.table = FALSE)
#dat <- fread("Accelerometer_PsA_final_wholeCohort.csv", data.table = FALSE)


dat$V1 <- NULL

```

```{r}
dat <- dat %>%
  left_join(dat_whole %>% select(eid, MET_tertiles_local), by = "eid")
```


```{bash}
dx download /users/mcgaghd/PrimaryCare/dat_GPlist.csv -r
```

```{r}
dat_GPlist <- fread("PrimaryCare/dat_GPlist.csv", data.table = FALSE)
# Step 1: Filter dat to only keep those with a GP record linkage (eids present in dat_GPlist)
filtered_dat <- dat %>%
  filter(eid %in% dat_GPlist$eid)

# Step 2: Join filtered_dat with dat_GPlist to include the data_provider information
dat <- filtered_dat %>%
  left_join(dat_GPlist %>% select(eid, data_provider), by = "eid")

```

```{r}
dat <- dat %>%
  mutate(step_thirdsEqual = case_when(
    med_steps < 5000 ~ "<5000",
    med_steps >= 5000 & med_steps <= 10000 ~ "5000-10000",
    med_steps > 10000 ~ ">10000"
  ))

dat$step_thirds <- qtile_cut(dat$med_steps, probs = seq(0, 1, by = 1/3), dp_label = 1)
dat$step_quartiles <- qtile_cut(dat$med_steps, probs = seq(0, 1, by = 1/4), dp_label = 1)
dat$step_quintiles <- qtile_cut(dat$med_steps, probs = seq(0, 1, by = 1/5), dp_label = 1)

dat$acc_thirds <- qtile_cut(dat$overall_activity, probs = seq(0, 1, by = 1/3), dp_label = 1)
dat$tdi_quarters <- qtile_cut(dat$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat$cadence1_thirds <- qtile_cut(dat$`CadencePeak1Adjusted.steps.min.`, probs = seq(0,1, by=1/3))
dat$cadence30_thirds <- qtile_cut(dat$`CadencePeak30Adjusted.steps.min.`, probs = seq(0,1, by=1/3))
dat$cadence30_quintiles <- qtile_cut(dat$`CadencePeak30Adjusted.steps.min.`, probs = seq(0,1, by=1/5))

dat$cadence95_thirds <- qtile_cut(dat$`Cadence95thAdjusted(steps/min)`, probs = seq(0,1, by=1/3))
dat$age_gp_crude <- cut(dat$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat$age_2cat <- cut(dat$age_entry_years, seq(40, 80, by = 20), right = FALSE, labels = c("40-59", "60-79"))
dat$BMI_cats <-
  cut(dat$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```



```{r}
primary <- "med_steps_2"
dat$med_steps_std <- standardise_column(dat[[primary]], 1000, TRUE)
hist(dat$med_steps_std)
```

SD of Cadence metrics 
```{r}
sd(dat$`CadencePeak30Adjusted(steps/min)`) #3822.266
# Generate a standardization variable
dat$Cad30_std = (dat$`CadencePeak30Adjusted(steps/min)` - mean(dat$`CadencePeak30Adjusted(steps/min)`))/sd(dat$`CadencePeak30Adjusted(steps/min)`)
# Check distribution of variable
hist(dat$Cad30_std)
```

```{r}
sd(dat$`CadencePeak1Adjusted.steps.min.`) #3822.266
# Generate a standardization variable
dat$Cad1_std = (dat$`CadencePeak1Adjusted.steps.min.` - mean(dat$`CadencePeak1Adjusted.steps.min.`))/sd(dat$`CadencePeak1Adjusted.steps.min.`)
# Check distribution of variable
hist(dat$Cad1_std)
```


```{r}
sd(dat$`Cadence95thAdjusted(steps/min)`) #3822.266
# Generate a standardization variable
dat$Cad95_std = (dat$`Cadence95thAdjusted(steps/min)` - mean(dat$`Cadence95thAdjusted(steps/min)`))/sd(dat$`Cadence95thAdjusted(steps/min)`)
# Check distribution of variable
hist(dat$Cad95_std)
```

1 year composite for pain 

```{r}
dat <- dat %>%
  mutate(
    pain_3month_Back = case_when(
      pain_3month_Back == "Yes" ~ TRUE,
      TRUE ~ FALSE
    ),
    pain_3month_Hip = case_when(
      pain_3month_Hip == "Yes" ~ TRUE,
      TRUE ~ FALSE
    ),
    pain_3month_Knee = case_when(
      pain_3month_Knee == "Yes" ~ TRUE,
      TRUE ~ FALSE
    ), 
    pain_3month_General = case_when(
      pain_3month_General== "Yes" ~ TRUE,
      TRUE ~ FALSE
  ))
  

```

```{r}

dat$total_6months <- (dat$HipPain_6months | dat$KneePain_6months | dat$BackPain_6months |dat$swelling_6months |dat$arthralgia_6months|dat$Bursitis_6months|dat$tendonitis_6months|dat$fatigue_6months|dat$myalgia_6months|dat$Stiffness_6months|dat$FingerPain_6months|dat$WristHandPain_6months|dat$FootAnkle_6months|dat$Enthesitis_6months)

dat$total_1year <- (dat$HipPain_1year | dat$KneePain_1year | dat$BackPain_1year |dat$swelling_1year|dat$arthralgia_1year|dat$Bursitis_1year|dat$tendonitis_1year|dat$fatigue_1year|dat$myalgia_1year|dat$Stiffness_1year|dat$FingerPain_1year|dat$WristHandPain_1year|dat$FootAnkle_1year|dat$Enthesitis_1year)

dat$total_2year <- (dat$HipPain_2year | dat$KneePain_2year | dat$BackPain_2year |dat$swelling_2year|dat$arthralgia_2year|dat$Bursitis_2year|dat$tendonitis_2year|dat$fatigue_2year|dat$myalgia_2year|dat$Stiffness_2year|dat$FingerPain_2year|dat$WristHandPain_2year|dat$FootAnkle_2year|dat$Enthesitis_2year)

dat$total_5year <- (dat$HipPain_5year | dat$KneePain_5year | dat$BackPain_5year |dat$swelling_5year|dat$arthralgia_5year|dat$Bursitis_5year|dat$tendonitis_5year|dat$fatigue_5year|dat$myalgia_5year|dat$Stiffness_5year|dat$FingerPain_5year|dat$WristHandPain_5year)


dat$pain_2years <- (dat$HipPain_2year | dat$KneePain_2year | dat$BackPain_2year | dat$FootAnkle_2year |dat$swelling_2year|dat$arthralgia_2year)

dat$JointPainChronic <- (dat$HipPain_5year | dat$KneePain_5year | dat$BackPain_5year|dat$FootAnkle_5years| dat$pain_3month_Back|dat$pain_3month_Hip|dat$pain_3month_General|dat$pain_3month_Knee)




#use these two and arthralgia

```

```{r}
dat_prodrome <- subset(dat, total_5year == TRUE)
dat_nilProdrome <- subset(dat, total_5year == FALSE)
```


```{r}
Full <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           (total_6months),
                          data=dat)

summary(Full)

Full <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           as.factor(dat$alcohol),
                          data=dat)

summary(Full)

symptoms <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           (Cad1_std)+as.factor(sex) +as.factor(tdi_quarters)+as.factor(qualif) + as.factor(smoking) +as.factor(alcohol),
                          data=dat_nilProdrome)

summary(symptoms)
```


```{r}
Full_withSymptoms <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           Cad95_std*total_5year +as.factor(sex) +as.factor(tdi_quarters)+as.factor(qualif) + as.factor(smoking) +as.factor(alcohol),
                          data=dat)

summary(Full_withSymptoms)

```

```{r}
Full_withSymptoms <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           (step_thirds) +as.factor(sex) +as.factor(tdi_quarters)+as.factor(qualif) + as.factor(smoking) +as.factor(alcohol),
                          data=dat)

summary(Full_withSymptoms)
cox.zph(Full_withSymptoms)
```


```{r}

#First create non-psoriatic group 
dat$NoProdomalLabel <- !dat$total_5year

#Now we want to create a new column called FactorAnalysis which the above 3 factors 
dat$AnalysisCategory <- ifelse(dat$NoProdomalLabel, 0,
                              ifelse(dat$total_5year , 1,
                                      NA))

#Set up a corresponding label to these categories 
labels2 <- c("No prodromal labels", "Prodromal")

dat$AnalysisLabel <- factor(dat$AnalysisCategory, levels = 0:1, labels = labels2)

dat <- dat %>%
  mutate(groups = case_when(
    NoProdomalLabel == TRUE ~ "No prodromal labels",
    total_5year == TRUE ~ "Prodromal",
    TRUE ~ NA_character_
  ))
```

```{r}
model_steps1 <- lm(med_steps ~ AnalysisLabel + as.factor(sex)  + as.factor(age_gp) + as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_steps1)
  confint(model_steps1)
  
emmeans_model_steps1_np<- emmeans(model_steps1, specs = "AnalysisLabel")
emmeans_model_steps1 <- emmeans(model_steps1, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_steps1_np)
summary(emmeans_model_steps1)
confint(emmeans_model_steps1)

```


```{r}
# Define the data frame for plotting
steps <- summary(emmeans_model_steps1_np, specs = "AnalysisLabel")[1:2, c(1, 2, 6, 5)]
names(steps) <- c("Quality", "Mean", "UpperCI", "LowerCI")
steps$Quality <- c("No prodromal labels", "Prodromal")
steps$Quality <- factor(steps$Quality, levels = c("No prodromal labels", "Prodromal"))
    

# Create the plot
steps_final <- ggplot() +
  geom_pointrange(data = steps, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 10100, by = 400), name = "Adjusted Mean Daily Step Count") +
  coord_cartesian(ylim = c(7000, 10100)) +
  xlab("") +
  geom_hline(yintercept = steps$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12))  # Increase caption font size

# Display the plot
print(steps_final)


# Close the TIFF graphics device
dev.off()
```


```{r}
model_steps1 <- lm(med_steps ~ AnalysisCategory + as.factor(age_gp)+as.factor(sex)+ as.factor(season_wear),  data = dat)
summary(model_steps1)
  confint(model_steps1)
  
emmeans_model_steps1_np<- emmeans(model_steps1, specs = "AnalysisCategory")
emmeans_model_steps1 <- emmeans(model_steps1, specs = pairwise~ AnalysisCategory)
summary(emmeans_model_steps1_np)
summary(emmeans_model_steps1)
confint(emmeans_model_steps1)
```


Make venn diagram for supplemental 
```{r}
library(ggvenn)
datPsO_venn <- dat[dat$Prevalent_PsO_lessPsA == TRUE, ]

datPsO_venn$'Self-report' <- datPsO_venn$self_reported_PsO
datPsO_venn$'HES coded' <- datPsO_venn$hes_prevalent_PsO
datPsO_venn$'Primary care coded' <- datPsO_venn$PrevalentPsO_gp


plot <- ggvenn(datPsO_venn, c('Self-report', 'HES coded', 'Primary care coded'),
               fill_color = c("#0073C2FF", "#EFC000FF", "#CD534CFF"),
  stroke_size = 0.5, set_name_size = 4
  )
plot

```

```{r}
dir.create("plots")
output_dir <- "plots"
output_file <- file.path(output_dir, "PrevalentPsOcohort.tiff")
ggsave(output_file, plot, device = "tiff", width = 6, height = 6, dpi = 300)
```



Sequentially run this - for sensitivity analysis
```{r}
TwoYear_cases <- (dat$ProbDefPsA_incident & dat$fu_time_2 <= 730)

dat2yr <- dat[!(TwoYear_cases), ]

```

```{r}
FourYear_cases <- (dat$ProbDefPsA_incident & dat$fu_time_2 <= 1461)

dat4yr <- dat[!(FourYear_cases), ]
```

```{r}
ThreeYear_cases <- (dat$ProbDefPsA_incident & dat$fu_time_2 <= 1096)

dat3yr <- dat[!(ThreeYear_cases), ]
```


```{r}
exposures <- c("step_thirds", "step_quintiles")
outcomes <- c("ProbDefPsA_incident") 

multivar_covs <-
c(
"sex",
"tdi_quarters", 
"qualif",
"smoking",
"alcohol"
)

adjustments <-
list(
"model1" = NULL,
"model2" = c(multivar_covs),
"model3" = c(multivar_covs, "BMI_cats"),
"model3" = c(multivar_covs, "SystemicTreatment")
)

```

```{r}
dir.create("outputs")
```

Cadence plotting
```{r}
for (exposure in exposures) {
  # SET UP RECORDING FRAME ======================================================
  results_columns <-   c("Exposure",
                         "Outcome",
                         "Model",
                         "Adjustment",
                         "n",
                         "n_event",
                         as.vector(outer(
                           # excessively complex code to get crossed column names
                           c(
                             "HR",
                             "Lower_CI",
                             "Upper_CI",
                             "floatedlnHR",
                             "floatedSE",
                             "floatedHR",
                             "floatedLower_CI",
                             "floatedUpper_CI",
                             "n",
                             "n_event", 
                             "mean_steps", 
                             "mean_acc",
                             "mean_cad30"
                           ),
                           unique(dat[, exposure]),
                           paste,
                           sep = "_"
                         )))
  results_tab <-
    data.frame(matrix(ncol = length(results_columns) ,
                      nrow = 0))
  colnames(results_tab) <- results_columns
  
  # Do modelling: ===============================================================
  for (i in 1:length(outcomes)) {
    for (j in 1:length(adjustments)) {
      # Pull relevant values-----------------------------
      outcome <- outcomes[i]
      model_name <- names(adjustments)[j]
      covs <- adjustments[[j]]
      
      # Organise for model calculation-------------------
      cov_sum <- paste0(c(exposure, covs), collapse = "+")
      
      # Model--------------------------------------------
      form <-
        paste0("Surv(age_entry_days, age_exit_days_2, ",
               outcome,
               ") ~ ",
               cov_sum)
      model <-
        coxph(as.formula(form), dat)
      print(cox.zph(model))
      
      # Extract values-----------------------------------
      results_frame <-
        data.frame(
          "Exposure" = exposure,
          "Outcome" = outcome,
          "Model" = model_name,
          "Adjustment" = paste0(covs, collapse = ","),
          "n" = model$n,
          "n_event" = model$nevent
        )
      
      # CYCLE THROUGH EXPOSURE LEVELS EXTRACTING INFO=============================================
      fac_levels <- levels(factor(dat[, exposure]))
      for (cat in fac_levels) {
        
        # HRs=====================================================================================
        if (cat == fac_levels[1]) {
          HRs <- data.frame(matrix(c(1, 1, 1), nrow = 1))
        }
        else {
          HRs <-
            summary(model)$conf.int[paste0(exposure, cat), c("exp(coef)", "lower .95", "upper .95"), drop = FALSE]
          rownames(HRs) <- NULL
        }
        colnames(HRs) <-
          as.vector(outer(c("HR", "Lower_CI", "Upper_CI"), cat, paste, sep = "_"))
        
        # FLOATED HRs etc =======================================================================
        float_model <- float(model)# This is doing floating absolute risks using Epi package
        
        ## Values
        zval <- qnorm(0.975)
        se <- sqrt(float_model$var[cat])
        lnhr <- float_model$coef[cat]
        
        # Collate into frame
        HRs_floated <-
          data.frame(matrix(c(
            lnhr,
            se,
            exp(lnhr),
            exp(lnhr - se[cat] * zval),
            exp(lnhr + se[cat] * zval)
          ), nrow = 1))
        colnames(HRs_floated) <-
          as.vector(outer(
            c(
              "floatedlnHR",
              "floatedSE",
              "floatedHR",
              "floatedLower_CI",
              "floatedUpper_CI"
            ),
            cat,
            paste,
            sep = "_"
          ))
    
        # n and nevent ===================================================================================
        n_group <- nrow(dat[dat[, exposure] == cat, ])
        n_event_group <- nrow(dat[(dat[, exposure] == cat) & (dat[, outcome]), ])
        n_by_group <- data.frame(matrix(c(n_group, n_event_group), nrow = 1))
        colnames(n_by_group) <-
          as.vector(outer(c("n", "n_event"), cat, paste, sep = "_"))
        
        # Mean exposure ==================================================================================
        col_me <- paste0("mean_steps_", cat)
        col_acc <- paste0("mean_acc_", cat)
        col_cad30 <- paste0("mean_cad30_", cat)
        mean_exposure <- data.frame(mean(dat$med_steps[dat[, exposure] == cat]), 
                                    mean(dat$overall_activity[dat[, exposure] == cat]),
                                    mean(dat$CadencePeak30Adjusted.steps.min.[dat[, exposure] == cat]))
        colnames(mean_exposure) <- c(col_me, col_acc,col_cad30)
        
        # Bind together in final data frame ==============================================================
        results_frame <-
          cbind(results_frame, HRs, HRs_floated, n_by_group, mean_exposure)
      }
      
      
      # CHECK THAT n and n events match by different routes
      nsum <- sum(results_frame[,  as.vector(outer(c("n"), fac_levels, paste, sep = "_"))])
      n_eventsum <- sum(results_frame[,  as.vector(outer(c("n_event"), fac_levels, paste, sep = "_"))])
      if ((results_frame$n != nsum)|(results_frame$n_event != n_eventsum)){
        stop("Mismatch between numbers derived from different sources. Recheck model. May be that some rows are being excluded due to missing covariate data.")
      }
      
      
      # BIND INTO FINAL RESULTS FRAME AND DELETE
      results_tab <- rbind(results_tab, results_frame)
      
      rm(results_frame)
      
    }
  }
  
  assign(paste0(exposure, "_results_tab"), results_tab)
  write.csv(results_tab, paste0("outputs/", exposure, "_tab.csv"))
  # print(results_tab)
  rm(results_tab, results_columns)
}
```

```{r}

dat2yr <- dat2yr %>%
  mutate(step_thirdsEqual = case_when(
    med_steps < 5000 ~ "<5000",
    med_steps >= 5000 & med_steps <= 10000 ~ "5000-10000",
    med_steps > 10000 ~ ">10000"
  ))

dat2yr$step_thirds <- qtile_cut(dat2yr$med_steps, probs = seq(0, 1, by = 1/3), dp_label = 1)

dat2yr$acc_thirds <- qtile_cut(dat2yr$overall_activity, probs = seq(0, 1, by = 1/3), dp_label = 1)
dat2yr$tdi_quarters <- qtile_cut(dat2yr$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat2yr$cadence30_thirds <- qtile_cut(dat2yr$CadencePeak30Adjusted.steps.min., probs = seq(0,1, by=1/3))
dat2yr$age_gp_crude <- cut(dat2yr$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat2yr$BMI_cats <-
  cut(dat2yr$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```


Cadence plotting - 2 year
```{r}
for (exposure in exposures) {
  # SET UP RECORDING FRAME ======================================================
  results_columns <-   c("Exposure",
                         "Outcome",
                         "Model",
                         "Adjustment",
                         "n",
                         "n_event",
                         as.vector(outer(
                           # excessively complex code to get crossed column names
                           c(
                             "HR",
                             "Lower_CI",
                             "Upper_CI",
                             "floatedlnHR",
                             "floatedSE",
                             "floatedHR",
                             "floatedLower_CI",
                             "floatedUpper_CI",
                             "n",
                             "n_event", 
                             "mean_steps", 
                             "mean_acc",
                             "mean_cad30"
                           ),
                           unique(dat2yr[, exposure]),
                           paste,
                           sep = "_"
                         )))
  results_tab <-
    data.frame(matrix(ncol = length(results_columns) ,
                      nrow = 0))
  colnames(results_tab) <- results_columns
  
  # Do modelling: ===============================================================
  for (i in 1:length(outcomes)) {
    for (j in 1:length(adjustments)) {
      # Pull relevant values-----------------------------
      outcome <- outcomes[i]
      model_name <- names(adjustments)[j]
      covs <- adjustments[[j]]
      
      # Organise for model calculation-------------------
      cov_sum <- paste0(c(exposure, covs), collapse = "+")
      
      # Model--------------------------------------------
      form <-
        paste0("Surv(age_entry_days, age_exit_days_2, ",
               outcome,
               ") ~ ",
               cov_sum)
      model <-
        coxph(as.formula(form), dat2yr)
      print(cox.zph(model))
      
      # Extract values-----------------------------------
      results_frame <-
        data.frame(
          "Exposure" = exposure,
          "Outcome" = outcome,
          "Model" = model_name,
          "Adjustment" = paste0(covs, collapse = ","),
          "n" = model$n,
          "n_event" = model$nevent
        )
      
      # CYCLE THROUGH EXPOSURE LEVELS EXTRACTING INFO=============================================
      fac_levels <- levels(factor(dat2yr[, exposure]))
      for (cat in fac_levels) {
        
        # HRs=====================================================================================
        if (cat == fac_levels[1]) {
          HRs <- data.frame(matrix(c(1, 1, 1), nrow = 1))
        }
        else {
          HRs <-
            summary(model)$conf.int[paste0(exposure, cat), c("exp(coef)", "lower .95", "upper .95"), drop = FALSE]
          rownames(HRs) <- NULL
        }
        colnames(HRs) <-
          as.vector(outer(c("HR", "Lower_CI", "Upper_CI"), cat, paste, sep = "_"))
        
        # FLOATED HRs etc =======================================================================
        float_model <- float(model)# This is doing floating absolute risks using Epi package
        
        ## Values
        zval <- qnorm(0.975)
        se <- sqrt(float_model$var[cat])
        lnhr <- float_model$coef[cat]
        
        # Collate into frame
        HRs_floated <-
          data.frame(matrix(c(
            lnhr,
            se,
            exp(lnhr),
            exp(lnhr - se[cat] * zval),
            exp(lnhr + se[cat] * zval)
          ), nrow = 1))
        colnames(HRs_floated) <-
          as.vector(outer(
            c(
              "floatedlnHR",
              "floatedSE",
              "floatedHR",
              "floatedLower_CI",
              "floatedUpper_CI"
            ),
            cat,
            paste,
            sep = "_"
          ))
    
        # n and nevent ===================================================================================
        n_group <- nrow(dat2yr[dat2yr[, exposure] == cat, ])
        n_event_group <- nrow(dat2yr[(dat2yr[, exposure] == cat) & (dat2yr[, outcome]), ])
        n_by_group <- data.frame(matrix(c(n_group, n_event_group), nrow = 1))
        colnames(n_by_group) <-
          as.vector(outer(c("n", "n_event"), cat, paste, sep = "_"))
        
        # Mean exposure ==================================================================================
        col_me <- paste0("mean_steps_", cat)
        col_acc <- paste0("mean_acc_", cat)
        col_cad30 <- paste0("mean_cad30_", cat)
        mean_exposure <- data.frame(mean(dat2yr$med_steps[dat2yr[, exposure] == cat]), 
                                    mean(dat2yr$overall_activity[dat2yr[, exposure] == cat]),
                                    mean(dat2yr$CadencePeak30Adjusted.steps.min.[dat2yr[, exposure] == cat]))
        colnames(mean_exposure) <- c(col_me, col_acc,col_cad30)
        
        # Bind together in final data frame ==============================================================
        results_frame <-
          cbind(results_frame, HRs, HRs_floated, n_by_group, mean_exposure) 
      }
      
      
      # CHECK THAT n and n events match by different routes
      nsum <- sum(results_frame[,  as.vector(outer(c("n"), fac_levels, paste, sep = "_"))])
      n_eventsum <- sum(results_frame[,  as.vector(outer(c("n_event"), fac_levels, paste, sep = "_"))])
      if ((results_frame$n != nsum)|(results_frame$n_event != n_eventsum)){
        stop("Mismatch between numbers derived from different sources. Recheck model. May be that some rows are being excluded due to missing covariate data.")
      }
      
      
      # BIND INTO FINAL RESULTS FRAME AND DELETE
      results_tab <- rbind(results_tab, results_frame)
      
      rm(results_frame)
      
    }
  }
  
  assign(paste0(exposure, "_results_tab_2yr"), results_tab)
  write.csv(results_tab, paste0("outputs/", exposure, "_tab_2yr.csv"))
  # print(results_tab)
  rm(results_tab, results_columns)
}
```



```{r}

dat3yr <- dat3yr %>%
  mutate(step_thirdsEqual = case_when(
    med_steps < 5000 ~ "<5000",
    med_steps >= 5000 & med_steps <= 10000 ~ "5000-10000",
    med_steps > 10000 ~ ">10000"
  ))

dat3yr$step_thirds <- qtile_cut(dat3yr$med_steps, probs = seq(0, 1, by = 1/3), dp_label = 1)

dat3yr$acc_thirds <- qtile_cut(dat3yr$overall_activity, probs = seq(0, 1, by = 1/3), dp_label = 1)
dat3yr$tdi_quarters <- qtile_cut(dat3yr$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat3yr$cadence30_thirds <- qtile_cut(dat3yr$CadencePeak30Adjusted.steps.min., probs = seq(0,1, by=1/3))
dat3yr$age_gp_crude <- cut(dat3yr$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat3yr$BMI_cats <-
  cut(dat3yr$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```


```{r}

dat4yr <- dat4yr %>%
  mutate(step_thirdsEqual = case_when(
    med_steps < 5000 ~ "<5000",
    med_steps >= 5000 & med_steps <= 10000 ~ "5000-10000",
    med_steps > 10000 ~ ">10000"
  ))

dat4yr$step_thirds <- qtile_cut(dat4yr$med_steps, probs = seq(0, 1, by = 1/3), dp_label = 1)

dat4yr$acc_thirds <- qtile_cut(dat4yr$overall_activity, probs = seq(0, 1, by = 1/3), dp_label = 1)
dat4yr$tdi_quarters <- qtile_cut(dat4yr$tdi_raw, probs = seq(0, 1, by = 0.25), dp_label = 1)
dat4yr$cadence30_thirds <- qtile_cut(dat4yr$CadencePeak30Adjusted.steps.min., probs = seq(0,1, by=1/3))
dat4yr$age_gp_crude <- cut(dat4yr$age_entry_years, seq(40, 80, by = 10), right = FALSE, labels = c("40-49", "50-59", "60-69", "70-79"))
dat4yr$BMI_cats <-
  cut(dat4yr$BMI,
      breaks = c(0, 25, 30, 10000),
      labels = c("<24.9", "25.0-29.9", "30.0+"),
      right = FALSE)
```


Cadence plotting
```{r}
for (exposure in exposures) {
  # SET UP RECORDING FRAME ======================================================
  results_columns <-   c("Exposure",
                         "Outcome",
                         "Model",
                         "Adjustment",
                         "n",
                         "n_event",
                         as.vector(outer(
                           # excessively complex code to get crossed column names
                           c(
                             "HR",
                             "Lower_CI",
                             "Upper_CI",
                             "floatedlnHR",
                             "floatedSE",
                             "floatedHR",
                             "floatedLower_CI",
                             "floatedUpper_CI",
                             "n",
                             "n_event", 
                             "mean_steps", 
                             "mean_acc",
                             "mean_cad30"
                           ),
                           unique(dat4yr[, exposure]),
                           paste,
                           sep = "_"
                         )))
  results_tab <-
    data.frame(matrix(ncol = length(results_columns) ,
                      nrow = 0))
  colnames(results_tab) <- results_columns
  
  # Do modelling: ===============================================================
  for (i in 1:length(outcomes)) {
    for (j in 1:length(adjustments)) {
      # Pull relevant values-----------------------------
      outcome <- outcomes[i]
      model_name <- names(adjustments)[j]
      covs <- adjustments[[j]]
      
      # Organise for model calculation-------------------
      cov_sum <- paste0(c(exposure, covs), collapse = "+")
      
      # Model--------------------------------------------
      form <-
        paste0("Surv(age_entry_days, age_exit_days_2, ",
               outcome,
               ") ~ ",
               cov_sum)
      model <-
        coxph(as.formula(form), dat4yr)
      print(cox.zph(model))
      
      # Extract values-----------------------------------
      results_frame <-
        data.frame(
          "Exposure" = exposure,
          "Outcome" = outcome,
          "Model" = model_name,
          "Adjustment" = paste0(covs, collapse = ","),
          "n" = model$n,
          "n_event" = model$nevent
        )
      
      # CYCLE THROUGH EXPOSURE LEVELS EXTRACTING INFO=============================================
      fac_levels <- levels(factor(dat4yr[, exposure]))
      for (cat in fac_levels) {
        
        # HRs=====================================================================================
        if (cat == fac_levels[1]) {
          HRs <- data.frame(matrix(c(1, 1, 1), nrow = 1))
        }
        else {
          HRs <-
            summary(model)$conf.int[paste0(exposure, cat), c("exp(coef)", "lower .95", "upper .95"), drop = FALSE]
          rownames(HRs) <- NULL
        }
        colnames(HRs) <-
          as.vector(outer(c("HR", "Lower_CI", "Upper_CI"), cat, paste, sep = "_"))
        
        # FLOATED HRs etc =======================================================================
        float_model <- float(model)# This is doing floating absolute risks using Epi package
        
        ## Values
        zval <- qnorm(0.975)
        se <- sqrt(float_model$var[cat])
        lnhr <- float_model$coef[cat]
        
        # Collate into frame
        HRs_floated <-
          data.frame(matrix(c(
            lnhr,
            se,
            exp(lnhr),
            exp(lnhr - se[cat] * zval),
            exp(lnhr + se[cat] * zval)
          ), nrow = 1))
        colnames(HRs_floated) <-
          as.vector(outer(
            c(
              "floatedlnHR",
              "floatedSE",
              "floatedHR",
              "floatedLower_CI",
              "floatedUpper_CI"
            ),
            cat,
            paste,
            sep = "_"
          ))
    
        # n and nevent ===================================================================================
        n_group <- nrow(dat4yr[dat4yr[, exposure] == cat, ])
        n_event_group <- nrow(dat4yr[(dat4yr[, exposure] == cat) & (dat4yr[, outcome]), ])
        n_by_group <- data.frame(matrix(c(n_group, n_event_group), nrow = 1))
        colnames(n_by_group) <-
          as.vector(outer(c("n", "n_event"), cat, paste, sep = "_"))
        
        # Mean exposure ==================================================================================
        col_me <- paste0("mean_steps_", cat)
        col_acc <- paste0("mean_acc_", cat)
        col_cad30 <- paste0("mean_cad30_", cat)
        mean_exposure <- data.frame(mean(dat4yr$med_steps[dat4yr[, exposure] == cat]), 
                                    mean(dat4yr$overall_activity[dat4yr[, exposure] == cat]),
                                    mean(dat4yr$CadencePeak30Adjusted.steps.min.[dat4yr[, exposure] == cat]))
        colnames(mean_exposure) <- c(col_me, col_acc,col_cad30)
        
        # Bind together in final data frame ==============================================================
        results_frame <-
          cbind(results_frame, HRs, HRs_floated, n_by_group, mean_exposure)
      }
      
      
      # CHECK THAT n and n events match by different routes
      nsum <- sum(results_frame[,  as.vector(outer(c("n"), fac_levels, paste, sep = "_"))])
      n_eventsum <- sum(results_frame[,  as.vector(outer(c("n_event"), fac_levels, paste, sep = "_"))])
      if ((results_frame$n != nsum)|(results_frame$n_event != n_eventsum)){
        stop("Mismatch between numbers derived from different sources. Recheck model. May be that some rows are being excluded due to missing covariate data.")
      }
      
      
      # BIND INTO FINAL RESULTS FRAME AND DELETE
      results_tab <- rbind(results_tab, results_frame)
      
      rm(results_frame)
      
    }
  }
  
  assign(paste0(exposure, "_results_tab_4yr"), results_tab)
  write.csv(results_tab, paste0("outputs/", exposure, "_tab_4yr.csv"))
  # print(results_tab)
  rm(results_tab, results_columns)
}
```


Sequential adjustment plots 
###Sequential model adjustment 
Next we perform sequential adjustment.

## Sequential adjustment plot

```{r}
dat$age_exit_days <- dat$age_exit_days_2
```

```{r}
library(Hmisc)

label(dat$sex)                  <- "Sex"
#label(dat$ethnicity)              <- "Ethnicity"
label(dat$alcohol)              <- "Alcohol"
label(dat$smoking)              <- "Smoking"
label(dat$tdi_quarters)         <- "Townsend Deprivation"
label(dat$qualif)         <- "Education"
label(dat$SystemicTreatment)   <- "Use of systemic treatment"
label(dat$BMI_cats)             <- "Body Mass Index"
label(dat$total_6months)       <- "Total prodromal indicator - 6 months"
label(dat$total_2year)       <- "Total prodromal indicator - 2 years"
label(dat$total_5year)             <- "Total prodromal indicator - 5 years"

label(dat$JointPainChronic)       <- "GP or self-report joint pain - 5 years"
label(dat$SystemicTreatment)             <- "Systemic Medication"
label(dat$pain_3month_Back) <- "Chronic back pain"
label(dat$pain_3month_Knee) <- "Chronic knee pain"
label(dat$pain_3month_Hip) <- "Chronic hip pain"
label(dat$pain_3month_General) <- "Chronic widespread pain"
label(dat$total_prevalent_PsO) <- "Prevalent psoriasis"
label(dat$MET_tertiles_local) <- "Self-reported PA at baseline"

covariates <- c("sex", "tdi_quarters", "smoking", "alcohol", "qualif")
mediators <- c("MET_tertiles_local")
out_vars <- c("age_entry_days", "age_exit_days", "ProbDefPsA_incident")
primary <- "med_steps"

cols <- c(covariates, mediators, out_vars, primary)


missing_columns <- setdiff(cols, colnames(dat))
if (length(missing_columns) > 0) {
  err_message <- paste("The following columns are not found in the dataset: ", 
                       paste(missing_columns, collapse = ", "))
  stop(err_message)
} else {
  dat <- dat[, cols]
}

```

```{r}

results_list <- list()

results_list[[1]] <- coxph_analysis(dat, "Univariable association", list(), 
                                    primary, out_vars[length(out_vars)], 1000, 
                                    calculate_chi_squared = TRUE)

for (i in seq_along(covariates)) {
  results_list[[i + 1]] <- coxph_analysis(dat, paste0("  + ", label(dat[[covariates[i]]])),
                                          covariates[1:i],primary, out_vars[length(out_vars)], 
                                          1000, calculate_chi_squared = TRUE)
}

covar_adjustments <- do.call(rbind, results_list)

covar_adjustments$Variable <- factor(covar_adjustments$Variable, 
                                     levels = rev(unique(covar_adjustments$Variable)))
```

```{r}
covar_plot <- adjustment_plot(covar_adjustments, save_plot = "outputs/covariate_adjustment_inPsO.png")
```

Systemic treatment
```{r}
results_list <- list()

results_list[[1]] <- coxph_analysis(dat, "Multivariable association", covariates, 
                                    primary, out_vars[length(out_vars)], 1000, 
                                    calculate_chi_squared = TRUE)

for (i in seq_along(mediators)) {
  variables <- c(covariates, mediators[i])
  results_list[[i + 1]] <- coxph_analysis(dat, paste0("  + ", label(dat[[mediators[i]]])), 
                                          c(covariates, mediators[i]), primary, 
                                          out_vars[length(out_vars)], 1000, 
                                          calculate_chi_squared = TRUE)
}

# Combine the results into a single data frame
mediator_adjustments <- do.call(rbind, results_list)

mediator_adjustments$Variable <- factor(mediator_adjustments$Variable, 
                                        levels = rev(unique(mediator_adjustments$Variable)))
```

```{r}
mediator_plot <- adjustment_plot(mediator_adjustments, save_plot = "outputs/mediator_analysis_BMIwhole.png")
```


Interaction term with prodromal 
Subgroup analysis using Harry's method 


Interaction term with prodromal 
Subgroup analysis using Harry's method 

```{r}
cox_prodrome <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           total_2year+ as.factor(sex)+ as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol),
                         data=dat)
summary(cox_prodrome)

library(biostat3)
cox_prodrome <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           med_steps_std*JointPainChronic+ as.factor(sex)+ as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol),
                         data=dat)

cox_reduced <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           Cad1_std+ as.factor(sex)+ as.factor(tdi_quarters) +as.factor(qualif)+
                    + as.factor(smoking) + as.factor(alcohol),
                         data=dat)


lrt <- anova(cox_prodrome,cox_reduced, test = "Chisq")

lrt
x_chi <- lrt$"Chisq"[2] 
p_value <- lrt$"Pr(>|Chi|)"[2] 
df <- lrt$"Df"[2]


cox_summary <- summary(cox_prodrome)
cox_summary

# Standard error for the med_steps_std main effect
std_error_Normal <- cox_summary$coefficients["med_steps_std", "se(coef)"]
std_error_Prodrome <- cox_summary$coefficients["med_steps_std:total_5yearTRUE", "se(coef)"]


sub_prodrome <- lincom(cox_prodrome, c("med_steps_std",
                          "med_steps_std:total_5yearTRUE"),
       eform=TRUE)
res <- as.data.frame(sub_prodrome)

sub_prodrome_df <- bind_rows(res)

sub_prodrome_df <- sub_prodrome_df %>%
  mutate(model = c("No prodromal symptoms", "Prodromal")) %>%
  relocate(model, .before = 1)

sub_prodrome_df <- sub_prodrome_df[, c(1, 2, 3, 4, 6), drop = TRUE]

sub_prodrome_df <- sub_prodrome_df %>%
  rename(
    `Lower CI` = `2.5 %`,
    `Upper CI` = `97.5 %`
  )

new_row_names <- c("1", "2")

# Assign the new row names to the dataframe
rownames(sub_prodrome_df) <- new_row_names

sub_prodrome_df$x_chi <- x_chi
sub_prodrome_df$p_value <- p_value

```

```{r}
#Now get case counts and denominator for each 
counts <- dat %>%
  group_by(total_5year) %>%
  summarise(
    Total_Length = n(),  # Total number of observations
    PsA_Incidents = sum(ProbDefPsA_incident, na.rm = TRUE)  # Total number of RA incidents, excluding NA values
  )
```


```{r}
library(ggplot2)


# Sample data
data <- data.frame(
  Model = c("Prodromal", "No prodromal symptoms"),
  HR_per_1000_step_increase = c(0.83477, 1.00145),
  CI_lower = c(0.72938, 0.91272),
  CI_upper = c(0.9553, 1.0988),
  Cases_n = c("40 / 825", "31 / 1182")
)

heterogeneity_text <- "Heterogeneity: italic(X^2)[1] == 6.88 (italic(p) == 0.009)"


data$Model <- factor(data$Model, levels = c("Prodromal", "No prodromal symptoms")) 

# Create the plot
forest_plot <- ggplot(data, aes(x = HR_per_1000_step_increase, y = Model, xmin = CI_lower, xmax = CI_upper)) +
  geom_point(size = 2) +
  geom_errorbarh(height = 0) +
  geom_point(aes(size = 1), shape = 15, colour = "black", fill = "black", stroke = 0.5) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  scale_size(guide = NULL) + 
  labs(x = "Hazard Ratio (95% CI) per 1000 step increase", y = "") +
  scale_x_continuous(breaks = c(0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4,1.6, 2.5), limits = c(0.2, 2.5), trans = "log") +
  theme_classic() +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    panel.spacing = unit(5, "lines"),
    panel.spacing.y = unit(2, "lines"),
    plot.margin = margin(20, 50, 10, 10, "points")
  ) +
  coord_cartesian(clip = "off")

# Add text annotations
forest_plot <- forest_plot +
  # HR column - contents
  geom_text(aes(y = Model, x = 1.1, label = sprintf("%.2f (%.2f, %.2f)", HR_per_1000_step_increase, CI_lower, CI_upper)), 
            hjust = -0.2, vjust = 0, size = 4, color = "black") +
  # HR column - label bolded at top
  geom_text(aes(y = Model, x = 1.1, label = ifelse(Model == "No prodromal symptoms", "Hazard Ratio (95% CI)", NA)),
            hjust = 0, vjust = -3, size = 4, color = "black", fontface = "bold", 
            parse = FALSE, check_overlap = TRUE) +
  # Cases column - content
  geom_text(aes(y = Model, x = 0.54, label = Cases_n),
            hjust = 0, vjust = 0, size = 4, color = "black") +
  # Cases column - label bolded at top
  geom_text(aes(y = Model, x = 0.54, label = ifelse(Model == "No prodromal symptoms", "Cases / n", NA)),
            hjust = 0.05, vjust = -3, size = 4, color = "black", fontface = "bold", 
            parse = FALSE, check_overlap = TRUE) +
  # Model names
  geom_text(aes(y = Model, x = 0.235, label = Model),
            hjust = 0, vjust = 0, size = 4, color = "black") +
  # Model titles in bold
  geom_text(aes(y = Model, x = 0.235, label = ifelse(Model == "No prodromal symptoms", "Model", NA)),
            hjust = 0, vjust = -3, size = 4, color = "black", fontface ="bold",
            parse = FALSE)+
  annotate("text", x = 1.01, y = 0.5, label = heterogeneity_text, parse = TRUE, hjust = -0.1, size = 4, color = "black")

# Display the plot
print(forest_plot)


```

Sensitivity analysis - removal of 4 years of follow up plots 
```{r}
Full <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           (cadence30_thirds) +as.factor(sex) +as.factor(tdi_quarters)+as.factor(qualif) + as.factor(smoking) +as.factor(alcohol),
                          data=dat)

summary(Full)
```

```{r}
TwoYr <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           (Cad1_std) +as.factor(sex) +as.factor(tdi_quarters)+as.factor(qualif) +as.factor(alcohol),
                          data=dat4yr)

summary(TwoYr)
```


```{r}
FourYr <- coxph((Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident)) ~ 
                           (med_steps_std) +as.factor(sex) +as.factor(tdi_quarters)+as.factor(qualif) + as.factor(smoking) +as.factor(alcohol),
                          data=dat4yr)

FourYearSummary <- summary(FourYr)
FourYearSummary

```

```{r}
library(ggplot2)


# Sample data
data <- data.frame(
  Model = c("Full follow-up", "Removal first 2 years", "Removal first 4 years"),
  HR_per_1000_step_increase = c(0.9019, 0.9099, 0.9504),
  CI_lower = c(0.8497, 0.8510, 0.8797),
  CI_upper = c(0.9572, 0.9773, 1.028),
  Cases_n = c("99 / 2531", "77 / 2509", "52 / 2484")
)

data$Model <- factor(data$Model, levels = c("Removal first 4 years", "Removal first 2 years", "Full follow-up")) 

# Create the plot
forest_plot <- ggplot(data, aes(x = HR_per_1000_step_increase, y = Model, xmin = CI_lower, xmax = CI_upper)) +
  geom_point(size = 2) +
  geom_errorbarh(height = 0) +
  geom_point(aes(size = 1), shape = 15, colour = "black", fill = "black", stroke = 0.5) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  scale_size(guide = NULL) + 
  labs(x = "Hazard Ratio (95% CI) per 1000 step increase", y = "") +
  scale_x_continuous(breaks = c(0.4, 0.6, 0.8, 1.0, 1.2, 1.4,1.6), limits = c(0.4, 1.6), trans = "log") +
  theme_classic() +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    panel.spacing = unit(5, "lines"),
    panel.spacing.y = unit(2, "lines"),
    plot.margin = margin(20, 50, 10, 10, "points")
  ) +
  coord_cartesian(clip = "off")

# Add text annotations
forest_plot <- forest_plot +
  # HR column - contents
  geom_text(aes(y = Model, x = 1.1, label = sprintf("%.2f (%.2f, %.2f)", HR_per_1000_step_increase, CI_lower, CI_upper)), 
            hjust = -0.2, vjust = 0, size = 4, color = "black") +
  # HR column - label bolded at top
  geom_text(aes(y = Model, x = 1.1, label = ifelse(Model == "Full follow-up", "Hazard Ratio (95% CI)", NA)),
            hjust = 0, vjust = -3, size = 4, color = "black", fontface = "bold", 
            parse = FALSE, check_overlap = TRUE) +
  # Cases column - content
  geom_text(aes(y = Model, x = 0.65, label = Cases_n),
            hjust = 0, vjust = 0, size = 4, color = "black") +
  # Cases column - label bolded at top
  geom_text(aes(y = Model, x = 0.65, label = ifelse(Model == "Full follow-up", "Cases / n", NA)),
            hjust = 0.05, vjust = -3, size = 4, color = "black", fontface = "bold", 
            parse = FALSE, check_overlap = TRUE) +
  # Model names
  geom_text(aes(y = Model, x = 0.45, label = Model),
            hjust = 0, vjust = 0, size = 4, color = "black") +
  # Model titles in bold
  geom_text(aes(y = Model, x = 0.45, label = ifelse(Model == "Full follow-up", "Model", NA)),
            hjust = 0, vjust = -3, size = 4, color = "black", fontface ="bold",
            parse = FALSE)

# Display the plot
print(forest_plot)


```



```{r}
dir.create("plots")
output_dir <- "plots"
output_file <- file.path(output_dir, "forest_sensitivity_final.tiff")
ggsave(output_file, forest_plot, device = "tiff", width = 10, height = 3, dpi = 300)
``` 

##Modelling different outcomes as per the Def, ProbDef and Prob

Definite
```{r}
##Definite HES 


minimal_1 <- coxph(Surv(age_entry_days, age_exit_days_1, PsA_incident_HES) ~ 
                   (med_steps_std), data = dat)

summary(minimal_1)


model_1 <- coxph(Surv(age_entry_days, age_exit_days_1, PsA_incident_HES) ~ 
                   (med_steps_std) + as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters), data = dat)

summary(model_1)

model_BMI <- coxph(Surv(age_entry_days, age_exit_days_1, PsA_incident_HES) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) +as.factor(BMI_cats), data = dat)

summary(model_BMI)


model_SystemicTreatments <- coxph(Surv(age_entry_days, age_exit_days_1, PsA_incident_HES) ~ 
                   med_steps_std + as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters)+as.factor(SystemicTreatment), data = dat)

summary(model_SystemicTreatments)

```

```{r}
summary_table_ProbDef <- dat %>%
  group_by(MET_quartiles) %>%
  summarize(
    total_cases = n(),
    incident_events = sum(ProbDefPsA_incident, na.rm = TRUE)
  )
# Model 2: Probable total PsA (HES only)
minimal_2 <- coxph(Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident) ~ 
                   med_steps_std, data = dat)

summary(minimal_2)

model_2 <- coxph(Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol), data = dat)

summary(model_2)

model_BMI <- coxph(Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol)+as.factor(BMI_cats), data = dat)

summary(model_BMI)

model_2_SystemicTreatments <- coxph(Surv(age_entry_days,age_exit_days_2,ProbDefPsA_incident)~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol)+as.factor(SystemicTreatment), data = dat)

summary(model_2_SystemicTreatments)

```

```{r}
summary_table_Prob<- dat %>%
  group_by(MET_quartiles) %>%
  summarize(
    total_cases = n(),
    incident_events = sum(ProbPsA_incident, na.rm = TRUE)
  )
# Model 3: Probable only  (HES only)
minimal_3 <- coxph(Surv(age_entry_days, age_exit_days_3, ProbPsA_incident) ~ 
                   med_steps_std, data = dat)

summary(minimal_3) 
 

model_3 <- coxph(Surv(age_entry_days, age_exit_days_3, ProbPsA_incident) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol), data = dat)

summary(model_3)

model_3_BMI <- coxph(Surv(age_entry_days, age_exit_days_3, ProbPsA_incident) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol)+as.factor(BMI_cats), data = dat)

summary(model_3_BMI)

model_3_SystemicTreatment <- coxph(Surv(age_entry_days, age_exit_days_3, ProbPsA_incident) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol)+as.factor(SystemicTreatment), data = dat)

summary(model_3_SystemicTreatment)
```


Forest plot 
```{r}
model_1 <- coxph(Surv(age_entry_days, age_exit_days_1, PsA_incident_HES) ~ 
                   (med_steps_std) + as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters), data = dat)

summary(model_1)




model_2 <- coxph(Surv(age_entry_days, age_exit_days_3, ProbPsA_incident) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol), data = dat)

summary(model_2)


model_3 <- coxph(Surv(age_entry_days, age_exit_days_2, ProbDefPsA_incident) ~ 
                   med_steps_std+ as.factor(qualif) + as.factor(smoking) + 
                   as.factor(tdi_quarters) + as.factor(alcohol), data = dat)

summary(model_3)

```

```{r}
# Sample data
data <- data.frame(
  Model = c("Definite PsA only", "Probable PsA only",  "Probable+Definite PsA"),
  HR_per_1000_step_increase = c(0.9608, 0.8954, 0.9020),
  CI_lower = c(0.8715, 0.8352, 0.8498),
  CI_upper = c(1.059, 0.9598, 0.9575),
  Cases_n = c("31 / 2531", "74 / 2531", "99 / 2531")
)
             
                

data$Model <- factor(data$Model, levels = c("Probable+Definite PsA","Probable PsA only", "Definite PsA only")) 

# Create the plot
forest_plot <- ggplot(data, aes(x = HR_per_1000_step_increase, y = Model, xmin = CI_lower, xmax = CI_upper)) +
  geom_point(size = 2) +
  geom_errorbarh(height = 0) +
  geom_point(aes(size = 1), shape = 15, colour = "black", fill = "black", stroke = 0.5) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +
  scale_size(guide = NULL) + 
  labs(x = "Hazard Ratio (95% CI) per 1000 step increase", y = "") +
  scale_x_continuous(breaks = c(0.2,0.4, 0.6, 0.8, 1.0, 1.2, 1.4,1.6), limits = c(0.2, 1.6), trans = "log") +
  theme_classic() +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    panel.spacing = unit(5, "lines"),
    panel.spacing.y = unit(2, "lines"),
    plot.margin = margin(20, 50, 10, 10, "points")
  ) +
  coord_cartesian(clip = "off")

# Add text annotations
forest_plot <- forest_plot +
  # HR column - contents
  geom_text(aes(y = Model, x = 1.1, label = sprintf("%.2f (%.2f, %.2f)", HR_per_1000_step_increase, CI_lower, CI_upper)), 
            hjust = -0.2, vjust = 0, size = 4, color = "black") +
  # HR column - label bolded at top
  geom_text(aes(y = Model, x = 1.1, label = ifelse(Model == "Definite PsA only", "Hazard Ratio (95% CI)", NA)),
            hjust = 0, vjust = -3, size = 4, color = "black", fontface = "bold", 
            parse = FALSE, check_overlap = TRUE) +
  # Cases column - content
  geom_text(aes(y = Model, x = 0.6, label = Cases_n),
            hjust = 0, vjust = 0, size = 4, color = "black") +
  # Cases column - label bolded at top
  geom_text(aes(y = Model, x = 0.6, label = ifelse(Model == "Definite PsA only", "Cases / n", NA)),
            hjust = 0.05, vjust = -3, size = 4, color = "black", fontface = "bold", 
            parse = FALSE, check_overlap = TRUE) +
  # Model names
  geom_text(aes(y = Model, x = 0.3, label = Model),
            hjust = 0, vjust = 0, size = 4, color = "black") +
  # Model titles in bold
  geom_text(aes(y = Model, x = 0.3, label = ifelse(Model == "Definite PsA only", "Model", NA)),
            hjust = 0, vjust = -3, size = 4, color = "black", fontface ="bold",
            parse = FALSE)

# Display the plot
print(forest_plot)

```

```{r}
dir.create("plots")
output_dir <- "plots"
output_file <- file.path(output_dir, "forest_sensitivity_caseDefn.tiff")
ggsave(output_file, forest_plot, device = "tiff", width = 10, height = 3, dpi = 300)
``` 
