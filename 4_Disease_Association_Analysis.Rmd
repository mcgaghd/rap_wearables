---
title: "R Notebook"
output: rmarkdown::github_document
---

# A Basic Disease Association Analysis Using the UKB Accelerometer Data
## Introduction
In this notebook, we will associate overall activity levels with risk of incident cardiovascular disease.

## How to run this notebook
This notebook should be run in a *JupyterLab* session, with R as the kernel. It does *not* require a Spark cluster. See how to set it up [here](https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/using-jupyterlab-on-the-research-analysis-platform).

The same conventions are followed as in notebook 2 (the first R notebook).

As in the earlier notebooks, this notebook is a demo, not an indicator of best practice. Analytic decisions here (e.g. which variables are adjusted for) are bsed on the papers we replicate, and should not be interpreted as prescriptive. Analytic decisions should be made afresh in the context of each new analysis.
## Set up the session

We load packages:
# First we need to install packages that aren't already present
```{r}
pkgs <- c("data.table", "ggplot2", "survival", "table1", "dplyr", "emmeans", "data.table","gridExtra","lubridate","table1") # packages we need
pkgs_inst <- pkgs[!{pkgs %in% rownames(installed.packages())}] # check which are not present 
install.packages(pkgs_inst, repos = "https://www.stats.bris.ac.uk/R/")

# Load packages
lapply(pkgs, library, character.only = TRUE)
# using lapply just allows us to load several packages on one line
```

We load the data we prepared earlier (noting again that the code is different depending on whether you're running it in the same session as the earlier scripts, or have come back to do this later): 
```{r}
dat <- fread("prepped_steps.csv", data.table = FALSE) # version if running in same session as 
dat$V1 <- NULL


datSleep <- fread("cancer_sleep.csv")
datSleep <- datSleep %>%
  rename(eid = pid)
```
Remove RA and AS 
```{r}
dat <- dat %>%
  filter(!(total_prevalent_RA == TRUE & total_prevalent_PsA == FALSE))
```

```{r}
dat <- dat %>%
  filter(!(total_prevalent_AS == TRUE & total_prevalent_PsA == FALSE))
```

```{r}
dat <- dat %>%
  full_join(datSleep, by = "eid")
```

We summarise to understand the data structure:
```{r}
# summary(dat) # uncomment to run, avoiding printing lots of information on internet
#We create factors and make sure they have sensible ordering of levels (e.g. large-ish reference category): 
dat$ethnicity <- factor(dat$ethnicity, levels = c("White", "Nonwhite"))
dat$tdi_cats <- factor(dat$tdi_cats, levels = c("Least Deprived", "2nd Quintile", "3rd Quintile", "4th Quintile", "Most Deprived"))
dat$smoking <- factor(dat$smoking, levels = c("Never", "Previous", "Current"))
dat$alcohol <- factor(dat$alcohol, levels = c("<3 times/week", "3+ times/week", "Never"))
#dat$cci_huang <- factor(dat$cci_huang, levels = c("None", "Mild to Moderate", "Severe"))
dat$overall_activity_quarters <- factor(dat$overall_activity_quarters, levels = c("Quarter 1", "Quarter 2", "Quarter 3", "Quarter 4"))
```

## Create a case control cohort 4:1 exact matching on age (by year), season wear and sex

```{r}
dat$age_5yrBand <-
  cut(
    dat$age_entry_years,
    breaks = c(40,45, 50,55, 60, 65,70,75, 80),
    right = FALSE
  )
```




```{r}
caliper <- 0.1


# Perform matching with a caliper for age_entry_years
matched_data <- matchit(prevalent_PsA_HES_GP ~ age_entry_years + season_wear + sex, data = dat, method = "nearest", caliper = caliper,ratio = 4, replace=FALSE)#

summary(matched_data)

# Extract the matched dataset (cases and their matched controls)
datMatchPsA <- match.data(matched_data)

```

##  Describe and explore the data

We've explored the accelerometer data in a previous notebook, so here we'll focus on how the accelerometer covaries with the participant characteristics we're most interested in. 


Tidying variables for Scott steps analysis 
```{r} 
#Create a singular factor column which reads 0 - healthy controls i.e. non psoriatic disease, 1 psoriasis and 2 = PsA 

#First create non-psoriatic group 
dat$NonPsoriaticDisease <- !dat$Prevalent_PsO_lessPsA & !dat$total_prevalent_PsA 

#Now we want to create a new column called FactorAnalysis which the above 3 factors 
dat$AnalysisCategory <- ifelse(dat$NonPsoriaticDisease, 0,
                              ifelse(dat$Prevalent_PsO_lessPsA, 1,
                                     ifelse(dat$total_prevalent_PsA, 2, NA)))

#Set up a corresponding label to these categories 
labels2 <- c("NonPsoriaticDisease", "PsoriasisOnly", "PsA")

dat$AnalysisLabel <- factor(dat$AnalysisCategory, levels = 0:2, labels = labels2)
```

Create a datPsor
```{r}
datPsoriatic <- dat[!dat$NonPsoriaticDisease, ]
```


```{r}
caliper <- 0.1


# Perform matching with a caliper for age_entry_years
matched_data <- matchit(total_prevalent_PsA ~ age_entry_years + season_wear + sex, data = datPsoriatic, method = "nearest", caliper = caliper,ratio = 4, replace=FALSE)#

summary(matched_data)

# Extract the matched dataset (cases and their matched controls)
datMatchPsA <- match.data(matched_data)

```


Generate a table 1 - baseline demographics by non-psoriatic, psoriasis and PsA 
Create column called groups which returns for each of the above 3
```{r}
dat <- dat %>%
  mutate(groups = case_when(
    NonPsoriaticDisease == TRUE ~ "NonPsoriatic",
    Prevalent_PsO_lessPsA == TRUE ~ "Psoriasis",
    total_prevalent_PsA == TRUE ~ "PsA",
    TRUE ~ NA_character_
  ))
```

```{r} 
##AS

datAS <- subset(dat, !(total_prevalent_RA | total_prevalent_PsA))


#First create non-psoriatic group 
datAS$NonASDisease <- !datAS$total_prevalent_AS 

#Now we want to create a new column called FactorAnalysis which the above 3 factors 
datAS$AnalysisCategory <- ifelse(datAS$NonASDisease, 0,
                              ifelse(datAS$total_prevalent_AS , 1,
                                      NA))

#Set up a corresponding label to these categories 
labels2 <- c("Controls", "AnkSpond")

datAS$AnalysisLabel <- factor(datAS$AnalysisCategory, levels = 0:1, labels = labels2)

datAS <- datAS %>%
  mutate(groups = case_when(
    NonASDisease == TRUE ~ "Controls",
    total_prevalent_AS == TRUE ~ "Ankylosing Spondylitis",
    TRUE ~ NA_character_
  ))
```

```{r}
model_steps1 <- lm(med_steps ~ AnalysisLabel + as.factor(sex)  + as.factor(age_gp) + as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = datAS)
summary(model_steps1)
  confint(model_steps1)
  
emmeans_model_steps1_np<- emmeans(model_steps1, specs = "AnalysisLabel")
emmeans_model_steps1 <- emmeans(model_steps1, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_steps1_np)
summary(emmeans_model_steps1)
confint(emmeans_model_steps1)

```


```{r}
# Define the data frame for plotting
steps <- summary(emmeans_model_steps1_np, specs = "AnalysisLabel")[1:2, c(1, 2, 6, 5)]
names(steps) <- c("Quality", "Mean", "UpperCI", "LowerCI")
steps$Quality <- c("Non-AS", "Ankylosing Spondylitis")
steps$Quality <- factor(steps$Quality, levels = c("Non-AS", "Ankylosing Spondylitis"))

# Create the plot
steps_final <- ggplot() +
  geom_pointrange(data = steps, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 10100, by = 400), name = "Adjusted Mean Daily Step Count") +
  coord_cartesian(ylim = c(7000, 10100)) +
  xlab("") +
  geom_hline(yintercept = steps$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12))  # Increase caption font size

# Display the plot
print(steps_final)


# Close the TIFF graphics device
dev.off()
```

```{r}
dir.create("plots")
output_dir <- "plots"
output_file <- file.path(output_dir, "StepsBMI.tiff")
ggsave(output_file, steps_final, device = "tiff", width = 8, height = 6, dpi = 300)
```

Final model

```{r}
model_cadencePartial<- lm(CadencePeak30Adjusted.steps.min. ~ AnalysisLabel + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking) + as.factor(BMI_cats),  data = datAS)
summary(model_cadencePartial)
  confint(model_cadencePartial)
  
emmeans_model_cadencePartial_np<- emmeans(model_cadencePartial, specs = "AnalysisLabel")
emmeans_model_cadencePartial<- emmeans(model_cadencePartial, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_cadencePartial_np)
summary(emmeans_model_cadencePartial)
confint(emmeans_model_cadencePartial)
```

Final Cad model  
```{r}
cadencePartial <- summary(emmeans_model_cadencePartial_np, specs = "AnalysisLabel")[1:2,c(1,2,6,5)]
names(cadencePartial) <- c("Quality", "Mean", "UpperCI", "LowerCI")
cadencePartial$Quality <- c("Non-AS", "Ankylosing Spondylitis")
cadencePartial$Quality <- factor(cadencePartial$Quality, levels = c("Non-AS", "Ankylosing Spondylitis"))


cad_plotFinal <- ggplot() +
  geom_pointrange(data = cadencePartial, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 170, by = 2), name = "Adjusted Peak Cadence (Steps/in 30 mins)") +
  coord_cartesian(ylim = c(76, 96)) +
  xlab("") +
  geom_hline(yintercept = cadencePartial$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12))  # Increase caption font size

cad_plotFinal


``` 

```{r}
output_file <- file.path(output_dir, "Cadence3BMI.tiff")
ggsave(output_file, cad_plotFinal, device = "tiff", width = 8, height = 6, dpi = 300)
```

```{r}
model_cadencePartial<- lm(CadencePeak1Adjusted.steps.min. ~ AnalysisLabel + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = datAS)
summary(model_cadencePartial)
  confint(model_cadencePartial)
  
emmeans_model_cadencePartial_np<- emmeans(model_cadencePartial, specs = "AnalysisLabel")
emmeans_model_cadencePartial<- emmeans(model_cadencePartial, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_cadencePartial_np)
summary(emmeans_model_cadencePartial)
confint(emmeans_model_cadencePartial)
```

Final Cad model  
```{r}
cadencePartial <- summary(emmeans_model_cadencePartial_np, specs = "AnalysisLabel")[1:2,c(1,2,6,5)]
names(cadencePartial) <- c("Quality", "Mean", "UpperCI", "LowerCI")
cadencePartial$Quality <- c("Non-AS", "Ankylosing Spondylitis")
cadencePartial$Quality <- factor(cadencePartial$Quality, levels = c("Non-AS", "Ankylosing Spondylitis"))


cad_plotFinal <- ggplot() +
  geom_pointrange(data = cadencePartial, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 170, by = 2), name = "Adjusted Peak Cadence (Steps/in 1 min)") +
  coord_cartesian(ylim = c(90, 120)) +
  xlab("") +
  geom_hline(yintercept = cadencePartial$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12))  # Increase caption font size

cad_plotFinal


``` 

```{r}
dat <- dat %>%
  mutate(groups = case_when(
    NonPsoriaticDisease == TRUE ~ "NonPsoriatic",
    Prevalent_PsO_lessPsA == TRUE ~ "Psoriasis",
    total_prevalent_PsA == TRUE ~ "PsA",
    TRUE ~ NA_character_
  ))
```

We use the 'table1' package to 'cheat' and generate a nicely formatted table:
```{r}
# Add labels
label(datAS$age_entry_years)   <- "Age at accelerometer wear"
label(datAS$overall_activity_quarters) <- "Quarter of overall activity"
label(datAS$sex) <- "Sex"
label(datAS$ethnicity) <- "Ethnicity"
label(datAS$tdi_quarters) <- "Quarter of Townsend Deprivation Index"
label(datAS$age_education_revalued_raw) <- "Age completed full-time education"
label(datAS$smoking) <- "Smoking status"
label(datAS$alcohol) <- "Frequency of alcohol consumption"
label(datAS$BMI) <- "BMI (continuous)"
label(datAS$BMI_cats) <- "BMI (by categories)"
units(datAS$age_entry_years) <- "years"
units(datAS$overall_activity_quarters) <- "mg"

datAS$groups <- factor(datAS$groups, levels = c("Controls", "Ankylosing Spondylitis"))

# We'll customise how we render variables so rather than median (min, max) we present median (Q1, Q3)
#my_render_cont <- function(x){
 # with(
  #  stats.apply.rounding(stats.default(x)),
   # c(
    #  "",
     # `Mean (SD)` = sprintf("%s (%s)", MEAN, SD),
      #`Median [Q1, Q3]` = sprintf("%s [%s, %s]",
       #                             MEDIAN, Q1, Q3)
    #)
  #)
#}

# Make table
tab_desc <- table1::table1(~ age_entry_years + sex + ethnicity + tdi_quarters  + smoking + alcohol + BMI + BMI_cats  | groups, 
                           include_median = FALSE,
                           data = datAS
                         #  ,render.cont = my_render_cont
)
tab_desc
write(tab_desc, "descriptive_table.html")
```

We use the 'table1' package to 'cheat' and generate a nicely formatted table:
```{r}
# Add labels
label(dat$age_entry_years)   <- "Age at accelerometer wear"
label(dat$overall_activity_quarters) <- "Quarter of overall activity"
label(dat$sex) <- "Sex"
label(dat$ethnicity) <- "Ethnicity"
label(dat$tdi_quarters) <- "Quarter of Townsend Deprivation Index"
label(dat$age_education_revalued_raw) <- "Age completed full-time education"
label(dat$smoking) <- "Smoking status"
label(dat$alcohol) <- "Frequency of alcohol consumption"
label(dat$BMI) <- "BMI (continuous)"
label(dat$BMI_cats) <- "BMI (by categories)"
units(dat$age_entry_years) <- "years"
units(dat$overall_activity_quarters) <- "mg"

dat$groups <- factor(dat$groups, levels = c("NonPsoriatic", "Psoriasis", "PsA"))

# We'll customise how we render variables so rather than median (min, max) we present median (Q1, Q3)
#my_render_cont <- function(x){
 # with(
  #  stats.apply.rounding(stats.default(x)),
   # c(
    #  "",
     # `Mean (SD)` = sprintf("%s (%s)", MEAN, SD),
      #`Median [Q1, Q3]` = sprintf("%s [%s, %s]",
       #                             MEDIAN, Q1, Q3)
    #)
  #)
#}

# Make table
tab_desc <- table1::table1(~ age_entry_years + sex + ethnicity + tdi_quarters  + smoking + alcohol + BMI + BMI_cats  | groups, 
                           include_median = FALSE,
                           data = dat
                         #  ,render.cont = my_render_cont
)
tab_desc
write(tab_desc, "descriptive_table.html")
```

Report on comorbidities in HC, Psoriasis, and PsA 


Comorbidities table 
```{r}
label(dat$cci) <- "Charlson Comorbidity Index"
label(dat$major_coronary_disease_charlson) <- "Coronary artery disease"
label(dat$congestive_heart_failure_charlson_CH) <- "Congestive heart failure"
label(dat$diabetes_charlson_CH) <- "Diabetes"
label(dat$liver_disease_charlson_CH) <- "Chronic liver disease"
label(dat$cancer_charlson_CH) <- "Any cancer"
label(dat$depression) <- "Depression"
label(dat$cerebrovascular_disease_charlson_CH) <- "Cerebrovascular disease"
label(dat$copd_charlson_CH) <- "COPD"
label(dat$CCI_kim) <- "CCI by categories"
dat$CCI_kim <- factor(dat$CCI_kim, levels = c("None", "Mild to Moderate", "Severe"))


tab_descComorbid <- table1::table1(~ cci + age_entry_years+ major_coronary_disease_charlson_CH +cerebrovascular_disease_charlson_CH+ congestive_heart_failure_charlson_CH + diabetes_charlson_CH +liver_disease_charlson_CH+cancer_charlson_CH+copd_charlson_CH+depression  | groups, 
                           data = dat 
                          #  ,render.cont = my_render_cont
)
tab_descComorbid

tab_descSteps <- table1::table1(~ med_steps  | groups, 
                           data = dat 
                          #  ,render.cont = my_render_cont
)
tab_descSteps
 

write(tab_descComorbid, "descriptive_table2.html")
```

```{r}
dat$ComorbidityNumber2 <- rowSums(dat[c("major_coronary_disease_charlson_CH", 
                                       "cerebrovascular_disease_charlson_CH", 
                                       "congestive_heart_failure_charlson_CH",
                                       "diabetes_charlson_CH", 
                                       "liver_disease_charlson_CH",
                                       "copd_charlson_CH","cancer_charlson_CH",
                                       "peripheral_vascular_disease_charlson_CH",
                                       "paraplegia_charlson",
                                       "peptic_ulcer_charlson",
                                       "renal_disease_charlson_CH")] == TRUE, na.rm = FALSE)

hist(dat$ComorbidityNumber)

dat$Comorbidity <- dat$ComorbidityNumber2 > 1



dat$Comorbidity <- dat$cci > 1

```

```{r}
dat_PsO <- dat[dat$Prevalent_PsO_lessPsA == TRUE, ]

# Create the histogram
ggplot(dat_PsA, aes(x = ComorbidityNumber)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  labs(title = "Histogram of Comorbidity Numbers for PsA Patients",
       x = "Number of Comorbidities",
       y = "Frequency")
```

###Model for inclusion!! 
```{r}
model_steps1 <- lm(med_steps ~ AnalysisLabel + as.factor(sex)  + as.factor(age_gp) + as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_steps1)
  confint(model_steps1)
  
emmeans_model_steps1_np<- emmeans(model_steps1, specs = "AnalysisLabel")
emmeans_model_steps1 <- emmeans(model_steps1, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_steps1_np)
summary(emmeans_model_steps1)
confint(emmeans_model_steps1)

```


```{r}
# Define the data frame for plotting
steps <- summary(emmeans_model_steps1_np, specs = "AnalysisLabel")[1:3, c(1, 2, 6, 5)]
names(steps) <- c("Quality", "Mean", "UpperCI", "LowerCI")
steps$Quality <- c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis")
steps$Quality <- factor(steps$Quality, levels = c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis"))

# Create the plot
steps_final <- ggplot() +
  geom_pointrange(data = steps, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 10100, by = 200), name = "Adjusted Mean Daily Step Count") +
  coord_cartesian(ylim = c(7600, 9600)) +
  xlab("") +
  geom_hline(yintercept = steps$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12))  # Increase caption font size

# Display the plot
print(steps_final)


# Close the TIFF graphics device
dev.off()
```

```{r}
dir.create("plots")
output_dir <- "plots"
output_file <- file.path(output_dir, "Steps3.tiff")
ggsave(output_file, steps_final, device = "tiff", width = 8, height = 6, dpi = 300)
```

Final model

```{r}
model_cadencePartial<- lm(CadencePeak30Adjusted.steps.min. ~ AnalysisLabel + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking)+as.factor(BMI_cats),  data = dat)
summary(model_cadencePartial)
  confint(model_cadencePartial)
  
emmeans_model_cadencePartial_np<- emmeans(model_cadencePartial, specs = "AnalysisLabel")
emmeans_model_cadencePartial<- emmeans(model_cadencePartial, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_cadencePartial_np)
summary(emmeans_model_cadencePartial)
confint(emmeans_model_cadencePartial)
```

Final Cad model  
```{r}
cadencePartial <- summary(emmeans_model_cadencePartial_np, specs = "AnalysisLabel")[1:3,c(1,2,6,5)]
names(cadencePartial) <- c("Quality", "Mean", "UpperCI", "LowerCI")
cadencePartial$Quality <- c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis")
cadencePartial$Quality <- factor(cadencePartial$Quality, levels = c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis"))


cad_plotFinal <- ggplot() +
  geom_pointrange(data = cadencePartial, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 170, by = 2), name = "Adjusted Peak Cadence (Steps/in 30 mins)") +
  coord_cartesian(ylim = c(76, 96)) +
  xlab("") +
  geom_hline(yintercept = cadencePartial$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12))  # Increase caption font size

cad_plotFinal


``` 

```{r}
output_file <- file.path(output_dir, "Cadence3.tiff")
ggsave(output_file, cad_plotFinal, device = "tiff", width = 8, height = 6, dpi = 300)
```


MVPA time 
```{r}
model_MVPA <- lm(MVPA_overall_average*1440~ AnalysisLabel  + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_MVPA)
confint(model_MVPA)

emmeans_model_MVPA_np <- emmeans(model_MVPA, specs = "AnalysisLabel")
emmeans_model_MVPA <- emmeans(model_MVPA, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_MVPA)
confint(emmeans_model_MVPA)
```

```{r}
MVPA <- summary(emmeans_model_MVPA_np, specs = "AnalysisLabel")[1:3,c(1,2,6,5)]
names(MVPA) <- c("Quality", "Mean", "UpperCI", "LowerCI")
MVPA$Quality <- c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis")
MVPA$Quality <- factor(MVPA$Quality, levels = c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis"))

# Create forest plot
mvpa_plot <- ggplot() +
  geom_pointrange(data = MVPA, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 120, by = 2), name = "Adjusted Mean MVPA (Minutes/Day)") +
  coord_cartesian(ylim = c(26, 46)) +
  xlab("") +
  geom_hline(yintercept = MVPA$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) + 
  theme(axis.text.x.bottom = element_text(size = 12))  # Increase x-axis text font size

mvpa_plot

```

```{r}
output_file <- file.path(output_dir, "MVPA3.tiff")
ggsave(output_file, mvpa_plot, device = "tiff", width = 8, height = 6, dpi = 300)
```


Sedentary time 

```{r}
model_sed <- lm(sedentary_overall_average*1440~ AnalysisLabel  + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_sed)
confint(model_sed)

emmeans_model_sed_np <- emmeans(model_sed, specs = "AnalysisLabel")
emmeans_model_sed <- emmeans(model_sed, specs = pairwise~ AnalysisLabel)
summary(emmeans_model_sed)
confint(emmeans_model_sed)
```


```{r}
sed <- summary(emmeans_model_sed_np, specs = "AnalysisLabel")[1:3,c(1,2,6,5)]
names(sed) <- c("Quality", "Mean", "UpperCI", "LowerCI")
sed$Quality <- c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis")
sed$Quality <- factor(sed$Quality, levels = c("Non-Psoriatic", "Psoriasis only", "Psoriatic arthritis"))



# Create forest plot
sed_plot <- ggplot() +
  geom_pointrange(data = sed, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(500, 628, by = 8), name = "Adjusted Mean Sedentary time (Minutes/Day)") +
  coord_cartesian(ylim = c(540, 628)) +
  xlab("") +
  geom_hline(yintercept = sed$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12))  # Increase x-axis text font size

sed_plot

```

```{r}
output_file <- file.path(output_dir, "Sed3.tiff")
ggsave(output_file, sed_plot, device = "tiff", width = 8, height = 6, dpi = 300)
```

```{r}
dat$PsANone <- with(dat, (cci_huang == "None")  & total_prevalent_PsA)
dat$PsAMildModerate <- with(dat, (cci_huang == "Mild to Moderate")  & total_prevalent_PsA)
dat$PsASevere <- with(dat, (cci_huang == "Severe")  & total_prevalent_PsA)

dat$PsONone <- with(dat, (cci_huang == "None")  & Prevalent_PsO_lessPsA)
dat$PsOMildModerate <- with(dat, (cci_huang == "Mild to Moderate")  & Prevalent_PsO_lessPsA)
dat$PsOSevere <- with(dat, (cci_huang == "Severe")  & Prevalent_PsO_lessPsA)

dat$None <- with(dat, (cci_huang == "None")  & !(Prevalent_PsO_lessPsA|total_prevalent_PsA))
dat$MildModerate <- with(dat, (cci_huang == "Mild to Moderate")  & !(Prevalent_PsO_lessPsA|total_prevalent_PsA))
dat$Severe <- with(dat, (cci_huang == "Severe")  & !(Prevalent_PsO_lessPsA|total_prevalent_PsA))

                                   
dat <- dat %>% 
  mutate(PsoriaticHuang = case_when(
    PsASevere ~ 8,
    PsAMildModerate ~ 7,
    PsANone ~ 6, 
    PsOSevere ~ 5,
    PsOMildModerate ~4, 
    PsONone ~ 3, 
    Severe ~ 2, 
    MildModerate ~ 1,
    None ~ 0, 
    TRUE ~ NA_real_  # default case if none of the above conditions are met
  ))

labels3 <- c("None", "Mild to Moderate", "Severe", "PsONone", "PsOMild to Moderate", "PsOSevere", "PsANone", "PsAMild to Moderate", "PsASevere")

dat$PsoriaticHuang <- factor(dat$PsoriaticHuang, levels = 0:8, labels = labels3)
                           

```

```{r}
model_steps1 <- lm(med_steps ~ PsoriaticHuang + as.factor(sex)  + as.factor(age_gp) + as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_steps1)
  confint(model_steps1)

emm_options(rg.limit = 150000)
  
emmeans_model_steps1_np<- emmeans(model_steps1, specs = "PsoriaticHuang")
emmeans_model_steps1 <- emmeans(model_steps1, specs = pairwise~ PsoriaticHuang)
summary(emmeans_model_steps1_np)
summary(emmeans_model_steps1)
confint(emmeans_model_steps1)

```

```{r}
steps <- summary(emmeans_model_steps1_np, specs = "PsoriaticComorbid")[1:9, c(1, 2, 6, 5)]
names(steps) <- c("Quality", "Mean", "UpperCI", "LowerCI")
steps$Quality <- c("None","Mild-Moderate", "Severe", "None ","Mild-Moderate ", "Severe ","None  ","Mild-Moderate  ", "Severe  ")
steps$Quality <- factor(steps$Quality, levels = c("None","Mild-Moderate", "Severe", "None ","Mild-Moderate ", "Severe ","None  ","Mild-Moderate  ", "Severe  "))

# Create the plot
step_plotComorbid <- ggplot(steps, aes(x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI, color = factor(Quality))) +
  geom_pointrange(size = 1, shape = 20) +
  theme_minimal(base_size = 14) + 
  theme_light() +
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 10000, by = 1000), name = "Adjusted Mean Daily Step Count") +
  coord_cartesian(ylim = c(4000, 10000)) +
  xlab("") +
  geom_hline(yintercept = steps$Mean[1], linetype = "dashed", color = "black", size = 0.5) +
  theme(axis.title.x = element_text(vjust = -1,size=14)) +
  theme(plot.caption = element_text(hjust = 0))+
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +
  theme(axis.title.y = element_text(size = 14))

step_plotComorbid

```

```{r}
model_cadenceCCI<- lm(CadencePeak30Adjusted.steps.min. ~ PsoriaticHuang + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_cadenceCCI)
  confint(model_cadenceCCI)
  
emmeans_model_cadenceCCI_np<- emmeans(model_cadenceCCI, specs = "PsoriaticHuang")
emmeans_model_cadenceCCI<- emmeans(model_cadenceCCI, specs = pairwise~ PsoriaticHuang)
summary(emmeans_model_cadenceCCI_np)
summary(emmeans_model_cadenceCCI)
confint(emmeans_model_cadenceCCI)
```

Plot of CCI model 
```{r}


cadenceCCI <- summary(emmeans_model_cadenceCCI_np, specs = "PsoriaticHuang")[1:9, c(1, 2, 6, 5)]
names(cadenceCCI) <- c("Quality", "Mean", "UpperCI", "LowerCI")
cadenceCCI$Quality <-c("None","Mild-Moderate", "Severe", "None ","Mild-Moderate ", "Severe ","None  ","Mild-Moderate  ", "Severe  ")
cadenceCCI$Quality <- factor(steps$Quality,levels = c("None","Mild-Moderate", "Severe", "None ","Mild-Moderate ", "Severe ","None  ","Mild-Moderate  ", "Severe  "))

cad_plotComorbid <- ggplot() +
  geom_pointrange(data = cadenceCCI, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme_light()+
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 170, by = 4), name = "Adjusted Peak Cadence 30 (Steps/min)") +
  coord_cartesian(ylim = c(68, 94)) +
  xlab("") +
  geom_hline(yintercept = cadenceCCI$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) + # Increase caption font size
  theme(axis.title.y = element_text(size = 14))


cad_plotComorbid
```


```{r}
dat$NonPsoriaticComorbid <- with(dat, Comorbidity &
                                   !(total_prevalent_PsA|Prevalent_PsO_lessPsA))

dat$PsAComorbid <- with(dat, total_prevalent_PsA & Comorbidity)
dat$PsAwithoutComorbid <- with(dat, total_prevalent_PsA & !Comorbidity)

dat$PsOComorbid  <- with(dat, Prevalent_PsO_lessPsA & Comorbidity)
dat$PsOwithoutComorbid  <- with(dat, Prevalent_PsO_lessPsA & !Comorbidity)

dat <- dat %>% 
  mutate(PsoriaticComorbid = case_when(
    PsAComorbid ~ 5,
    PsAwithoutComorbid ~ 4,
    PsOComorbid ~ 3,
    PsOwithoutComorbid ~ 2,
    NonPsoriaticComorbid ~ 1,
    NonPsoriaticDisease ~ 0,
    TRUE ~ NA_real_  # default case if none of the above conditions are met
  ))
                                     
#Set up a corresponding label to these categories 
labels3 <- c("NonPsoriaticDisease", "NonPsoriaticDisease + comorbidity", "PsO + no comorbidity", "PsO + comorbidity", "PsA + no comorbidity", "PsA + comorbidity")

dat$PsoriaticComorbid <- factor(dat$PsoriaticComorbid, levels = 0:5, labels = labels3)
```

```{r}
model_steps1 <- lm(med_steps ~ PsoriaticComorbid + as.factor(sex)  + as.factor(age_gp) + as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_steps1)
  confint(model_steps1)
  
emmeans_model_steps1_np<- emmeans(model_steps1, specs = "PsoriaticComorbid")
emmeans_model_steps1 <- emmeans(model_steps1, specs = pairwise~ PsoriaticComorbid)
summary(emmeans_model_steps1_np)
summary(emmeans_model_steps1)
confint(emmeans_model_steps1)

```

```{r}

# Define the data frame for plotting
steps <- summary(emmeans_model_steps1_np, specs = "PsoriaticComorbid")[1:6, c(1, 2, 6, 5)]
names(steps) <- c("Quality", "Mean", "UpperCI", "LowerCI")
steps$Quality <- c("Non-\nPsoriatic","Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity")
steps$Quality <- factor(steps$Quality, levels = c("Non-\nPsoriatic", "Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity"))

# Create the plot
step_plotComorbid <- ggplot(steps, aes(x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI, color = factor(Quality))) +
  geom_pointrange(size = 1, shape = 20) +
  theme_minimal(base_size = 14) + 
  theme_light() +
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 10000, by = 1000), name = "Adjusted Mean Daily Step Count") +
  coord_cartesian(ylim = c(4000, 10000)) +
  xlab("") +
  geom_hline(yintercept = steps$Mean[1], linetype = "dashed", color = "black", size = 0.5) +
  theme(axis.title.x = element_text(vjust = -1,size=14)) +
  theme(plot.caption = element_text(hjust = 0))+
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +
  theme(axis.title.y = element_text(size = 14))


# Display the plot
print(step_plotComorbid) 
```

```{r}
output_file <- file.path(output_dir, "StepComorbid.tiff")
ggsave(output_file, step_plotComorbid, device = "tiff", width = 8, height = 6, dpi = 300)
```


```{r}
model_cadenceCCI<- lm(CadencePeak30Adjusted.steps.min. ~ PsoriaticComorbid + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_cadenceCCI)
  confint(model_cadenceCCI)
  
emmeans_model_cadenceCCI_np<- emmeans(model_cadenceCCI, specs = "PsoriaticComorbid")
emmeans_model_cadenceCCI<- emmeans(model_cadenceCCI, specs = pairwise~ PsoriaticComorbid)
summary(emmeans_model_cadenceCCI_np)
summary(emmeans_model_cadenceCCI)
confint(emmeans_model_cadenceCCI)
```

Plot of CCI model 
```{r}


cadenceCCI <- summary(emmeans_model_cadenceCCI_np, specs = "PsoriaticComorbid")[1:6, c(1, 2, 6, 5)]
names(cadenceCCI) <- c("Quality", "Mean", "UpperCI", "LowerCI")
cadenceCCI$Quality <- c("Non-\nPsoriatic","Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity")
cadenceCCI$Quality <- factor(steps$Quality, levels = c("Non-\nPsoriatic", "Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity"))

cad_plotComorbid <- ggplot() +
  geom_pointrange(data = cadenceCCI, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme_light()+
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 170, by = 4), name = "Adjusted Peak Cadence 30 (Steps/min)") +
  coord_cartesian(ylim = c(68, 94)) +
  xlab("") +
  geom_hline(yintercept = cadenceCCI$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) + # Increase caption font size
  theme(axis.title.y = element_text(size = 14))


cad_plotComorbid
```

```{r}
output_file <- file.path(output_dir, "CadComorbid.tiff")
ggsave(output_file, cad_plotComorbid, device = "tiff", width = 8, height = 6, dpi = 300)
```

```{r}
model_sedComorbid <- lm(sedentary_overall_average*1440~ PsoriaticComorbid  + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_sedComorbid)
confint(model_sedComorbid)

emmeans_model_sedComorbid_np <- emmeans(model_sedComorbid, specs = "PsoriaticComorbid")
emmeans_model_sedComorbid <- emmeans(model_sedComorbid, specs = pairwise~ PsoriaticComorbid)
summary(emmeans_model_sedComorbid)
confint(emmeans_model_sedComorbid)
```

```{r}
Sedcomorbid <- summary(emmeans_model_sedComorbid_np, specs = "PsoriaticComorbid")[1:6, c(1, 2, 6, 5)]
names(Sedcomorbid) <- c("Quality", "Mean", "UpperCI", "LowerCI")
Sedcomorbid$Quality <- c("Non-\nPsoriatic","Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity")
Sedcomorbid$Quality <- factor(Sedcomorbid$Quality, levels = c("Non-\nPsoriatic", "Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity"))

sed_plotComorbid <- ggplot() +
  geom_pointrange(data = Sedcomorbid, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme_light()+
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(500, 720, by = 20), name = "Adjusted Mean Sedentary time (Minutes/Day)") +
  coord_cartesian(ylim = c(540, 720)) +
  xlab("") +
  geom_hline(yintercept = Sedcomorbid$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) + # Increase x-axis text font size
 theme(axis.title.y = element_text(size = 12))

sed_plotComorbid


```


```{r}
output_file <- file.path(output_dir, "SedComorbid.tiff")
ggsave(output_file, sed_plotComorbid, device = "tiff", width = 8, height = 6, dpi = 300)
```


MVPA time 
```{r}
model_MVPA <- lm(MVPA_overall_average*1440~ PsoriaticComorbid  + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_MVPA)
confint(model_MVPA)

emmeans_model_MVPA_np <- emmeans(model_MVPA, specs = "PsoriaticComorbid")
emmeans_model_MVPA <- emmeans(model_MVPA, specs = pairwise~ PsoriaticComorbid)
summary(emmeans_model_MVPA)
confint(emmeans_model_MVPA)
```

```{r}
MVPA <- summary(emmeans_model_MVPA_np, specs = "PsoriaticComorbid")[1:6, c(1, 2, 6, 5)]
names(MVPA) <- c("Quality", "Mean", "UpperCI", "LowerCI")
MVPA$Quality <-  c("Non-\nPsoriatic","Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity")
MVPA$Quality <- factor(MVPA$Quality, levels = c("Non-\nPsoriatic", "Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity"))

mvpa_plot <- ggplot() +
  geom_pointrange(data = MVPA, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme_light()+
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 120, by = 6), name = "Adjusted Mean MVPA (Minutes/Day)") +
  coord_cartesian(ylim = c(5, 44)) +
  xlab("") +
  geom_hline(yintercept = MVPA$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) + 
  theme(axis.text.x.bottom = element_text(size = 12))+
    theme(axis.title.y = element_text(size = 12))# Increase x-axis text font size

mvpa_plot

```

```{r}
output_file <- file.path(output_dir, "MVPAComorbid.tiff")
ggsave(output_file, mvpa_plot, device = "tiff", width = 8, height = 6, dpi = 300)
```


```{r}

dat$NonPsoriaticDepression <- with(dat, depression &
                                   !(total_prevalent_PsA|Prevalent_PsO_lessPsA))

dat$PsADepression <- with(dat, total_prevalent_PsA & depression)
dat$PsAwithoutDepression <- with(dat, total_prevalent_PsA & !depression)

dat$PsODepression <- with(dat, Prevalent_PsO_lessPsA & depression)
dat$PsOwithoutDepression <- with(dat, Prevalent_PsO_lessPsA & !depression)

dat <- dat %>%
  mutate(PsoriaticDepression = case_when(
    PsADepression ~ 5, 
    PsAwithoutDepression ~ 4,
    PsODepression ~ 3,
    PsOwithoutDepression ~ 2,
    NonPsoriaticDepression ~1,
    NonPsoriaticDisease ~ 0,
    TRUE ~ NA_real_,
  ))

                                     
#Set up a corresponding label to these categories 
labels3 <- c("NonPsoriaticDisease", "NonPsoriaticDisease + depression", "PsO + no depression", "PsO + depression", "PsA + no depression", "PsA + depression")

dat$PsoriaticDepression <- factor(dat$PsoriaticDepression, levels = 0:5, labels = labels3)
```

```{r}
model_steps1 <- lm(med_steps ~ PsoriaticDepression + as.factor(sex)  + as.factor(age_gp) + as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_steps1)
  confint(model_steps1)
  
emmeans_model_steps1_np<- emmeans(model_steps1, specs = "PsoriaticDepression")
emmeans_model_steps1 <- emmeans(model_steps1, specs = pairwise~ PsoriaticDepression)
summary(emmeans_model_steps1_np)
summary(emmeans_model_steps1)
confint(emmeans_model_steps1)

```


```{r}

# Define the data frame for plotting
steps <- summary(emmeans_model_steps1_np, specs = "PsoriaticDepression")[1:6, c(1, 2, 6, 5)]
names(steps) <- c("Quality", "Mean", "UpperCI", "LowerCI")
steps$Quality <- c("Non-\nPsoriatic", "Non-Psoriatic\n+depression", "PsO", "PsO\n+depression", "PsA", "PsA\n+depression")
steps$Quality <- factor(steps$Quality, levels = c("Non-\nPsoriatic", "Non-Psoriatic\n+depression", "PsO", "PsO\n+depression", "PsA", "PsA\n+depression"))

# Create the plot
step_plot1 <- ggplot(steps, aes(x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI, color = factor(Quality))) +
  geom_pointrange(size = 1, shape = 20) +
  theme_light() +
  theme(panel.grid.minor = element_blank()) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 11000, by = 400), name = "Adjusted Mean Daily Step Count") +
  coord_cartesian(ylim = c(7000, 10000)) +
  xlab("") +
  geom_hline(yintercept = steps$Mean[1], linetype = "dashed", color = "black", size = 0.5) +
  theme(axis.title.x = element_text(vjust = -1)) +
  theme(axis.text.y.left = element_text(size = 14)) +
  theme(axis.text.x.bottom = element_text(size = 14)) +
  theme(plot.caption = element_text(hjust = 0))+
  theme(axis.title.y = element_text(size = 12))# Increase x-axis text font size

# Display the plot
print(step_plot1)



```
```{r}
output_file <- file.path(output_dir, "StepsDepression.tiff")
ggsave(output_file, step_plot1, device = "tiff", width = 8, height = 6, dpi = 300)
```


cadence model

```{r}
model_cadenceCCI<- lm(CadencePeak30Adjusted.steps.min. ~ PsoriaticDepression + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_cadenceCCI)
  confint(model_cadenceCCI)
  
emmeans_model_cadenceCCI_np<- emmeans(model_cadenceCCI, specs = "PsoriaticDepression")
emmeans_model_cadenceCCI<- emmeans(model_cadenceCCI, specs = pairwise~ PsoriaticDepression)
summary(emmeans_model_cadenceCCI_np)
summary(emmeans_model_cadenceCCI)
confint(emmeans_model_cadenceCCI)
```

Plot of CCI model 
```{r}
cadenceCCI <- summary(emmeans_model_cadenceCCI_np, specs = "PsoriaticDepression")[1:6,c(1,2,6,5)]
names(cadenceCCI) <- c("Quality", "Mean", "UpperCI", "LowerCI")
cadenceCCI$Quality <-  c("Non-\nPsoriatic", "Non-Psoriatic\n+depression", "PsO", "PsO\n+depression", "PsA", "PsA\n+depression")
cadenceCCI$Quality <- factor(cadenceCCI$Quality,  c("Non-\nPsoriatic", "Non-Psoriatic\n+depression", "PsO", "PsO\n+depression", "PsA", "PsA\n+depression"))

cad_plotCCI <- ggplot() +
  geom_pointrange(data = cadenceCCI, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme_light() +
  theme(legend.position = "none") +

  scale_y_continuous(breaks = seq(0, 170, by = 2), name = "Adjusted Peak Cadence 30 (Steps/min)") +
  coord_cartesian(ylim = c(76, 96)) +
  xlab("") +
  geom_hline(yintercept = cadenceCCI$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) +  # Increase y-axis text font size
  theme(axis.text.x.bottom = element_text(size = 12)) +  # Increase x-axis text font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +  # Increase caption font size
  theme(plot.caption = element_text(hjust = 0, size = 12)) +
   theme(axis.title.y = element_text(size = 12))# Increase caption font size

cad_plotCCI
```

```{r}
output_file <- file.path(output_dir, "CadenceDepression.tiff")
ggsave(output_file, cad_plotCCI, device = "tiff", width = 8, height = 6, dpi = 300)
```

```{r}
model_MVPA <- lm(MVPA_overall_average*1440~ PsoriaticDepression  + as.factor(age_gp)+as.factor(sex)+as.factor(season_wear)+ as.factor(tdi_cats) + as.factor(alcohol) + as.factor(smoking),  data = dat)
summary(model_MVPA)
confint(model_MVPA)

emmeans_model_MVPA_np <- emmeans(model_MVPA, specs = "PsoriaticDepression")
emmeans_model_MVPA <- emmeans(model_MVPA, specs = pairwise~ PsoriaticDepression)
summary(emmeans_model_MVPA)
confint(emmeans_model_MVPA)
```

```{r}
MVPA <- summary(emmeans_model_MVPA_np, specs = "PsoriaticDepression")[1:6, c(1, 2, 6, 5)]
names(MVPA) <- c("Quality", "Mean", "UpperCI", "LowerCI")
MVPA$Quality <-  c("Non-\nPsoriatic","Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity")
MVPA$Quality <- factor(MVPA$Quality, levels = c("Non-\nPsoriatic", "Non-Psoriatic+\ncomorbidity", "PsO", "PsO+\ncomorbidity", "PsA", "PsA+\ncomorbidity"))

mvpa_plot <- ggplot() +
  geom_pointrange(data = MVPA, mapping = aes(color = factor(Quality), x = Quality, y = Mean, ymin = LowerCI, ymax = UpperCI),
                  size = 1, shape = 20) +  # Increase size
  theme_minimal(base_size = 14) +  # Increase base font size
  theme(panel.grid.minor = element_blank()) +
  theme_light()+
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 120, by = 6), name = "Adjusted Mean MVPA (Minutes/Day)") +
  coord_cartesian(ylim = c(5, 44)) +
  xlab("") +
  geom_hline(yintercept = MVPA$Mean[1], linetype = "dashed", color = "black", size = 0.5) +  # Increase size
  theme(axis.title.x = element_text(vjust = -1, size = 14)) +  # Increase x-axis title font size
  theme(axis.text.y.left = element_text(size = 12)) + 
  theme(axis.text.x.bottom = element_text(size = 12))+
    theme(axis.title.y = element_text(size = 12))# Increase x-axis text font size

mvpa_plot

```







