---
title: "ExtractingGPdata"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "R Notebook"
output: rmarkdown::github_document
---

# Further data preparation in R 
testing

## Introduction

In this notebook, we will prepare data for analysis.

Extract GP data 


## How to run this notebook

This notebook should be run in a *RStudio* session. It does *not* require a Spark cluster. See how to set it up [here](https://dnanexus.gitbook.io/uk-biobank-rap/working-on-the-research-analysis-platform/using-rstudio-on-the-research-analysis-platform).

## Set up the session

We load packages we'll use:

```{r, include=FALSE}
# First we need to install packages that aren't already present
pkgs <- c("data.table", "plyr", "dplyr","stringr") # packages we need
pkgs_inst <- pkgs[!{pkgs %in% rownames(installed.packages())}] # check which are not present 
install.packages(pkgs_inst, repos = "https://www.stats.bris.ac.uk/R/") # install

# Load packages
lapply(pkgs, library, character.only = TRUE) # using lapply just allows us to load several packages on one line - this could be replaced with several calls to library()
```

dx download - downloads stored permanent storage RAP data into my temporary session
Needs bash to run 
```{bash}
cd ~/rap_wearables

dx download /events_data.csv
dx download /gp_r2_map_r3.csv
dx download /participant_wacc_data.csv
```


First to make less computationally expensive -we will limits the total GP events file to only include eid found in the imaging population. This will massively reduce time to

```{r}
dat_GPevent <- fread("events_data.csv", data.table = FALSE)
dat_GPmap <- fread("gp_r2_map_r3.csv", data.table = FALSE)
dat_eid <-  fread("participant_wacc_data.csv", data.table = FALSE)

```

Subset to dat with date_inst_2
```{r}
library(dplyr)

# Keep only the eid column
dat_eid <- dat_eid %>% 
  select(eid, date_inst_2)

# Display the resulting data frame
print(dat_eid)
```

```{r}
# Step 1: Join dat_GPevent with dat_eid to get date_inst_2 for each eid and filter to keep only rows in dat_GPevent that are in dat_eid
dat_GPevent <- dat_GPevent %>%
  inner_join(dat_eid %>% select(eid, date_inst_2), by = "eid")

# Step 2: Filter out rows in dat_GPevent where event_dt is after date_inst_2
dat_GPevent <- dat_GPevent %>%
  filter(event_dt <= date_inst_2)

```

Format dates so we loop through to generate prevalent cases 
```{r}
dat_eid$date_inst_2 <- as.Date(dat_eid$date_inst_2, format="%Y-%m-%d")
dat_GPevent$event_dt <- as.Date(dat_GPevent$event_dt, format="%Y-%m-%d")
```

Function to find prevalent cases and join them up with main data table 
```{r}
# Function to identify prevalent cases based on provided patterns
identify_prevalent_cases <- function(dat_eid, dat_GPevent, read2_pattern, read3_pattern, disease_name) {
  # Filter for relevant cases in dat_GPevent
  cases <- dat_GPevent %>%
    filter((grepl(read2_pattern, read_2, ignore.case = TRUE) |
            grepl(read3_pattern, read_3, ignore.case = TRUE)) &
           !is.na(event_dt)) %>%
    select(eid)
  
  # Mark prevalent cases in dat_eid
  dat_eid <- dat_eid %>%
    mutate(!!paste0(disease_name, "_prevalent_GP") := eid %in% cases$eid)
  
  return(dat_eid)
}

```

```{r}
# Define the regex patterns for PsO codes
PsO_Read2Strings <- "^(M16[^0|^2|^3|^4|^5].*$|Myu30|14F2.)"
PsO_Read3strings <- "^M16[^0|^2|^3|^4|^5].*$|Myu30|X506Y|X506Z|X506a|X506b|X506c|X506d|X506e|X506f|X506g|X506h|X506i|X506j|X506k|X506l|X506m|X506n|X506o|X506p|X506q|X506r|X506s|X506t|X506u|X506v|XE1CQ|XaNXa|XaNXt|XaYOx"

# Apply the function to identify Psoriasis cases
dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, PsO_Read2Strings, PsO_Read3strings, "PsO")

# Print the resulting data frame with the new column
print(dat_eid)
```

Look up script 
```{r}
psori_table <- dat_GPmap %>%
  filter(grepl("psoria", READV2_DESC, ignore.case = FALSE))

```

Ank Spond  
```{r}
AS_codes <- "^(N100.|N11F.|Nyu61|388p.00|XaN24|N0450|X701x|N10..00|388p.)$"

# Apply the function to identify Psoriasis cases
dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, AS_codes, AS_codes, "AS")

# Print the resulting data frame with the new column
print(dat_eid)
```


PsA
```{r}
PsA_Read2Strings <- "^(?i)(M160(.*)|M1602|N0452|Nyu13)"
PsA_Read3Strings  <-"^(?i)(M160(.*)|M1600|M160z|Nyu13|X701u|X701v|X701w|X7026|X7027|X7028)"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, PsA_Read2Strings, PsA_Read3Strings, "PsA")
```


```{r}
rheumatoid_table <- dat_GPmap %>%
  filter(grepl("Adult-onset Still's disease|Rheumatoid arthrit. monitoring|Caplan's syndrome|Rheumatoid arthritis of cervical spine|Rheumatoid carditis|Myopathy due to rheumatoid arthritis|Rheumatoid arthritis of shoulder|Rheumatoid vasculitis|Other rheumatoid arthropathy + visceral/systemic involvement|Rheumatoid arthritis of ankle|Rheumatoid arthritis of knee|Seropositive rheumatoid arthritis|Seropositive erosive rheumatoid arthritis|Swan-neck finger deformity|Rheumatoid arthritis of sternoclavicular joint|Flare of rheumatoid arthritis|Seronegative rheumatoid arthritis|Rheumatoid arthritis of lesser MTP joint|[X]Seropositive rheumatoid arthritis unspecified|Rheumatoid arthritis of MCP joint|Rheumatoid arthritis monitoring invitation third letter|O/E - hands - ulnar deviation|[X]Rheumatoid arthritis+involvement/other organs or systems|Delivery of rehabilitation for rheumatoid arthritis|Rheumatoid arthritis of talonavicular joint|[X]Other specified rheumatoid arthritis|Felty's syndrome|Rheumatoid nodule|O/E - ulnar deviation|Rheumatoid arthritis of PIP joint of finger|Rheumatoid arthritis monitoring invitation first letter|Rheumatoid arthropathy + visceral/systemic involvement NOS|Rheumatoid arthritis of acromioclavicular joint|Rheumatoid lung disease|Rheumatoid arthritis monitoring invitation|O/E-hands-rheumatoid spindling|Other rheumatoid arthritis of spine|Polyneuropathy in rheumatoid arthritis|Rheumatoid arthritis of hip|Rheumatoid arthritis - multiple joint|Rheumatoid arthritis of subtalar joint|Adult Still's Disease|Rheumatoid arthritis of tibio-fibular joint|Rheumatoid lung|Rheumatoid arthritis monitoring invitation second letter|Rheumatoid myocarditis|Rheumatoid arthritis of DIP joint of finger|Rheumatoid arthritis|Rheumatoid arthritis of wrist|Rheumatoid arthritis of IP joint of toe|H/O: rheumatoid arthritis|Rheumatoid arthritis monitoring telephone invitation|Rheumatoid arthritis of sacro-iliac joint|Rheumatoid arthritis and other inflammatory polyarthropathy|Rheumatoid arthritis of elbow|Rheumatoid arthritis monitoring verbal invitation|Rheumatoid bursitis|Rheumatoid arthritis of distal radio-ulnar joint|[X]Other seropositive rheumatoid arthritis|Fibrosing alveolitis associated with rheumatoid arthritis|Rheumatoid arthritis of other tarsal joint|Rheumatoid arthritis of 1st MTP joint|Rheumatoid nodule|Rheumatoid lung", READV2_DESC, ignore.case = FALSE))


rheumatoid_table <- rheumatoid_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

rheumatoid_table <- rheumatoid_table[!grepl("FH: |O/E - hands - ulnar deviation|agglutination |screen|Still's|Swan-neck", rheumatoid_table$READV2_DESC, ignore.case = TRUE), ]



rheumatoid_2 <- rheumatoid_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
rheumatoid_2

rheumatoid_3 <- rheumatoid_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
rheumatoid_3

```

```{r}
RA_read2 <- "^(14G1.|2G27.|66HB0|7P203|9mM..|9mM0.|9mM1.|9mM2.|9mM3.|9mM4.|F3712|F3964|G5y8.|G5yA.|H570.|N04..|N04..|N040.|N0400|N0401|N0402|N0403|N0404|N0405|N0406|N0407|N0408|N0409|N040A|N040B|N040C|N040D|N040E|N040F|N040G|N040H|N040J|N040K|N040L|N040M|N040N|N040P|N040Q|N040R|N040S|N040T|N041.|N0421|N0422|N04X.|N04y0|N04y0|N04y0|N04y0|Nyu10|Nyu1G)$"
RA_read3 <- "^(14G1.|2G27.|XaZdB|XaLsj|XaaWW|XaaWt|XaaWu|XaaWv|XaaWw|XaaWx|F3712|F3964|G5y8.|G5yA.|N0421|XE1DU|X702I|N040.|N0400|N0401|N0402|N0403|N0404|N0405|N0406|N0407|N0408|N0409|N040A|N040B|N040C|N040D|N040E|N040F|N040G|N040H|N040J|N040K|N040L|N040M|X701l|X701i|N040Q|N0422|Xa3gL|N040T|N041.|N0421|N0422|Nyu1G|N0421|X103Y|X103Y|X701k|Nyu10|Nyu1G)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, RA_read2, RA_read3, "RA")

sum(dat_eid$RA_prevalent_GP)

```

Hypertension
```{r}
hypertension_table <- dat_GPmap %>%
  filter(grepl("[X] Adverse reaction to other antihypertensives|[X]Oth antihyperten drug caus advers eff in therap use, NEC|[X] Adverse reaction to antihypertensives NOS|Adverse reaction to antihypertensives NOS|Adverse reaction to other antihypertensives|Pre-exist 2ndry hypertens comp preg childbth and puerperium|Pre-exist hyperten heart dis compl preg childbth+puerperium|Other pre-exist hypertension in preg/childb/puerp-not deliv|Other pre-existing hypertension in preg/childb/puerp - deliv|Other pre-existing hypertension in preg/childb/puerp unspec|Pre-exist hypertension compl preg childbirth and puerperium|Pre-eclampsia or eclampsia + pre-existing hypertension NOS|Pre-eclampsia or eclampsia with pre-existing hypertension|Other pre-existing hypertension in preg/childb/puerp NOS|Other pre-existing hypertension in preg/childbirth/puerp|[X]Hypertension secondary to other renal disorders|[X]Hypertensive diseases|Secondary benign renovascular hypertension|Secondary malignant renovascular hypertension|Benign hypertensive heart disease with CCF|Benign hypertensive heart disease without CCF|Malignant hypertensive heart disease with CCF|Malignant hypertensive heart disease without CCF|Hypertensive crisis|Hypertensive encephalopathy|Hypertension secondary to endocrine disorders|Secondary benign hypertension NOS|Secondary benign hypertension|Secondary malignant hypertension NOS|Secondary malignant hypertension|Hyperten heart&renal dis+both(congestv)heart and renal fail|Hypertensive heart and renal disease with renal failure|Hypertensive heart&renal dis wth (congestive) heart failure|Benign hypertensive heart and renal disease|Malignant hypertensive heart and renal disease|Hypertensive renal disease with renal failure|Benign hypertensive renal disease|Malignant hypertensive renal disease|Benign hypertensive heart disease|Malignant hypertensive heart disease|Diastolic hypertension|Systolic hypertension|Benign essential hypertension|Malignant essential hypertension|Secondary hypertension NOS|Hypertension secondary to drug|Secondary renovascular hypertension NOS|Secondary hypertension NOS|Secondary hypertension|Hypertensive heart and renal disease NOS|Hypertensive heart and renal disease|Renal hypertension|Hypertensive renal disease NOS|Hypertensive renal disease|Hypertensive heart disease NOS|Hypertensive heart disease NOS with CCF|Cardiomegaly - hypertensive|Hypertensive heart disease NOS|Hypertensive heart disease NOS without CCF|Hypertensive heart disease|Hypertension NOS|Essential hypertension NOS|Essential hypertension|Hypertensive disease NOS|Other specified hypertensive disease|BP - hypertensive disease|Hypertensive disease|Hypertensive retinopathy|Blind hypertensive eye|Hypertension induced by oral contraceptive pill|Hypertension resolved|Poor hypertension control|Good hypertension control|Borderline hyperten:yearly obs|Trial withdrawal of antihypertensive therapy|On treatment for hypertension|Hypertensive treatm.changed|Hypertension treatm. started|Hypertension annual review|Hypertension six month review|Moderate hypertension control|Hypertension resolved|H/O: hypertension|Hypertens.monitor deleted|Hypertension treatment refused|Patient on maximal tolerated antihypertensive therapy|Antihypertensive therapy|High cost hypertension drugs", TERMV3_DESC, ignore.case = FALSE))


hypertension_table <- hypertension_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

hypertension_table <- hypertension_table[!grepl("resolved|Borderline hyperten|Hypertension six month review|Hypertension annual review|Atherosclerotic retinopathy|contraceptive|pregnancy", hypertension_table$READV2_DESC, ignore.case = TRUE), ]



hypertension_2 <- hypertension_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
hypertension_2

hypertension_3 <- hypertension_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
hypertension_3


```

```{r}
HTN_read2 <- "^(14A2.|6627.|6628.|662b.|662F.|662G.|662O.|662r.|7Q01.|7Q01z|8B26.|8BL0.|8I3N.|8IA5.|F4042|F4213|G2...|G2...|G20..|G200.|G201.|G202.|G203.|G20z.|G20z.|G21..|G210.|G2100|G2101|G210z|G211.|G2110|G2111|G211z|G21z.|G21z0|G21z0|G21z1|G21zz|G22..|G22..|G220.|G221.|G222.|G22z.|G22z.|G22z.|G23..|G230.|G231.|G232.|G233.|G234.|G23z.|G24..|G2400|G240z|G241.|G2410|G241z|G244.|G24z.|G24z0|G24z1|G24zz|G2y..|G2z..|G672.|G672.|Gyu2.|L122.|L127.|L1270|L1271|L1272|L1273|L1274|L127z|TJC7.|TJC7z|U60C5|U60C5)$"
HTN_read3 <- "^(14A2.|6627.|6628.|XaIy8|662F.|662G.|Xa8HD|XaNFs|XaM5f|XaM5p|XaBLq|XaJ5h|XaIyC|XaNK1|XE15r|F4211|G2...|G2...|XE0Uc|G200.|G201.|G202.|XSDSb|XE0Ud|G20z.|G21..|G210.|G2100|G2101|G210z|G211.|G2110|G2111|G211z|G21z.|XE0Ue|XM1Qp|G21z1|G21z.|XE0Uf|XE0Uf|G220.|G221.|G222.|XE0Ug|G22z.|XE0Uf|G23..|G230.|G231.|G232.|G233.|G234.|G23z.|G24..|G2400|G240z|G241.|G2410|G241z|G244.|G24z.|G24z0|G24z1|G24z.|G2y..|G2z..|XE0VM|XE0VM|Gyu2.|L122.|L127.|L1270|L1271|L1272|L1273|L1274|L127z|TJC7.|TJC7z|TJC7z|TJC7.)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, HTN_read2, HTN_read3, "Hypertension")

sum(dat_eid$Hypertension_prevalent_GP)

```

Type 2 diabetes  
```{r}

diabetes_2_table <- dat_GPmap %>%
  filter(grepl("Type II diabetes mellitus with gangrene|Type II diabetes mellitus|Type 2 diabetes mellitus with gastroparesis|Type 2 diabetes mellitus - poor control|Type 2 diabetes mellitus with renal complications|Type 2 diabetes mellitus with peripheral angiopathy|Type 2 diabetes mellitus|Type II diabetes mellitus with renal complications|Type 2 diabetes mellitus with persistent microalbuminuria|Non-insulin-dependent diabetes mellitus without complication|Insulin treated Type 2 diabetes mellitus|Type 2 diabetes mellitus with neuropathic arthropathy|Non-insulin dependent diabetes mellitus - poor control|Non-insulin dependent diabetes mellitus with nephropathy|Type 2 diabetes mellitus with diabetic cataract|Type 2 diabetes mellitus with ketoacidosis|Type 2 diabetes mellitus with neuropathic arthropathy|Hyperosmolar non-ketotic state in type II diabetes mellitus|Type 2 diabetes mellitus without complication|Non-insulin dependent diabetes mellitus|Type II diabetes mellitus|Type 2 diabetes mellitus without complication|Type 2 diabetes mellitus with multiple complications|Type 2 diabetes mellitus with gangrene|Insulin treated Type II diabetes mellitus|Type 2 diabetes mellitus with neurological complications|Type 2 diabetes mellitus with neurological complications|Hyperosmolar non-ketotic state in type 2 diabetes mellitus|Type 2 diabetes mellitus with nephropathy|Non-insulin-dependent diabetes mellitus with renal comps|Type 2 diabetes mellitus with peripheral angiopathy|Type II diabetes mellitus with peripheral angiopathy|Type 2 diabetes mellitus with hypoglycaemic coma|Non-insulin dependent diabetes mellitus|Type 2 diabetes mellitus - poor control|Non-insulin dependent diabetes mellitus with arthropathy|Type II diabetes mellitus with diabetic cataract|Type 2 diabetes mellitus with ulcer|Non-insulin dependent diabetes mellitus with mononeuropathy|Type II diabetes mellitus with neuropathic arthropathy|Type 2 diabetes mellitus with diabetic cataract|Non-insulin dependent diabetes mellitus with gangrene|Type 2 diabetes mellitus with polyneuropathy|Type II diabetes mellitus with persistent proteinuria|Type II diabetes mellitus without complication|Non-insulin depend diabetes mellitus with diabetic cataract|Insulin treated Type 2 diabetes mellitus|NIDDM - Non-insulin dependent diabetes mellitus|Type II diabetes mellitus with ulcer|Type 2 diabetes mellitus with exudative maculopathy|Type 2 diabetes mellitus with retinopathy|Type II diabetes mellitus with ophthalmic complications|Type 2 diabetes mellitus with hypoglycaemic coma|Type II diabetes mellitus with neurological complications|Type II diabetes mellitus with peripheral angiopathy|Type II diabetes mellitus with ulcer|Type II diabetes mellitus - poor control|Non-insulin dependent diabetes mellitus with hypoglyca coma|Type 2 diabetes mellitus with nephropathy|Type II diabetes mellitus with neurological complications|Type II diabetes mellitus with hypoglycaemic coma|Non-insulin dependent diabetes mellitus with polyneuropathy|Type II diabetes mellitus with neuropathic arthropathy|Type II diabetes mellitus with renal complications|Type II diabetes mellitus with retinopathy|Type 2 diabetes mellitus with persistent proteinuria|Type 2 diabetes mellitus|Type 2 diabetes mellitus with renal complications|Type 2 diabetes mellitus with ophthalmic complications|Type II diabetes mellitus with hypoglycaemic coma|Type II diabetes mellitus with arthropathy|Type II diabetes mellitus with mononeuropathy|Type 2 diabetes mellitus with mononeuropathy|Non-insulin dependent diabetes mellitus with ulcer|Type II diabetes mellitus with arthropathy|Type 2 diabet", TERMV3_DESC, ignore.case = FALSE))


diabetes_2_table <- diabetes_2_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

diabetes_2_table <- diabetes_2_table[!grepl("dietary review", diabetes_2_table$READV2_DESC, ignore.case = TRUE), ]



diabetes_2_read2 <- diabetes_2_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
diabetes_2_read2

diabetes_2_read3 <- diabetes_2_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
diabetes_2_read3



```

```{r}

diabetes_1_table <- dat_GPmap %>%
  filter(grepl("Unstable type 1 diabetes mellitus|Type I diabetes mellitus with exudative maculopathy|Type 1 diabetes mellitus with ketoacidosis|Type I diabetes mellitus without complication|Type I diabetes mellitus with polyneuropathy|Insulin-dependent diabetes mellitus with ophthalmic comps|Type 1 diabetes mellitus with renal complications|Insulin dependent diabetes mellitus with nephropathy|Type I diabetes mellitus with retinopathy|Insulin-dependent diabetes mellitus with renal complications|Type 1 diabetes mellitus - poor control|Insulin-dependent diabetes without complication|Type I diabetes mellitus with multiple complications|Type I diabetes mellitus with ophthalmic complications|Type 1 diabetes mellitus with neuropathic arthropathy|Insulin dependent diabetes mellitus with arthropathy|Type 1 diabetes mellitus with neurological complications|Insulin dependent diabetes mellitus with gangrene|Insulin dependent diabetes mellitus with mononeuropathy|Type I diabetes mellitus - poor control|Insulin dependent diab mell with neuropathic arthropathy|Type I diabetes mellitus with multiple complications|Type I diabetes mellitus with gastroparesis|Type 1 diabetes mellitus with neurological complications|Type 1 diabetes mellitus with ophthalmic complications|Insulin dependent diabetes mellitus with retinopathy|Type I diabetes mellitus with ulcer|Type 1 diabetes mellitus with persistent proteinuria|Type I diabetes mellitus with ketoacidosis|Insulin-dependent diabetes mellitus with ophthalmic comps|Type I diabetes mellitus - poor control|Insulin-dependent diabetes mellitus with neurological comps|Unstable type 1 diabetes mellitus|Type I diabetes mellitus with mononeuropathy|Insulin dependent diabetes mellitus|Unstable type I diabetes mellitus|Type 1 diabetes mellitus with arthropathy|Type 1 diabetes mellitus with ophthalmic complications|Type 1 diabetes mellitus with ulcer|Insulin dependent diabetes mellitus with diabetic cataract|Type 1 diabetes mellitus - poor control|Type 1 diabetes mellitus with retinopathy|IDDM-Insulin dependent diabetes mellitus|Insulin dependent diabetes mellitus|Type 1 diabetes mellitus with ulcer|Type 1 diabetes mellitus with renal complications|Type I diabetes mellitus with ulcer|Type 1 diabetes mellitus with persistent microalbuminuria|Insulin-dependent diabetes without complication|Type 1 diabetes mellitus with diabetic cataract|Insulin dependent diabetes mellitus with hypoglycaemic coma|Type I diabetes mellitus with renal complications|Insulin dependent diabetes mellitus with polyneuropathy|Insulin dependent diabetes mellitus with multiple complicatn|Type 1 diabetes mellitus|Insulin dependent diabetes mellitus with gangrene|Insulin dependent diabetes mellitus with multiple complicat|Type 1 diabetes mellitus with polyneuropathy|Insulin dependent diabetes mellitus with polyneuropathy|Insulin-dependent diabetes mellitus with neurological comps|Type I diabetes mellitus with neuropathic arthropathy|Type I diabetes mellitus without complication|Type I diabetes mellitus|Type 1 diabetes mellitus|Insulin-dependent diabetes", TERMV3_DESC, ignore.case = FALSE))



diabetes_1_table <- diabetes_1_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

diabetes_1_table <- diabetes_1_table[!grepl("juvenile", diabetes_1_table$READV2_DESC, ignore.case = TRUE), ]



diabetes_1_read2 <- diabetes_1_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
diabetes_1_read2

diabetes_1_read3 <- diabetes_1_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
diabetes_1_read3



T1DM_read2 <- "^(C108.|C108.|C108.|C108.|C108.|C108.|C1080|C1080|C1080|C1081|C1081|C1081|C1082|C1082|C1082|C1083|C1083|C1083|C1083|C1084|C1084|C1085|C1085|C1085|C1085|C1086|C1086|C1086|C1086|C1087|C1087|C1087|C1087|C1088|C1088|C1088|C1088|C1089|C1089|C1089|C1089|C108A|C108A|C108A|C108B|C108B|C108B|C108C|C108C|C108C|C108D|C108D|C108D|C108E|C108E|C108E|C108F|C108F|C108F|C108G|C108G|C108G|C108H|C108H|C108H|C108J|C108J|C108J|C10E.|C10E.|C10E.|C10E.|C10E0|C10E0|C10E0|C10E1|C10E1|C10E1|C10E2|C10E2|C10E2|C10E3|C10E3|C10E3|C10E3|C10E4|C10E4|C10E5|C10E5|C10E5|C10E5|C10E6|C10E6|C10E6|C10E6|C10E7|C10E7|C10E7|C10E7|C10E8|C10E8|C10E8|C10E8|C10E9|C10E9|C10E9|C10E9|C10EA|C10EA|C10EA|C10EB|C10EB|C10EB|C10EC|C10EC|C10EC|C10ED|C10ED|C10ED|C10EE|C10EE|C10EE|C10EF|C10EF|C10EF|C10EG|C10EG|C10EG|C10EH|C10EH|C10EH|C10EJ|C10EJ|C10EJ|C10EK|C10EK|C10EL|C10EL|C10EM|C10EM|C10EN|C10EN|C10EP|C10EP|C10EQ|C10EQ|C10P0|C10P0)$"
T1DM_read3 <- "^(X40J4|X40J4|X40J4|X40J4|X40J4|X40J4|C1080|C1080|C1080|C1081|C1081|C1081|C1082|C1082|C1082|C1083|C1083|C1083|C1083|Xa4g7|Xa4g7|C1085|C1085|C1085|C1085|C1086|C1086|C1086|C1086|C1087|C1087|C1087|C1087|C1088|C1088|C1088|C1088|C1089|C1089|C1089|C1089|XaELP|XaELP|XaELP|XaEnn|XaEnn|XaEnn|XaEno|XaEno|XaEno|XaF04|XaF04|XaF04|XaFWG|XaFWG|XaFWG|XaFm8|XaFm8|XaFm8|XaFmK|XaFmK|XaFmK|XaFmL|XaFmL|XaFmL|XaFmM|XaFmM|XaFmM|X40J4|X40J4|X40J4|X40J4|C1080|C1080|C1080|C1081|C1081|C1081|C1082|C1082|C1082|C1083|C1083|C1083|C1083|Xa4g7|Xa4g7|C1085|C1085|C1085|C1085|C1086|C1086|C1086|C1086|C1087|C1087|C1087|C1087|C1088|C1088|C1088|C1088|C1089|C1089|C1089|C1089|XaELP|XaELP|XaELP|XaEnn|XaEnn|XaEnn|XaEno|XaEno|XaEno|XaF04|XaF04|XaF04|XaFWG|XaFWG|XaFWG|XaFm8|XaFm8|XaFm8|XaFmK|XaFmK|XaFmK|XaFmL|XaFmL|XaFmL|XaFmM|XaFmM|XaFmM|XaIzM|XaIzM|XaIzN|XaIzN|C1010|C1010|C1030|C1030|XaJSr|XaJSr|XaKyW|XaKyW|Xaage|Xaage)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, T1DM_read2, T1DM_read3, "DiabetesType1")

sum(dat_eid$DiabetesType2_prevalent_GP)

```

HF
```{r}

angina_table <- dat_GPmap %>%
  filter(grepl("H/O: angina pectoris|H/O: Angina in last year|Preinfarction syndrome|Unstable angina|Crescendo angina|Impending infarction|Unstable angina|Angina at rest|Angina at rest|Refractory angina|Worsening angina|Acute coronary syndrome|Preinfarction syndrome NOS|Coronary thrombosis not resulting in MI|Acute coronary insufficiency|Subendocardial ischaemia|Transient myocardial ischaemia|Angina pectoris|Angina decubitus|Nocturnal angina|Angina decubitus NOS|Prinzmetal's angina|Variant angina pectoris|Coronary artery spasm|Coronary artery spasm|Angina pectoris NOS|Status anginosus|Stenocardia|Syncope anginosa|Angina on effort|New onset angina|Stable angina|Angina pectoris NOS|Chronic coronary insufficiency|Chronic myocardial ischaemia|[X]Other forms of angina pectoris|Syndrome preinfarction myocardia|Sclerosis endocardial|Angina pectoris with hypertension|Angina effort with hypertension|Angina pectoris|Angina attack|Angina atypical|Cardiac angina|Angina crescendo|Angina effort|Syndrome anginal|Angina|Angina inversa|Prinzmetal's angina|Variant angina pectoris|Unstable angina", TERMV3_DESC, ignore.case = FALSE))


angina_table <- angina_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

angina_table <- angina_table[!grepl("FH:|Referral to Angina Plan", angina_table$READV2_DESC, ignore.case = TRUE), ]


angina_read2 <- angina_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
angina_read2

angina_read3 <- angina_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
angina_read3

angina_read2 <- "^(14A5.|14AJ.|661M0|661N0|662K.|662K0|662K1|662K2|662K3|662K4|662K5|662Kz|G311.|G311.|G311.|G311.|G311.|G3111|G3112|G3113|G3114|G3115|G311z|G31y0|G31y2|G31y3|G33..|G330.|G3300|G330z|G331.|G331.|G332.|G33z.|G33z0|G33z1|G33z2|G33z3|G33z6|G33z7|G33zz|G34y0|G34y1|J08zD|Q494.)$"
angina_read3 <- "^(14A5.|XaBL2|XaYb7|XaYae|662K.|662K0|662K1|662K2|662K3|XaXew|XaXex|662Kz|XE0Ui|X2007|XE0Ui|XE0Ui|X2009|X2009|X2007|XaFsG|XE0Ui|XaINF|G311z|G31y0|G31y2|XaFsH|G33..|G330.|G3300|G330z|G331.|G331.|X200B|G33z.|G33z0|G33z1|G33z2|Xa7nH|X200A|X2008|G33z.|G34y1|G34y1|X20QX|Xa07k)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, angina_read2, angina_read3, "Angina")

```

```{r}
HF_table <- dat_GPmap %>%
  filter(grepl("New York Heart Association classification - class I|Seen by community heart failure nurse|Right ventricular failure|Admit heart failure emergency|Hyperten heart&renal dis+both(congestv)heart and renal fail|Excepted from LVD quality indicators: Informed dissent|Left ventricular dysfunction monitoring administration|Left ventricular systolic dysfunction|Hypertensive heart&renal dis wth (congestive) heart failure|Heart failure monitoring administration|Heart failure self-management plan agreed|Left ventricular dysfunction monitoring third letter|Referred to heart failure education group|Acute cor pulmonale|Congestive heart failure monitoring|Left ventricular dysfunction monitoring verbal invite|Excepted from LVD quality indicators: Patient unsuitable|Education about deteriorating heart failure|Right ventricula", TERMV3_DESC, ignore.case = FALSE))


HF_table <- HF_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

HF_table <- HF_table[!grepl("excluded|resolved|risk score|category score|6 month review|Heart failure annual review|information given to patient|Heart failure education|Heart failure screen|Heart failure care plan discussed with patient|Heart failure clinical pathway|Heart failure follow-up|Excepted|Exception reporting|Seen by community heart failure nurse|Referred by heart failure nurse specialist|letter|telephone|Referral to heart failure exercise|verbal invite|Heart failure review completed|monitoring administration|Heart failure education|Referral to heart failure clinic|Referral to rapid access heart failure clinic|Referral to heart failure|transthoracic two dimensional|heart failure nurse service|heart failure nurse service|Heart failure rehabilitation programme|Did not attend", HF_table$READV2_DESC, ignore.case = TRUE), ]


HF_read2 <- HF_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
HF_read2

HF_read3 <- HF_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
HF_read3

HF_read2 <- "^(14A6.|14AM.|1J60.|1O1..|2JZ..|33BA.|388D.|661M5|661N5|662f.|662g.|662h.|662i.|662T.|679W1|8B29.|8CeC.|8CMK.|8H2S.|8Hg8.|9N0k.|G1yz1|G232.|G234.|G400.|G41z.|G5540|G5540|G58..|G58..|G580.|G580.|G580.|G580.|G580.|G580.|G5800|G5801|G5802|G5803|G5804|G581.|G581.|G581.|G581.|G5810|G582.|G583.|G583.|G583.|G584.|G58z.|G58z.|G58z.|G58z.|G5y4z|G5yy9|G5yyA|L09y2|SP111)$"
HF_read3 <- "^(14A6.|XaBwi|XaIkr|XaIpn|XabM9|XM1Qn|XaIL7|XaYbC|XaYZN|XaJ9G|XaJ9H|XaJ9I|XaJ9J|XaIIU|XaYft|XaBLt|XaXzw|XaXkR|XaKNW|XaLCm|XaKNN|G1yz1|G232.|G234.|G400.|X203E|XE0Uz|X201W|G58..|G58..|XE0V8|G580.|XE0V8|XE0V8|X202l|X202l|G5800|G5801|G5802|G5803|XaO5n|XE2QG|XM1Qn|XE2QG|XE2QG|G5810|G582.|XaWyi|XaWyi|XaWyi|X202l|XE0V9|XE0V9|XE0V9|XE0V9|G5y4z|XaIIq|XaItG|L09y2|X202k)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, HF_read2, HF_read3, "HeartFailure")

```

```{r}
MI_table <- dat_GPmap %>%
  filter(grepl("myocardial infarction|heart attack|infarct|Other acute myocardial infarction NOS|Silent myocardial infarction|Subsequent myocardial infarction of unspecified site|MI - acute myocardial infarction|Posterior myocardial infarction NOS|Subsequent myocardial infarction of anterior wall|True posterior myocardial infarction|Postoperative transmural myocardial infarction anterior wall|Acute atrial infarction|ECG: lateral infarction|Acute posterolateral myocardial infarction|Other acute myocardial infarction|Acute anteroapical infarction|Acute non-Q wave infarction|Old myocardial infarction|Coronary thrombosis|Postmyocardial infarction syndrome|Rupture papillary muscle/curr comp fol acute myocard infarct|ECG:posterior/inferior infarct|ECG: myocardial infarct NOS|Postoperative subendocardial myocardial infarction|Acute subendocardial infarction|Thrombosis atrium,auric append&vent/curr comp foll acute MI|Healed myocardial infarction|Anterior myocardial infarction NOS|[X]Acute transmural myocardial infarction of unspecif site|Dressler's syndrome|Ventric septal defect/curr comp fol acut myocardal infarctn|Microinfarction of heart|Postoperative myocardial infarction, unspecified|H/O: myocardial infarct >60|Postoperative myocardial infarction|Attack - heart|ECG: myocardial infarction|Acute ST segment elevation myocardial infarction|Acute septal infarction|Atrial septal defect/curr comp folow acut myocardal infarct|Ruptur chordae tendinae/curr comp fol acute myocard infarct|Postoperative transmural myocardial infarction inferior wall|Ruptur cardiac wall w'out haemopericard/cur comp fol ac MI|Certain current complication follow acute myocardial infarct|Personal history of myocardial infarction|Thrombosis - coronary|Acute transmural myocardial infarction of unspecif site|Acute myocardial infarction|Post infarction pericarditis|Lateral myocardial infarction NOS|Acute inferoposterior infarction|H/O: Myocardial infarction in last year|Acute anteroseptal infarction|Acute non-ST segment elevation myocardial infarction|Subsequent myocardial infarction|Subsequent myocardial infarction of other sites|Acute Q-wave infarct|ECG: subendocardial infarct|Inferior myocardial infarction NOS|Cardiac rupture following myocardial infarction (MI)|Mural thrombosis|H/O: myocardial infarct|Acute myocardial infarction NOS|Acute anterolateral infarction|Acute inferolateral infarction|Acute papillary muscle infarction|Subsequent myocardial infarction of inferior wall|Haemopericardium/current comp folow acut myocard infarct|ECG: antero-septal infarct.|Other specified anterior myocardial infarction|Heart attack|Post infarct angina|Diab mellit insulin-glucose infus acute myocardial infarct", TERMV3_DESC, ignore.case = FALSE))


MI_table <- MI_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

MI_table <- MI_table[!grepl("FH:|FH myo|Surveillance of Cerebral Palsy in Europe|ECG: no myocardial infarction|Old cerebral infarction on imaging|placental|Excepted from myocardial infarction|exception reporting|dementia|thyroid|Preinfarction syndrome|Myocardial infarction aborted|Coronary thrombosis not resulting in myocardial infarction|Pulmonary embolism|Pulmonary infarct|cerebral|brainstem|Acute intestinal vascular insufficiency|Sequelae of stroke, not specified as haemorrhage or infarction|Hepatic infarction|Renal infarction|renal vascu|observation for sus|family history of|Lymph node infarction|ischaemia infarcti", MI_table$READV2_DESC, ignore.case = TRUE), ]


MI_read2 <- MI_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
MI_read2

MI_read3 <- MI_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
MI_read3

MI_read2 <- "^(14A3.|14A4.|14AH.|14AT.|323..|3232.|3233.|3234.|3235.|3236.|323Z.|889A.|C1322|F1610|G30..|G30..|G30..|G30..|G30..|G30..|G30..|G30..|G30..|G30..|G300.|G301.|G3010|G3011|G301z|G302.|G303.|G304.|G305.|G306.|G307.|G3070|G3071|G308.|G309.|G30A.|G30B.|G30X.|G30X0|G30y.|G30y0|G30y1|G30y2|G30yz|G30z.|G310.|G310.|G31y1|G32..|G32..|G32..|G32..|G33z5|G35..|G350.|G351.|G353.|G35X.|G36..|G360.|G361.|G362.|G363.|G364.|G365.|G366.|G38..|G380.|G381.|G382.|G383.|G384.|G38z.|G501.|G86y6|Gyu31|Gyu34|Gyu35|Gyu36|N23yB)$"
MI_read3 <- "^(14A3.|14A4.|XaBL1|XaQk7|323..|3232.|3233.|3234.|3235.|3236.|323Z.|XaFx7|C1322|F1610|XE0Uh|X200E|X200E|X200e|X200E|X200E|XE0Uh|XE0Uh|X200a|X203v|G300.|G301.|G3010|G3011|G301z|G302.|G303.|G304.|G305.|G306.|G307.|XaAzi|XaIwY|G308.|XaAC3|X202q|XaJX0|Gyu34|XaIwM|G30y.|G30y0|G30y1|G30y2|G30yz|G30z.|G310.|G310.|G31y1|XE2aA|XE2aA|XaQk7|XE2aA|XaEXt|G35..|G350.|G351.|G353.|Gyu36|G36..|G360.|G361.|X200d|G363.|G364.|G365.|G366.|XaD2b|XaD2d|XaD2e|XaD2f|XaD2g|XaD2h|XaD2i|X201u|G86y6|Gyu31|Gyu34|Gyu35|Gyu36|X70AA)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, MI_read2, MI_read3, "MyocardialInfarction")

```

```{r}
IschaemicStroke_table <- dat_GPmap %>%
  filter(grepl("Cerebral infarction due to thrombosis of cerebral arteries|Cereb infarct due unsp occlus/stenos precerebr arteries|[X]Cerebrl infarctn due/unspcf occlusn or sten/cerebrl artrs|Cerebral infarct due to thrombosis of precerebral arteries|Sequelae of cerebral infarction|Right sided cerebral infarction|[X]Cereb infarct due unsp occlus/stenos precerebr arteries|Cerebral thrombosis|Cerebral infarction NOS|Cerebral embolism|Infarction - precerebral|Brainstem infarction|CVA - cerebral artery occlusion|Cerebral infarction due to embolism of cerebral arteries|Cerebellar infarction|Infarction of basal ganglia|Cerebrl infarctn due/unspcf occlusn or sten/cerebrl artrs|Wallenberg syndrome|Cerebral arterial occlusion|Lateral medullary syndrome|Infarction - cerebral|Cerebral infarction due to embolism of precerebral arteries|Cerebral embolus|Left sided cerebral infarction|Stroke due to cerebral arterial occlusion|Brainstem infarction NOS|[X]Other cerebral infarction|ischaemic stroke|Cerebrovascular accident due to occlusion|cerebral accident|cerebral infarction", TERMV3_DESC, ignore.case = FALSE))


IschaemicStroke_table <- IschaemicStroke_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)


IschaemicStroke_read2 <- IschaemicStroke_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
IschaemicStroke_read2

IschaemicStroke_read3 <- IschaemicStroke_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
IschaemicStroke_read3

IschaemicStroke_read2 <- "^(5C13.|G63..|G63y0|G63y1|G64..|G64..|G640.|G6400|G641.|G641.|G6410|G64z.|G64z.|G64z.|G64z0|G64z1|G64z1|G64z2|G64z3|G64z4|G677.|G683.|Gyu64B)$"
IschaemicStroke_read3 <- "^(XacGH|X00D4|G63y0|G63y1|XE0VI|G640.|G640.|G6400|G641.|G641.|G6410|XE0VJ|X00D9|Xa00J|Xa00K|Xa00M|Xa00M|XaBEC|XaBED|XaJgQ|G677.|G683.|Gyu64)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, IschaemicStroke_read2, IschaemicStroke_read3, "Stroke_Ischaemic")
```

```{r}
StrokeNOS_table <- dat_GPmap %>%
  filter(grepl("H/O: CVA &/or stroke|Rupture of syphilitic cerebral aneurysm|Retrobulbar haemorrhage|[X]Other lacunar syndromes|[X]Other vascular syndroms|Ruptured berry aneurysm|Subarachnoid haemorrhage|Intracerebral haemorrhage|Cortical haemorrhage|Internal capsule haemorrhage|Basal ganglia haemorrhage|Cerebellar haemorrhage|Pontine haemorrhage|Bulbar haemorrhage|External capsule haemorrhage|Intracerebral haemorrhage|Intracranial haemorrhage|Basilar artery occlusion|Vertebral artery occlusion|Multiple and bilateral precerebral arterial occlusion|Other precerebral artery occlusion|Cerebral infarct due to thrombosis of precerebral arteries|Cerebral infarction due to embolism of precerebral arteries|Precerebral artery occlusion NOS|Cereb art occl|Cerebral thrombosis|Cerebral infarction due to thrombosis of cerebral arteries|Cerebral embolus|Cerebral infarction|Wallenberg syndrome|Basilar artery syndrome|Vertebral artery syndrome|Vertebrobasilar artery syndrome|Carotid artery syndrome hemispheric|precerebral artery syndromes|CVA - cerebrovascular accident|cerebral artery syndrome|Brainstem stroke|Cerebellar stroke|cerebrovascular accident|Occlusion/stenosis cerebral arts not result cerebral infarct|stenosis of middle cerebral artery|stenosis of anterior cerebral artery|Occlusion and stenosis of posterior cerebral artery|Occlusion and stenosis of cerebellar arteries|bilat cerebral arteries|subarachnoid haemorrhage|intracranial haemorrhage|Sequelae of cerebral infarction|[X]Cerebrl infarctn due/unspcf occlusn or sten/cerebrl artrs|[X]Cerebrl infarctn due/unspcf occlusn or sten/cerebrl artrs|Occlusion and stenosis of other precerebral arteries|[X]Occlusion and stenosis of other cerebral arteries|[X]Sequelae of stroke|Subarachnoid haemorrh|Intracerebral haemorrhage|Cereb infarct|(Haemor foll inj: [named variants]) or (traum cerebral haem)|Haemorrh: [closed traum subarach] or [mid mening follow inj]|Subarachnoid h'ge inj no open intracran wound + unspec consc|Subarachnoid|Cerebral infarction due to thrombosis of cerebral arteries|Cereb infarct due unsp occlus/stenos precerebr arteries|[X]Cerebrl infarctn due/unspcf occlusn or sten/cerebrl artrs|Cerebral infarct due to thrombosis of precerebral arteries|Sequelae of cerebral infarction|Right sided cerebral infarction|[X]Cereb infarct due unsp occlus/stenos precerebr arteries|Cerebral thrombosis|Cerebral infarction NOS|Cerebral embolism|Infarction - precerebral|Brainstem infarction|CVA - cerebral artery occlusion|Cerebral infarction due to embolism of cerebral arteries|Cerebellar infarction|Infarction of basal ganglia|Cerebrl infarctn due/unspcf occlusn or sten/cerebrl artrs|Wallenberg syndrome|Cerebral arterial occlusion|Lateral medullary syndrome|Infarction - cerebral|Cerebral infarction due to embolism of precerebral arteries|Cerebral embolus|Left sided cerebral infarction|Stroke due to cerebral arterial occlusion|Brainstem infarction NOS|[X]Other cerebral infarction|ischaemic stroke|Cerebrovascular accident due to occlusion|cerebral accident|cerebral infarction" , TERMV3_DESC, ignore.case = FALSE))

StrokeNOS_table <- dat_GPmap %>%
  filter(grepl("^(14AF.|XabrH|XacGH|A94y6|F4K7.|Xa1uW|G600.|G601.|Xa01h|Xa01j|Xa01k|Xa01l|G606.|Gyu6E|G60z.|XE0VF|G610.|G611.|G612.|G613.|G614.|G615.|G616.|G617.|G618.|Gyu6F|G61z.|G62..|G62z.|X00D4|G630.|G632.|G633.|G63y.|G63y0|G63y1|G63z.|XE0VI|X00D3|Xa0kZ|G640.|G640.|G6400|G641.|G641.|G6410|XE0VJ|X00D9|Xa00J|Xa00K|Xa00M|Xa00M|XaBEC|XaBED|XaJgQ|G650.|G651.|G6510|G653.|G654.|XE2aB|XE2aB|XE2aB|G660.|G661.|G662.|G663.|G664.|G6760|G677.|G6770|G6771|G6772|G6773|G680.|G682.|G683.|Gyu6G|Gyu63|Gyu60|Gyu61|Gyu63|Gyu64|Gyu65|G682.|Gyu6E|Gyu6F|Gyu6G|X70Ei|X70Ei|Q412.|XE1m2|XA0BH|XE1m3|S6200|S6201|S6202|S6203|S6204|S6205|S6206|S620z|S621.|S6210|S6211|S6212|S6213|S6214|S6215|S6216|S621z|XA0BH)$" , READV3_CODE, ignore.case = FALSE))



StrokeNOS_table <- StrokeNOS_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

StrokeNOS_table <- StrokeNOS_table[!grepl("FH:|Family history|birth injury|Personal history of circulatory system disease|	
QBleed 5 year risk of intracranial haemorrhage|suspected cerebro|Qbleed", StrokeNOS_table$READV2_DESC, ignore.case = TRUE), ]


StrokeNOS_read2 <- StrokeNOS_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
StrokeNOS_read2

StrokeNOS_read3 <- StrokeNOS_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
StrokeNOS_read3

StrokeNOS_read2 <- "^(14AF.|5C13.|A94y6|F4K7.|G60..|G600.|G601.|G602.|G603.|G604.|G605.|G606.|G60X.|G60z.|G61..|G61..|G61..|G61..|G610.|G611.|G612.|G613.|G614.|G615.|G616.|G617.|G618.|G61X.|G61z.|G62..|G620.|G621.|G62z.|G63..|G630.|G632.|G633.|G63y.|G63y0|G63y1|G63z.|G64..|G64..|G64..|G64..|G64..|G640.|G6400|G641.|G641.|G6410|G64z.|G64z.|G64z.|G64z0|G64z1|G64z1|G64z2|G64z3|G64z4|G650.|G650.|G651.|G6510|G653.|G654.|G66..|G66..|G66..|G660.|G661.|G662.|G663.|G664.|G6760|G677.|G6770|G6771|G6772|G6773|G6774|G680.|G682.|G683.|G6W..|G6X..|Gyu60|Gyu61|Gyu63|Gyu64|Gyu65|Gyu6B|Gyu6E|Gyu6F|Gyu6G|Q2000|Q2000|Q412.|S62..|S62..|S62..|S62..|S62..|S620.|S6200|S6201|S6202|S6203|S6204|S6205|S6206|S620z|S621.|S6210|S6211|S6212|S6213|S6214|S6215|S6216|S621z|S627.)$"
StrokeNOS_read3 <- "^(14AF.|XacGH|A94y6|F4K7.|Xa1uW|G600.|G601.|Xa01h|Xa01j|Xa01k|Xa01l|G606.|Gyu6E|G60z.|XE0VF|XE0VF|XE0VF|XE0VF|G610.|G611.|G612.|G613.|G614.|G615.|G616.|G617.|G618.|Gyu6F|G61z.|G62..|G620.|G621.|G62z.|X00D4|G630.|G632.|G633.|G63y.|G63y0|G63y1|G63z.|XE0VI|X00D3|Xa0kZ|G640.|G640.|G640.|G6400|G641.|G641.|G6410|XE0VJ|X00D9|Xa00J|Xa00K|Xa00M|Xa00M|XaBEC|XaBED|XaJgQ|G650.|G650.|G651.|G6510|G653.|G654.|XE2aB|XE2aB|XE2aB|G660.|G661.|G662.|G663.|G664.|G6760|G677.|G6770|G6771|G6772|G6773|G6774|G680.|G682.|G683.|Gyu6G|Gyu63|Gyu60|Gyu61|Gyu63|Gyu64|Gyu65|G682.|Gyu6E|Gyu6F|Gyu6G|X70Ei|X70Ei|Q412.|XE1m2|XE1m2|XE1m2|XA0BH|XE1m2|XE1m3|S6200|S6201|S6202|S6203|S6204|S6205|S6206|S620z|S621.|S6210|S6211|S6212|S6213|S6214|S6215|S6216|S621z|XA0BH)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, StrokeNOS_read2, StrokeNOS_read3, "StrokeNOS")

```

```{r}
TIA_terms <- c("H/O: TIA", "Transient cerebral ischaemia NOS", "Transient global amnesia", "Vertebro-basilar insufficiency", 
               "H/O amaurosis fugax", "Transient ischaemic attack", "Carotid territory transient ischaemic attack", "TGA - Transient global amnesia", 
               "Other transient cerebral ischaemia", "Vertebrobasilar insufficiency", "[V]Personal history of transient ischaemic attack", 
               "Transient cerebral ischaemia", "[X]Other transnt cerebral ischaemic attacks+related syndroms", "Transient global amnesia", 
               "Insufficiency - basilar artery", "Transient ischaemic attack clinical management plan", "Transient global amnesia", 
               "Intermittent cerebral ischaemia", "Transient cerebral ischaemia NOS", "Amaurosis fugax")

# Filter the dataset
TIA_table <- dat_GPmap %>%
  filter(TERMV3_DESC %in% TIA_terms)

# Display the filtered dataset
TIA_table <- TIA_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)


TIA_read2 <- TIA_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
TIA_read2

TIA_read3 <- TIA_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
TIA_read3

TIA_read2 <- "^(14AB.|14AB0|1B1S.|8CRB.|F4236|G65..|G65..|G65..|G650.|G655.|G656.|G657.|G65y.|G65z.|G65z1|G65zz|ZV12D)$"
TIA_read3 <- "^(14AB.|XaZIY|X00E2|XaQve|F4236|XE0VK|XE0VK|X00DW|G650.|X00E2|X00DW|X00DU|G65y.|G65z.|G65z1|G65z.|XaX16)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, TIA_read2, TIA_read3, "TIA")

```

```{r}
PAD_table <- dat_GPmap %>%
  filter(grepl("^(5593.|55A2.|7A100|7A101|7A103|7A11.|7A110|7A111|7A112|7A113|7A11y|7A11z|7A12.|7A120|7A121|7A122|7A123|7A12y|7A12z|7A41.|7A410|7A411|7A414|7A415|7A416|7A418|7A419|7A41A|7A41B|7A41C|7A41D|7A41E|7A41F|7A41y|7A41z|7A42.|7A420|7A42y|7A42z|7A43.|7A430|7A432|7A43y|7A43z|7A440|7A443|7A44y|7A44z|7A47.|7A470|7A471|7A472|7A473|7A474|7A476|7A477|7A47B|7A47C|7A47D|7A47y|7A47z|7A48.|7A480|7A481|7A482|7A483|7A484|7A485|7A486|7A487|7A488|7A48A|7A48B|7A48C|7A48D|7A48E|7A48y|7A48z|7A49.|7A490|7A491|7A492|7A493|7A494|7A495|7A496|7A497|7A498|7A499|7A49y|7A49z|7A4A.|7A4A0|7A4A1|7A4A5|7A4A6|7A4A7|7A4A8|7A4Ay|7A4Az|7A4B0|7A4B1|7A4B4|7A4B5|7A501|7A502|7A503|A3A0F|C1070|C1071|C1072|C1073|C1074|C107y|C107z|G700.|G702.|G702z|G73..|G7310|G731z|G732.|G7320|G7321|G73y.|G73y0|G73y1|G73yz|G73z.|G73zz|G742z|G76A.|Gyu74|Gyu7A|M2710|M2712|R0542|R0543|R0550|X015a|X015b|X015c|X015H|X015h|X015R|X015S|X015T|X015U|X015V|X015W|X015X|X015Y|X015Z|X0160|X016n|X016o|X203L|X203Q|X203T|X203U|X50Be|X50Bf|X50Bg|X50Bk|X77Ut|Xa0lV|Xa7lT|Xa84U|XaBFI|XabhR|XabhS|XaBL7|XaBrm|XaDmh|XaDmi|XaE3G|XaFmK|XaFn7|XaLhe|XaLhK|XaMmK|XaMNe|XaZT1|XaZT3|XE0Ey|XE0Ez|XE0F0|XE0F1|XE0Fa|XE0FK|XE0FL|XE0FM|XE0FN|XE0FO|XE0FP|XE0FQ|XE0FR|XE0FX|XE0FY|XE0FZ|XE0VP|XE0VR|XE0XC|XE10I|XE12K|XM1Ib|XM1Ic|XM1Id|XM1Ie|XM1If|XM1Ig|XM1Ih|XM1Ii|XM1Ip|XM1Iq|XM1Ir|XM1Is|XM1It|XM1Iu|XM1Iv|XM1Iw|XM1KK|XM1Qu|XM1Qx|Y2572)$", READV3_CODE, ignore.case = FALSE))

PAD_table <- PAD_table %>% 
  select(READV2_DESC, READV2_CODE, READV3_CODE)

PAD_table <- PAD_table[!grepl("claudication distance", PAD_table$READV2_DESC, ignore.case = TRUE), ]


PAD_read2 <- PAD_table %>% 
  pull(READV2_CODE) %>% 
  paste(collapse = "|")
PAD_read2

PAD_read3 <- PAD_table %>% 
  pull(READV3_CODE) %>% 
  paste(collapse = "|")
PAD_read3

MI_read2 <- "^(14NB.|1M110|1M111|5593.|55A2.|7A100|7A101|7A102|7A103|7A11.|7A11.|7A110|7A111|7A112|7A113|7A113|7A11y|7A11z|7A12.|7A120|7A121|7A121|7A122|7A123|7A123|7A123|7A123|7A12y|7A12z|7A1B5|7A1B7|7A1BD|7A1C5|7A41.|7A41.|7A410|7A411|7A412|7A412|7A413|7A413|7A414|7A415|7A416|7A417|7A418|7A419|7A41A|7A41B|7A41C|7A41D|7A41E|7A41F|7A41y|7A41z|7A42.|7A42.|7A420|7A420|7A420|7A421|7A421|7A42y|7A42z|7A43.|7A43.|7A430|7A430|7A432|7A433|7A43y|7A43z|7A440|7A443|7A444|7A44y|7A44z|7A47.|7A47.|7A47.|7A47.|7A47.|7A47.|7A47.|7A470|7A471|7A472|7A473|7A474|7A475|7A476|7A477|7A478|7A479|7A47A|7A47B|7A47C|7A47D|7A47y|7A47z|7A48.|7A48.|7A48.|7A48.|7A48.|7A48.|7A48.|7A480|7A481|7A482|7A483|7A484|7A485|7A486|7A487|7A488|7A489|7A48A|7A48B|7A48C|7A48D|7A48E|7A48y|7A48z|7A49.|7A49.|7A49.|7A49.|7A49.|7A49.|7A490|7A491|7A492|7A493|7A494|7A495|7A496|7A497|7A498|7A499|7A49y|7A49z|7A4A.|7A4A.|7A4A.|7A4A.|7A4A.|7A4A0|7A4A1|7A4A2|7A4A2|7A4A2|7A4A3|7A4A3|7A4A4|7A4A5|7A4A6|7A4A7|7A4A8|7A4Ay|7A4Az|7A4B0|7A4B1|7A4B4|7A4B5|7A4B8|7A4B9|7A501|7A502|7A503|7A566|A3A0F|C107.|C107.|C107.|C1070|C1071|C1072|C1073|C1074|C107y|C107z|C108G|C108G|C108G|C109F|C109F|C109F|C10EG|C10EG|C10EG|C10FF|C10FF|G700.|G700.|G702.|G7020|G702z|G73..|G73..|G73..|G73..|G73..|G730.|G7300|G730z|G731.|G7310|G7311|G731z|G732.|G7320|G7321|G7322|G7323|G7324|G733.|G734.|G73y.|G73y0|G73y1|G73y2|G73y4|G73y4|G73y5|G73y5|G73y6|G73y7|G73y8|G73y8|G73yz|G73z.|G73z0|G73z0|G73z0|G73z0|G73z0|G73z1|G73zz|G740.|G742z|G76A.|G7830|G7832|Gyu74|Gyu7A|M271.|M2710|M2712|M2713|M2714|R0542|R0543|R0550|R0550)$"


PAD_read3 <- "^(XaBL7|XabhR|XabhS|5593.|55A2.|7A100|7A101|X0160|7A103|7A11.|7A11.|7A110|7A111|XE0Ey|XE0Ez|XM1Ib|7A11y|7A11z|7A12.|7A120|XE0F0|XM1Ic|7A122|XE0F1|7A123|XE0F1|XM1Id|7A12y|7A12z|XaLhK|XaLhK|XaLhK|XaMmK|XE0FK|X015h|7A410|7A411|XE0FL|XM1Ie|XE0FM|7A48E|7A414|7A415|7A416|7A417|7A418|7A419|7A41A|7A41B|7A41C|7A41D|7A41E|7A41F|7A41y|7A41z|XE0FN|X015H|XE0FO|XM1If|XE0FO|XE0FP|XM1Ig|7A42y|7A42z|XE0FQ|XM1Ih|XE0FR|XM1Ii|7A432|XaDmh|7A43y|7A43z|7A440|7A443|XaDmi|7A44y|7A44z|XE0FX|X015b|X015a|X015X|X015c|X015Z|X015Y|7A470|7A471|7A472|7A473|7A474|7A475|7A476|7A477|7A478|7A479|7A47A|7A47B|7A47C|7A47D|7A47y|7A47z|XE0FY|X015V|X015U|X015T|X015W|X015S|X015R|7A480|7A481|7A482|7A483|7A484|7A485|7A486|7A487|7A488|7A489|7A48A|7A48B|7A48C|7A48D|7A48E|7A48y|7A48z|XE0FZ|XM1Ir|XM1Iq|XM1Is|XM1Ip|XM1KK|7A490|7A491|7A492|7A493|7A494|7A495|7A496|7A497|7A498|7A499|7A49y|7A49z|XE0Fa|XM1Iw|XM1Iv|XM1Iu|XM1It|7A4A0|7A4A1|7A4A2|7A4A2|7A4A2|7A4A3|7A4A3|7A4A4|7A4A5|7A4A6|7A4A7|7A4A8|7A4Ay|7A4Az|7A4B0|7A4B1|7A4B4|7A4B5|XaBrm|XaMNe|7A501|7A502|7A503|XaLhe|A3A0F|XE10I|XM1Qx|XM1Qx|C1070|C1071|C1072|C1073|C1074|C107y|C107z|XaFmK|XaFmK|XaFmK|XaFn7|XaFn7|XaFn7|XaFmK|XaFmK|XaFmK|XaFn7|XaFn7|X203L|X203L|G702.|G7020|G702z|XE0VP|X203T|X203T|X203Q|X203Q|G730.|G7300|G730z|G7310|G7310|G7311|G731z|G732.|G7320|G7321|G7322|G7323|G7324|Xa84U|Xa0lV|G73y.|G73y0|G73y1|G73y2|G73y4|G73y4|G73y5|G73y5|G73y6|G73y7|G73y8|G73y8|G73yz|G73z.|XE0VR|XM1Qu|G73z0|XE0VR|XE0VR|G73z1|G73z.|XaBFI|G742z|G76A.|XaZT1|XaZT3|Gyu74|Gyu7A|X50Bf|M2710|M2712|X50Bf|X50Be|R0542|R0543|R0550|R0550)$"

dat_eid <- identify_prevalent_cases(dat_eid, dat_GPevent, PAD_read2, PAD_read3, "PeripheralArterialDisease")
```

```{r}
write.csv(dat_eid, "dat_GP_prevalent.csv") 
```

```{bash}
cd ~/rap_wearables

dx upload dat_GP_prevalent.csv --dest /dat_GP_prevalent.csv

```





